{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/美化状态栏/schema.ts","src://tavern_helper_template/src/美化状态栏-动态世界书管理/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","// ============================================================================\n// 踏月寻仙 - MVU 变量结构定义 (Zod Schema for MVU Variables)\n// ============================================================================\n// 修炼境界等级与突破阈值映射\nconst REALM_THRESHOLDS = [100, 100, 100, 100, 200, 200, 200, 200, 400, 400, 400, 400, 800, 800, 800, 800, 1600, 1600, 1600, 1600, 3200, 3200, 3200, 3200, 6400, 6400, 6400, 6400, 12800, 12800, 12800, 12800, 25600, 25600, 25600, 25600];\n// 修炼境界等级与寿元上限映射\nconst REALM_LIFESPANS = [100, 100, 100, 100, 200, 200, 200, 200, 500, 500, 500, 500, 1000, 1000, 1000, 1000, 2000, 2000, 2000, 2000, 5000, 5000, 5000, 5000, 10000, 10000, 10000, 10000, 50000, 50000, 50000, 50000, 100000, 100000, 100000, 100000];\n// 修炼境界等级与境界描述映射\nconst REALM_NAMES = ['练气', '筑基', '金丹', '元婴', '化神', '炼虚', '合体', '大乘', '渡劫'];\nconst REALM_STAGES = ['初期', '中期', '后期', '大圆满'];\n// 物品 Schema\nconst ItemSchema = z.object({\n    名称: z.string(),\n    描述: z.string(),\n    品阶: z.string(),\n    数量: z.coerce.number(),\n});\n// 修士基础字段（不含 transform）\nconst CultivatorBaseFields = {\n    等级: z.coerce.number().transform(v => _.clamp(v, 1, 36)),\n    修为: z.coerce.number().transform(v => Math.max(0, v)),\n    灵根: z.string().prefault('五行杂灵根'),\n    体质: z.string().prefault('凡体'),\n    功法: z.string().prefault('无'),\n    本命兵器: z.string().prefault('无'),\n    神通列表: z.record(z.string().describe('神通名'), z.string().describe('神通描述')).prefault({}),\n    灵石: z.coerce.number().transform(v => Math.max(0, v)),\n    已活岁月: z.coerce.number().transform(v => Math.max(0, v)),\n    尝试突破: z.boolean().prefault(false),\n};\n// 计算衍生数据的辅助函数\nfunction addDerivedFields(data) {\n    const level = data.等级;\n    const 突破阈值 = REALM_THRESHOLDS[level - 1] || 100;\n    const 寿元上限 = REALM_LIFESPANS[level - 1] || 100;\n    const majorIdx = Math.floor((level - 1) / 4);\n    const minorIdx = (level - 1) % 4;\n    const 境界描述 = `${REALM_NAMES[majorIdx] || '练气'}${REALM_STAGES[minorIdx]}`;\n    const 寿元状态 = `${data.已活岁月}/${寿元上限}`;\n    const 状态 = data.尝试突破 ? '突破中' : data.修为 >= 突破阈值 ? '瓶颈期' : '修炼中';\n    const 进度 = `${((data.修为 / 突破阈值) * 100).toFixed(1)}%`;\n    return {\n        ...data,\n        突破阈值,\n        寿元上限,\n        境界描述,\n        寿元状态,\n        状态,\n        进度,\n    };\n}\n// 完整的 MVU 变量结构\nexport const Schema = z.object({\n    世界时钟: z\n        .object({\n        纪元: z.string().prefault('末法时代'),\n        年份: z.coerce.number().prefault(1),\n    })\n        .prefault({}),\n    世界地图: z\n        .record(z.string().describe('区域名'), z.object({\n        layer: z.enum(['天层', '地层', '下层']).prefault('地层'),\n        danger: z.coerce.number().transform(v => _.clamp(v, 0, 100)),\n        desc: z.string().prefault(''),\n        connections: z.array(z.string()).prefault([]),\n    }))\n        .prefault({}),\n    世界图志: z\n        .record(z.string().describe('事件名'), z.object({\n        状态: z.string().prefault(''),\n        事件: z.string().prefault(''),\n    }))\n        .prefault({}),\n    本尊: z\n        .object({\n        ...CultivatorBaseFields,\n        行踪: z\n            .object({\n            当前区域: z.string().prefault('未知之地'),\n            所属层级: z.string().optional(),\n            环境描述: z.string().optional(),\n            危险度: z.coerce.number().optional(),\n            可用通道: z.array(z.string()).optional(),\n            导航信息: z.string().optional(),\n        })\n            .prefault({}),\n        身份: z\n            .object({\n            姓名: z.string().prefault('无名氏'),\n            宗门: z.string().prefault('散修'),\n            出身: z.string().prefault('凡人'),\n        })\n            .prefault({}),\n        背包: z\n            .record(z.string().describe('物品名'), ItemSchema)\n            .transform(data => _.pickBy(data, ({ 数量 }) => 数量 > 0))\n            .prefault({}),\n        法宝: z\n            .record(z.string().describe('法宝名'), ItemSchema)\n            .transform(data => _.pickBy(data, ({ 数量 }) => 数量 > 0))\n            .prefault({}),\n        杂物袋: z\n            .record(z.string().describe('杂物名'), ItemSchema)\n            .transform(data => _.pickBy(data, ({ 数量 }) => 数量 > 0))\n            .prefault({}),\n    })\n        .transform(addDerivedFields)\n        .prefault({\n        等级: 1,\n        修为: 0,\n        灵根: '五行杂灵根',\n        体质: '凡体',\n        功法: '无',\n        本命兵器: '无',\n        灵石: 0,\n        已活岁月: 16,\n        尝试突破: false,\n    }),\n    红颜: z\n        .record(z.string().describe('红颜名'), z\n        .object({\n        ...CultivatorBaseFields,\n        好感度: z.coerce.number().transform(v => _.clamp(v, -100, 100)),\n        关系: z.string().prefault('陌生人'),\n        重要性: z.string().prefault('路人'),\n    })\n        .transform(addDerivedFields))\n        .prefault({}),\n    NPC图鉴: z\n        .record(z.string().describe('NPC名'), z\n        .object({\n        ...CultivatorBaseFields,\n        所在宗门: z.string().prefault('散修'),\n    })\n        .transform(addDerivedFields))\n        .prefault({}),\n});\n// 配置常量\nexport const CONFIG = {\n    REALMS: {\n        MAJOR: REALM_NAMES,\n        MINOR: REALM_STAGES,\n    },\n    ELEMENTS: {\n        火: { effect: '灼烧', visual: '烈焰', nature: '爆裂', color: '#ff4444' },\n        水: { effect: '缠绕', visual: '激流', nature: '柔韧', color: '#4488ff' },\n        冰: { effect: '冻结', visual: '寒霜', nature: '极寒', color: '#88ddff' },\n        雷: { effect: '麻痹', visual: '紫电', nature: '狂暴', color: '#aa44ff' },\n        风: { effect: '切割', visual: '罡风', nature: '无形', color: '#88ff88' },\n        土: { effect: '镇压', visual: '岩铠', nature: '厚重', color: '#aa8844' },\n        木: { effect: '寄生', visual: '藤蔓', nature: '生生不息', color: '#44aa44' },\n        金: { effect: '穿透', visual: '锐金', nature: '锋利', color: '#ffdd44' },\n        暗: { effect: '腐蚀', visual: '黑雾', nature: '诡谲', color: '#442244' },\n        光: { effect: '净化', visual: '圣辉', nature: '神圣', color: '#ffffaa' },\n        混沌: { effect: '湮灭', visual: '灰光', nature: '虚无', color: '#888888' },\n    },\n};\n// 获取灵根元素颜色\nexport function getRootColor(root) {\n    for (const [elem, data] of Object.entries(CONFIG.ELEMENTS)) {\n        if (root.includes(elem)) {\n            return data.color;\n        }\n    }\n    return '#aaaaaa'; // 默认灰色\n}\n// 获取境界等级颜色\nexport function getRealmColor(level) {\n    const majorIdx = Math.floor((level - 1) / 4);\n    const colors = [\n        '#888888', // 练气 - 灰色\n        '#44aa44', // 筑基 - 绿色\n        '#4488ff', // 金丹 - 蓝色\n        '#aa44ff', // 元婴 - 紫色\n        '#ff4444', // 化神 - 红色\n        '#ffaa00', // 炼虚 - 橙色\n        '#ffdd44', // 合体 - 金色\n        '#ffffff', // 大乘 - 白色\n        '#ff88ff', // 渡劫 - 粉色\n    ];\n    return colors[majorIdx] || '#888888';\n}\n// 获取危险度颜色\nexport function getDangerColor(danger) {\n    if (danger >= 90)\n        return '#ff0000';\n    if (danger >= 70)\n        return '#ff4400';\n    if (danger >= 50)\n        return '#ff8800';\n    if (danger >= 30)\n        return '#ffcc00';\n    return '#44aa44';\n}\n","// ============================================================================\r\n// 动态世界书管理脚本 - 根据上下文智能启用/禁用世界书条目\r\n// \r\n// 功能：根据当前区域、境界、人物等上下文自动启用/禁用世界书条目，节省 token\r\n// ============================================================================\r\n\r\nimport { Schema } from '../美化状态栏/schema';\r\n\r\n// ============================================================================\r\n// 配置项\r\n// ============================================================================\r\n\r\nconst CONFIG = {\r\n    // 要管理的世界书名称（修改为你的世界书名）\r\n    WORLDBOOK_NAME: 'current',  // 'current' 表示当前角色卡的主世界书\r\n\r\n    // 是否启用调试日志\r\n    DEBUG: true,\r\n\r\n    // 上下文窗口（检查最近几条消息）\r\n    CONTEXT_WINDOW: 5,\r\n};\r\n\r\n// ============================================================================\r\n// 规则定义 - 根据你的角色卡自定义这些规则\r\n// ============================================================================\r\n\r\ninterface WorldbookRule {\r\n    /** 条目名称匹配模式 */\r\n    entryPattern: string | RegExp;\r\n    /** 启用条件 */\r\n    shouldEnable: (context: Context) => boolean;\r\n    /** 优先级（数字越大越优先，默认 0） */\r\n    priority?: number;\r\n}\r\n\r\ninterface Context {\r\n    /** 当前所在区域 */\r\n    currentRegion: string;\r\n    /** 最近消息内容 */\r\n    recentMessages: string[];\r\n    /** MVU 变量数据 */\r\n    mvuData: ReturnType<typeof Schema.parse> | null;\r\n    /** 当前聊天 ID */\r\n    chatId: string;\r\n}\r\n\r\nconst RULES: WorldbookRule[] = [\r\n    // ============================================================================\r\n    // 系统设定 - 始终启用（蓝灯）\r\n    // ============================================================================\r\n    {\r\n        entryPattern: /^\\[系统\\]/,\r\n        shouldEnable: () => true,\r\n        priority: 100,\r\n    },\r\n    {\r\n        entryPattern: /^\\[mvu_update\\]/,\r\n        shouldEnable: () => true,\r\n        priority: 100,\r\n    },\r\n    {\r\n        entryPattern: /^变量列表$/,\r\n        shouldEnable: () => true,\r\n        priority: 100,\r\n    },\r\n    {\r\n        entryPattern: /^变量更新规则$/,\r\n        shouldEnable: () => true,\r\n        priority: 100,\r\n    },\r\n    {\r\n        entryPattern: /^变量输出格式$/,\r\n        shouldEnable: () => true,\r\n        priority: 100,\r\n    },\r\n\r\n    // ============================================================================\r\n    // 地图相关 - 只在对应区域启用\r\n    // ============================================================================\r\n    {\r\n        entryPattern: /^\\[地图\\]\\s*神州/,\r\n        shouldEnable: ctx => ctx.currentRegion === '神州',\r\n        priority: 10,\r\n    },\r\n    {\r\n        entryPattern: /^\\[地图\\]\\s*魔域/,\r\n        shouldEnable: ctx => ctx.currentRegion === '魔域',\r\n        priority: 10,\r\n    },\r\n    {\r\n        entryPattern: /^\\[地图\\]\\s*东海/,\r\n        shouldEnable: ctx => ctx.currentRegion === '东海',\r\n        priority: 10,\r\n    },\r\n\r\n    // ============================================================================\r\n    // 人物相关 - 只在提到时或在红颜列表中时启用\r\n    // ============================================================================\r\n    {\r\n        entryPattern: /^\\[角色\\]\\s*掌门/,\r\n        shouldEnable: ctx => {\r\n            // 只有在万法宗且最近消息提到掌门时启用\r\n            return (\r\n                ctx.mvuData?.本尊?.行踪?.当前区域 === '万法宗' &&\r\n                ctx.recentMessages.some(msg => msg.includes('掌门'))\r\n            );\r\n        },\r\n        priority: 5,\r\n    },\r\n    {\r\n        entryPattern: /^\\[角色\\]\\s*孟十七/,\r\n        shouldEnable: ctx => {\r\n            // 如果孟十七在红颜列表中，或最近消息提到她\r\n            return (\r\n                ctx.mvuData?.红颜?.['孟十七'] !== undefined ||\r\n                ctx.recentMessages.some(msg => msg.includes('孟十七'))\r\n            );\r\n        },\r\n        priority: 8,\r\n    },\r\n\r\n    // ============================================================================\r\n    // 境界相关 - 根据当前境界启用\r\n    // ============================================================================\r\n    {\r\n        entryPattern: /^\\[境界\\]\\s*练气/,\r\n        shouldEnable: ctx => {\r\n            const level = ctx.mvuData?.本尊?.等级 ?? 1;\r\n            return level >= 1 && level <= 4;\r\n        },\r\n        priority: 7,\r\n    },\r\n    {\r\n        entryPattern: /^\\[境界\\]\\s*筑基/,\r\n        shouldEnable: ctx => {\r\n            const level = ctx.mvuData?.本尊?.等级 ?? 1;\r\n            return level >= 5 && level <= 8;\r\n        },\r\n        priority: 7,\r\n    },\r\n    {\r\n        entryPattern: /^\\[境界\\]\\s*金丹/,\r\n        shouldEnable: ctx => {\r\n            const level = ctx.mvuData?.本尊?.等级 ?? 1;\r\n            return level >= 9 && level <= 12;\r\n        },\r\n        priority: 7,\r\n    },\r\n\r\n    // ============================================================================\r\n    // 事件相关 - 只在最近消息提到时启用\r\n    // ============================================================================\r\n    {\r\n        entryPattern: /^\\[事件\\]/,\r\n        shouldEnable: ctx => {\r\n            // 提取事件名（假设格式为 [事件] 事件名）\r\n            return ctx.recentMessages.join(' ').length > 0;\r\n        },\r\n        priority: 3,\r\n    },\r\n];\r\n\r\n// ============================================================================\r\n// 核心逻辑\r\n// ============================================================================\r\n\r\nlet isProcessing = false;\r\n\r\nasync function getContext(): Promise<Context> {\r\n    // 等待 MVU 初始化\r\n    await waitGlobalInitialized('Mvu');\r\n\r\n    // 获取最近的消息\r\n    const messages = getChatMessages(-CONFIG.CONTEXT_WINDOW);\r\n    const recentMessages = messages.map(m => m.message || '');\r\n\r\n    // 获取 MVU 数据\r\n    let mvuData: ReturnType<typeof Schema.parse> | null = null;\r\n    try {\r\n        const variables = getVariables({ type: 'message', message_id: -1 });\r\n        const statData = _.get(variables, 'stat_data', null);\r\n        if (statData) {\r\n            mvuData = Schema.parse(statData);\r\n        }\r\n    } catch (e) {\r\n        if (CONFIG.DEBUG) {\r\n            console.warn('[动态世界书] 无法获取 MVU 数据', e);\r\n        }\r\n    }\r\n\r\n    const currentRegion = mvuData?.本尊?.行踪?.当前区域 ?? '未知';\r\n    const chatId = SillyTavern.getCurrentChatId();\r\n\r\n    return {\r\n        currentRegion,\r\n        recentMessages,\r\n        mvuData,\r\n        chatId,\r\n    };\r\n}\r\n\r\nasync function updateWorldbookEntries() {\r\n    if (isProcessing) return;\r\n    isProcessing = true;\r\n\r\n    try {\r\n        const context = await getContext();\r\n\r\n        // 获取世界书名称\r\n        let worldbookName = CONFIG.WORLDBOOK_NAME;\r\n        if (worldbookName === 'current') {\r\n            const charWorldbooks = getCharWorldbookNames('current');\r\n            worldbookName = charWorldbooks.primary || '';\r\n            if (!worldbookName) {\r\n                if (CONFIG.DEBUG) {\r\n                    console.warn('[动态世界书] 当前角色卡没有绑定主世界书');\r\n                }\r\n                return;\r\n            }\r\n        }\r\n\r\n        let enabledCount = 0;\r\n        let disabledCount = 0;\r\n\r\n        // 按优先级排序规则\r\n        const sortedRules = [...RULES].sort((a, b) => (b.priority ?? 0) - (a.priority ?? 0));\r\n\r\n        // 使用 updateWorldbookWith 更新世界书\r\n        await updateWorldbookWith(worldbookName, worldbook => {\r\n            for (const entry of worldbook) {\r\n                if (!entry.enabled) continue;  // 跳过已禁用的条目\r\n\r\n                const entryName = entry.name || '';\r\n                let shouldBeConstant = false;\r\n\r\n                // 查找匹配的规则\r\n                for (const rule of sortedRules) {\r\n                    const matches =\r\n                        typeof rule.entryPattern === 'string'\r\n                            ? entryName.includes(rule.entryPattern)\r\n                            : rule.entryPattern.test(entryName);\r\n\r\n                    if (matches) {\r\n                        shouldBeConstant = rule.shouldEnable(context);\r\n                        break; // 找到第一个匹配的规则就停止\r\n                    }\r\n                }\r\n\r\n                // 更新条目的 strategy.type\r\n                const wasConstant = entry.strategy.type === 'constant';\r\n\r\n                if (shouldBeConstant && !wasConstant) {\r\n                    entry.strategy.type = 'constant';\r\n                    enabledCount++;\r\n                    if (CONFIG.DEBUG) {\r\n                        console.log(`[动态世界书] ✅ 启用（蓝灯）: ${entryName}`);\r\n                    }\r\n                } else if (!shouldBeConstant && wasConstant) {\r\n                    entry.strategy.type = 'selective';\r\n                    disabledCount++;\r\n                    if (CONFIG.DEBUG) {\r\n                        console.log(`[动态世界书] ❌ 改为绿灯: ${entryName}`);\r\n                    }\r\n                }\r\n            }\r\n\r\n            return worldbook;\r\n        });\r\n\r\n        if (CONFIG.DEBUG && (enabledCount > 0 || disabledCount > 0)) {\r\n            console.info(\r\n                `[动态世界书] 更新完成: 启用蓝灯 ${enabledCount} 个, 改为绿灯 ${disabledCount} 个`,\r\n            );\r\n        }\r\n    } catch (e) {\r\n        console.error('[动态世界书] 更新失败', e);\r\n    } finally {\r\n        isProcessing = false;\r\n    }\r\n}\r\n\r\n// ============================================================================\r\n// 初始化\r\n// ============================================================================\r\n\r\n$(() => {\r\n    errorCatched(async () => {\r\n        console.info('[动态世界书] 脚本已加载');\r\n\r\n        // 等待 MVU 初始化\r\n        await waitGlobalInitialized('Mvu');\r\n\r\n        // 初始检查\r\n        await updateWorldbookEntries();\r\n\r\n        // 监听消息接收事件\r\n        eventOn(tavern_events.MESSAGE_RECEIVED, async () => {\r\n            await updateWorldbookEntries();\r\n        });\r\n\r\n        // 监听消息发送事件\r\n        eventOn(tavern_events.MESSAGE_SENT, async () => {\r\n            await updateWorldbookEntries();\r\n        });\r\n\r\n        // 监听 MVU 变量更新\r\n        eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, async () => {\r\n            await updateWorldbookEntries();\r\n        });\r\n\r\n        console.info('[动态世界书] 监听器已设置，将自动管理世界书条目');\r\n    })();\r\n});"],"names":["z","REALM_THRESHOLDS","REALM_LIFESPANS","REALM_NAMES","REALM_STAGES","ItemSchema","object","string","coerce","number","CultivatorBaseFields","transform","v","_","clamp","Math","max","prefault","record","describe","boolean","addDerivedFields","data","level","majorIdx","floor","toFixed","Schema","layer","enum","danger","desc","connections","array","optional","pickBy","RULES","entryPattern","shouldEnable","priority","ctx","currentRegion","mvuData","recentMessages","some","msg","includes","undefined","join","length","isProcessing","async","updateWorldbookEntries","context","waitGlobalInitialized","getChatMessages","map","m","message","variables","getVariables","type","message_id","statData","get","parse","e","console","warn","chatId","SillyTavern","getCurrentChatId","getContext","worldbookName","getCharWorldbookNames","primary","enabledCount","disabledCount","sortedRules","sort","a","b","updateWorldbookWith","worldbook","entry","enabled","entryName","name","shouldBeConstant","rule","test","wasConstant","strategy","log","info","error","$","errorCatched","eventOn","tavern_events","MESSAGE_RECEIVED","MESSAGE_SENT","Mvu","events","VARIABLE_UPDATE_ENDED"],"ignoreList":[],"sourceRoot":""}