{"version":3,"file":"index.js","mappings":"AAAA,MAAM,EAA+BA,ECa/BC,EAAc,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAC/DC,EAAe,CAAC,KAAM,KAAM,KAAM,OAElCC,EAAmB,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAAO,MAAO,MAAO,MAAO,MAAO,MAAO,MAAO,OAE7NC,EAAkB,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAM,IAAO,IAAO,IAAO,IAAO,IAAO,IAAO,IAAO,IAAO,IAAQ,IAAQ,IAAQ,KAEvOC,EAAa,EAAAL,EAAEM,OAAO,CACxB,GAAI,EAAAN,EAAEO,SAASC,SAAS,IACxB,GAAI,EAAAR,EAAEO,SAASC,SAAS,IACxB,GAAI,EAAAR,EAAEO,SAASC,SAAS,IACxB,GAAI,EAAAR,EAAES,OAAOC,SAASC,UAAUC,GAAKC,KAAKC,IAAI,EAAGF,IAAIJ,SAAS,KAG5DO,EAAgB,EAAAf,EAAEM,OAAO,CAC3B,EAAG,EAAAN,EAAEO,SAASS,SAAS,OACvB,EAAG,EAAAhB,EAAEO,SAASS,SAAS,QACvB,EAAG,EAAAhB,EAAEO,SAASS,SAAS,QACvB,EAAG,EAAAhB,EAAEiB,KAAK,CAAC,IAAK,IAAK,MACrB,EAAG,EAAAjB,EAAEiB,KAAK,CAAC,KAAM,IAAK,IAAK,IAAK,QAG9BC,EAAkB,EAAAlB,EAAEM,OAAO,CAC7B,EAAG,EAAAN,EAAEiB,KAAK,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,MACzC,EAAG,EAAAjB,EAAEO,SAASS,SAAS,MACvB,EAAG,EAAAhB,EAAEO,SAASS,SAAS,QAGrBG,EAAiB,EAAAnB,EAAEM,OAAO,CAC5B,EAAG,EAAAN,EAAEiB,KAAK,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OACrD,EAAG,EAAAjB,EAAEO,SAASS,SAAS,QACxBL,UAAUS,IAAQ,IACdA,EACH,EAAc,OAAXA,EAAK,EAAa,KAAkB,OAAXA,EAAK,EAAa,IAAiB,OAAXA,EAAK,EAAa,IAAM,QAG1EC,EAAiB,EAAArB,EAAEM,OAAO,CAC5B,EAAG,EAAAN,EAAEiB,KAAK,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,OACrD,EAAG,EAAAjB,EAAEiB,KAAK,CAAC,KAAM,KAAM,KAAM,KAAM,KAAM,OACzC,EAAG,EAAAjB,EAAES,OAAOC,SAASC,UAAUC,GAAKU,EAAEC,MAAMX,EAAG,EAAG,MAClD,EAAG,EAAAZ,EAAEO,SAASS,SAAS,MACvB,EAAG,EAAAhB,EAAEwB,MAAM,EAAAxB,EAAEO,UAAUC,SAAS,MAG9BiB,EAAmB,EAAAzB,EAAEM,OAAO,CAC9B,EAAG,EAAAN,EAAEiB,KAAK,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,MACzC,EAAG,EAAAjB,EAAEO,SAASS,SAAS,MACvB,EAAG,EAAAhB,EAAEiB,KAAK,CAAC,IAAK,IAAK,IAAK,IAAK,QAChCN,UAAUS,IAEF,IACAA,EACH,EAHS,CAAE,EAAG,OAAQ,EAAG,OAAQ,EAAG,KAAM,EAAG,KAAM,EAAG,KAAM,EAAG,KAAM,EAAG,MAGhEA,EAAK,IAAM,KACnB,EAAc,MAAXA,EAAK,EAAY,OAAoB,MAAXA,EAAK,EAAY,OAAoB,MAAXA,EAAK,EAAY,OAAS,QAInFM,EAAiB,EAAA1B,EAAEM,OAAO,CAC5B,EAAG,EAAAN,EAAEiB,KAAK,CAAC,IAAK,IAAK,IAAK,IAAK,MAC/B,EAAG,EAAAjB,EAAEO,SAASS,SAAS,MACvB,EAAG,EAAAhB,EAAEiB,KAAK,CAAC,IAAK,IAAK,IAAK,IAAK,QAChCN,UAAUS,IAAQ,IACdA,EACH,EAAc,MAAXA,EAAK,EAAY,KAAkB,MAAXA,EAAK,EAAY,KAAkB,MAAXA,EAAK,EAAY,IAAiB,MAAXA,EAAK,EAAY,IAAM,OAGxFO,EAAS,EAAA3B,EAAEM,OAAO,CAC3B,KAAM,EAAAN,EAAEM,OAAO,CACX,GAAI,EAAAN,EAAEO,SAASC,SAAS,QACxB,GAAI,EAAAR,EAAES,OAAOC,SAASF,SAAS,GAC/B,GAAI,EAAAR,EAAES,OAAOC,SAASC,UAAUC,GAAKU,EAAEC,MAAMX,EAAG,EAAG,KAAKJ,SAAS,GACjE,GAAI,EAAAR,EAAES,OAAOC,SAASC,UAAUC,GAAKU,EAAEC,MAAMX,EAAG,EAAG,KAAKJ,SAAS,GACjE,GAAI,EAAAR,EAAEO,SAASC,SAAS,QACzBA,SAAS,CACR,GAAI,OACJ,GAAI,EACJ,GAAI,EACJ,GAAI,EACJ,GAAI,OAER,KAAM,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQ,EAAAhB,EAAEM,OAAO,CAChDuB,MAAO,EAAA7B,EAAEiB,KAAK,CAAC,KAAM,KAAM,OAAOT,SAAS,MAC3CsB,OAAQ,EAAA9B,EAAES,OAAOC,SAASC,UAAUC,GAAKU,EAAEC,MAAMX,EAAG,EAAG,MACvDmB,KAAM,EAAA/B,EAAEO,SAASC,SAAS,IAC1BwB,YAAa,EAAAhC,EAAEwB,MAAM,EAAAxB,EAAEO,UAAUC,SAAS,OAC1CA,SAAS,CAAC,GACd,KAAM,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQ,EAAAhB,EAAEM,OAAO,CAChD,GAAI,EAAAN,EAAEO,SAASC,SAAS,IACxB,GAAI,EAAAR,EAAEO,SAASC,SAAS,OACxBA,SAAS,CAAC,GACd,MAAO,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQD,GAAeP,SAAS,CAEhE,GAAI,CAAE,EAAG,QAAS,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,MACnD,IAAK,CAAE,EAAG,QAAS,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,MACpD,IAAK,CAAE,EAAG,OAAQ,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,KACnD,IAAK,CAAE,EAAG,MAAO,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,KAClD,GAAI,CAAE,EAAG,MAAO,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,KACjD,IAAK,CAAE,EAAG,QAAS,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,KACpD,IAAK,CAAE,EAAG,QAAS,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,KACpD,IAAK,CAAE,EAAG,QAAS,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,KACpD,IAAK,CAAE,EAAG,OAAQ,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,KAEnD,IAAK,CAAE,EAAG,MAAO,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,MAClD,IAAK,CAAE,EAAG,MAAO,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,KAElD,GAAI,CAAE,EAAG,OAAQ,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,MAClD,KAAM,CAAE,EAAG,OAAQ,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,KACpD,KAAM,CAAE,EAAG,OAAQ,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,KACpD,IAAK,CAAE,EAAG,OAAQ,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,KACnD,KAAM,CAAE,EAAG,OAAQ,EAAG,OAAQ,EAAG,OAAQ,EAAG,IAAK,EAAG,OAExD,IAAK,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQE,GAAiBV,SAAS,CAEhE,IAAK,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,MAC3B,KAAM,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,MAC5B,KAAM,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,MAE5B,MAAO,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,QAC7B,MAAO,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,QAC5B,KAAM,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,QAC3B,MAAO,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,QAC5B,MAAO,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,QAE7B,KAAM,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,QAC3B,KAAM,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,QAC3B,KAAM,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,QAC3B,IAAK,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,cAC3B,MAAO,CAAE,EAAG,IAAK,EAAG,MAAO,EAAG,cAC9B,KAAM,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,QAE5B,MAAO,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,MAC5B,IAAK,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,MAC3B,KAAM,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,MAC5B,KAAM,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,MAC5B,IAAK,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,QAE/B,IAAK,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQG,GAAgBX,SAAS,CAE/D,IAAK,CAAE,EAAG,KAAM,EAAG,KACnB,IAAK,CAAE,EAAG,KAAM,EAAG,MAEnB,IAAK,CAAE,EAAG,KAAM,EAAG,KACnB,IAAK,CAAE,EAAG,KAAM,EAAG,MAEnB,IAAK,CAAE,EAAG,KAAM,EAAG,KACnB,IAAK,CAAE,EAAG,KAAM,EAAG,KACnB,IAAK,CAAE,EAAG,KAAM,EAAG,KACnB,IAAK,CAAE,EAAG,KAAM,EAAG,OAEvB,IAAK,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQK,GAAgBb,SAAS,CAE/D,GAAI,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,OAAQ,EAAG,CAAC,OAAQ,OACtD,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,OAAQ,EAAG,CAAC,SAE/C,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,MAAO,EAAG,CAAC,KAAM,OACpD,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,KAAM,EAAG,CAAC,KAAM,OACnD,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,EAAG,EAAG,KAAM,EAAG,CAAC,KAAM,OAClD,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,KAAM,EAAG,CAAC,SAC7C,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,KAAM,EAAG,CAAC,OAE7C,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,MAAO,EAAG,CAAC,KAAM,OACpD,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,OAAQ,EAAG,CAAC,SAC/C,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,KAAM,EAAG,CAAC,OAE7C,KAAM,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,OAAQ,EAAG,CAAC,QAChD,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,KAAM,EAAG,CAAC,SAE7C,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,KAAM,EAAG,CAAC,KAAM,OAEnD,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,MAAO,EAAG,CAAC,OAC9C,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,KAAM,EAAG,CAAC,SAE7C,IAAK,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,KAAM,EAAG,CAAC,QAC7C,GAAI,CAAE,EAAG,KAAM,EAAG,KAAM,EAAG,GAAI,EAAG,MAAO,EAAG,CAAC,UAEjD,IAAK,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQS,GAAkBjB,SAAS,CAEjE,IAAK,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,KAC1B,IAAK,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,KAC1B,IAAK,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,KAC1B,IAAK,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,KAC1B,IAAK,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,KAE1B,IAAK,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,KAC3B,IAAK,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,KAC3B,KAAM,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,KAE5B,GAAI,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,KACzB,GAAI,CAAE,EAAG,IAAK,EAAG,IAAK,EAAG,KACzB,IAAK,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,KAC3B,IAAK,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,KAC3B,IAAK,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,KAC3B,IAAK,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,KAC3B,IAAK,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,OAE/B,IAAK,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQU,GAAgBlB,SAAS,CAC/D,GAAI,CAAE,EAAG,IAAK,EAAG,KAAM,EAAG,KAE1B,IAAK,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAC7B,IAAK,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAC7B,IAAK,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAC7B,IAAK,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAC7B,IAAK,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAE7B,IAAK,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAC7B,IAAK,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAC7B,GAAI,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAC5B,IAAK,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAC7B,IAAK,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAE7B,IAAK,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAC7B,GAAI,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAC5B,GAAI,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,KAE5B,IAAK,CAAE,EAAG,IAAK,EAAG,eAAgB,EAAG,KACrC,IAAK,CAAE,EAAG,IAAK,EAAG,OAAQ,EAAG,OAEjC,GAAI,EAAAR,EACCM,OAAO,CACR,GAAI,EAAAN,EAAES,OAAOC,SAASC,UAAUC,GAAKU,EAAEC,MAAMX,EAAG,EAAG,KAAKJ,SAAS,GACjE,GAAI,EAAAR,EAAES,OAAOC,SAASC,UAAUC,GAAKC,KAAKC,IAAI,EAAGF,IAAIJ,SAAS,GAC9D,GAAI,EAAAR,EAAEO,SAASC,SAAS,SACxB,GAAI,EAAAR,EAAEO,SAASC,SAAS,MACxB,GAAI,EAAAR,EAAEO,SAASC,SAAS,KACxB,KAAM,EAAAR,EAAEO,SAASC,SAAS,KAC1B,KAAM,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQ,EAAAhB,EAAEO,SAASS,SAAS,SAASR,SAAS,CAAC,GAClF,GAAI,EAAAR,EAAES,OAAOC,SAASC,UAAUC,GAAKC,KAAKC,IAAI,EAAGF,IAAIJ,SAAS,GAC9D,KAAM,EAAAR,EAAES,OAAOC,SAASC,UAAUC,GAAKC,KAAKC,IAAI,EAAGF,IAAIJ,SAAS,GAChE,KAAM,EAAAR,EAAEiC,UAAUzB,UAAS,GAC3B,GAAI,EAAAR,EAAEM,OAAO,CACT,KAAM,EAAAN,EAAEO,SAASC,SAAS,QAC1B,KAAM,EAAAR,EAAEO,SAASC,SAAS,MAC1B,KAAM,EAAAR,EAAEO,SAASC,SAAS,IAC1B,IAAK,EAAAR,EAAES,OAAOC,SAASF,SAAS,IAChC,KAAM,EAAAR,EAAEwB,MAAM,EAAAxB,EAAEO,UAAUC,SAAS,IACnC,KAAM,EAAAR,EAAEO,SAASC,SAAS,MAC3BA,SAAS,CACR,KAAM,OACN,KAAM,KACN,KAAM,GACN,IAAK,GACL,KAAM,GACN,KAAM,KAEV,GAAI,EAAAR,EAAEM,OAAO,CACT,GAAI,EAAAN,EAAEO,SAASC,SAAS,OACxB,GAAI,EAAAR,EAAEO,SAASC,SAAS,MACxB,GAAI,EAAAR,EAAEO,SAASC,SAAS,QACzBA,SAAS,CACR,GAAI,MACJ,GAAI,KACJ,GAAI,OAER,GAAI,EAAAR,EACC4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQX,GACnCG,SAAS,CAAC,GACVG,UAAUS,GAAQE,EAAEY,OAAOd,EAAM,EAAG,QAAS,EAAK,IACvD,GAAI,EAAApB,EACC4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQX,GACnCG,SAAS,CAAC,GACVG,UAAUS,GAAQE,EAAEY,OAAOd,EAAM,EAAG,QAAS,EAAK,IACvD,IAAK,EAAApB,EACA4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQX,GACnCG,SAAS,CAAC,GACVG,UAAUS,GAAQE,EAAEY,OAAOd,EAAM,EAAG,QAAS,EAAK,MAEtDZ,SAAS,CACV,GAAI,EACJ,GAAI,EACJ,GAAI,QACJ,GAAI,KACJ,GAAI,IACJ,KAAM,IACN,KAAM,CAAC,EACP,GAAI,EACJ,KAAM,EACN,MAAM,EACN,GAAI,CACA,KAAM,OACN,KAAM,KACN,KAAM,GACN,IAAK,GACL,KAAM,GACN,KAAM,IAEV,GAAI,CACA,GAAI,MACJ,GAAI,KACJ,GAAI,MAER,GAAI,CAAC,EACL,GAAI,CAAC,EACL,IAAK,CAAC,IAELG,UAAUS,IACX,MAAMe,EAAQf,EAAK,GACb,EAAOjB,EAAiBgC,EAAQ,IAAM,IACtC,EAAO/B,EAAgB+B,EAAQ,IAAM,IACrCC,EAAWvB,KAAKwB,OAAOF,EAAQ,GAAK,GAEpC,EAAO,GAAGlC,EAAYmC,IAAa,OAAOlC,GAD9BiC,EAAQ,GAAK,IAC2C,OACpE,EAAO,GAAGf,EAAK,QAAQ,IACvB,EAAKA,EAAK,KAAO,MAAQA,EAAK,IAAM,EAAO,MAAQ,MACnD,EAAK,IAAKA,EAAK,GAAK,EAAQ,KAAKkB,QAAQ,MAC/C,MAAO,IACAlB,EACH,OACA,OACA,OACA,OACA,KACA,QAGR,MAAO,EAAApB,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQ,EAAAhB,EAAEM,OAAO,CACjD,EAAG,EAAAN,EAAES,OAAOC,SAASC,UAAUC,GAAKU,EAAEC,MAAMX,EAAG,EAAG,KAClD,EAAG,EAAAZ,EAAEO,SAASS,SAAS,MACvB,EAAG,EAAAhB,EAAEO,SAASS,SAAS,MACvB,EAAG,EAAAhB,EAAEO,SAASS,SAAS,MACvB,EAAG,EAAAhB,EAAEO,SAASS,SAAS,MACvB,EAAG,EAAAhB,EAAEO,SAASS,SAAS,MACvB,EAAG,EAAAhB,EAAEO,SAASS,SAAS,QACvB,EAAG,EAAAhB,EAAEwB,MAAM,EAAAxB,EAAEO,UAAUC,SAAS,IAChC,EAAG,EAAAR,EAAEiB,KAAK,CAAC,KAAM,KAAM,UACvBT,SAAS,CACT,IAAK,CAAE,EAAG,GAAI,EAAG,OAAQ,EAAG,OAAQ,EAAG,YAAa,EAAG,OAAQ,EAAG,SAAU,EAAG,SAAU,EAAG,CAAC,MAAO,OAAQ,OAAQ,QAAS,EAAG,MAChI,IAAK,CAAE,EAAG,GAAI,EAAG,OAAQ,EAAG,MAAO,EAAG,OAAQ,EAAG,aAAc,EAAG,UAAW,EAAG,QAAS,EAAG,CAAC,MAAO,MAAO,OAAQ,EAAG,MACtH,IAAK,CAAE,EAAG,GAAI,EAAG,MAAO,EAAG,KAAM,EAAG,YAAa,EAAG,QAAS,EAAG,UAAW,EAAG,SAAU,EAAG,CAAC,MAAO,MAAO,OAAQ,EAAG,MACrH,IAAK,CAAE,EAAG,GAAI,EAAG,OAAQ,EAAG,MAAO,EAAG,KAAM,EAAG,QAAS,EAAG,MAAO,EAAG,QAAS,EAAG,CAAC,MAAO,MAAO,OAAQ,EAAG,MAC3G,IAAK,CAAE,EAAG,GAAI,EAAG,OAAQ,EAAG,MAAO,EAAG,QAAS,EAAG,OAAQ,EAAG,MAAO,EAAG,QAAS,EAAG,CAAC,MAAO,MAAO,OAAQ,EAAG,MAC7G,IAAK,CAAE,EAAG,EAAG,EAAG,KAAM,EAAG,MAAO,EAAG,MAAO,EAAG,MAAO,EAAG,MAAO,EAAG,MAAO,EAAG,CAAC,MAAO,MAAO,OAAQ,EAAG,MACrG,IAAK,CAAE,EAAG,GAAI,EAAG,OAAQ,EAAG,MAAO,EAAG,UAAW,EAAG,QAAS,EAAG,MAAO,EAAG,QAAS,EAAG,CAAC,MAAO,MAAO,OAAQ,EAAG,QAEpH,GAAI,EAAAR,EACC4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQ,EAAAhB,EACnCM,OAAO,CACR,GAAI,EAAAN,EAAES,OAAOC,SAASC,UAAUC,GAAKU,EAAEC,MAAMX,EAAG,EAAG,KAAKJ,SAAS,GACjE,GAAI,EAAAR,EAAES,OAAOC,SAASC,UAAUC,GAAKC,KAAKC,IAAI,EAAGF,IAAIJ,SAAS,GAC9D,GAAI,EAAAR,EAAEO,SAASC,SAAS,SACxB,GAAI,EAAAR,EAAEO,SAASC,SAAS,MACxB,GAAI,EAAAR,EAAEO,SAASC,SAAS,KACxB,KAAM,EAAAR,EAAEO,SAASC,SAAS,KAC1B,KAAM,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQ,EAAAhB,EAAEO,SAASS,SAAS,SAASR,SAAS,CAAC,GAClF,GAAI,EAAAR,EAAES,OAAOC,SAASC,UAAUC,GAAKC,KAAKC,IAAI,EAAGF,IAAIJ,SAAS,GAC9D,KAAM,EAAAR,EAAES,OAAOC,SAASC,UAAUC,GAAKC,KAAKC,IAAI,EAAGF,IAAIJ,SAAS,GAChE,KAAM,EAAAR,EAAEiC,UAAUzB,UAAS,GAC3B,IAAK,EAAAR,EAAES,OAAOC,SAASC,UAAUC,GAAKU,EAAEC,MAAMX,GAAI,IAAK,MAAMJ,SAAS,GACtE,GAAI,EAAAR,EAAEO,SAASC,SAAS,OACxB,IAAK,EAAAR,EAAEO,SAASC,SAAS,QAExBA,SAAS,CACV,GAAI,EACJ,GAAI,EACJ,GAAI,QACJ,GAAI,KACJ,GAAI,IACJ,KAAM,IACN,KAAM,CAAC,EACP,GAAI,EACJ,KAAM,EACN,MAAM,EACN,IAAK,EACL,GAAI,MACJ,IAAK,OAEJG,UAAUS,IACX,MAAMe,EAAQf,EAAK,GACb,EAAOjB,EAAiBgC,EAAQ,IAAM,IACtC,EAAO/B,EAAgB+B,EAAQ,IAAM,IACrCC,EAAWvB,KAAKwB,OAAOF,EAAQ,GAAK,GAEpC,EAAO,GAAGlC,EAAYmC,IAAa,OAAOlC,GAD9BiC,EAAQ,GAAK,IAC2C,OACpE,EAAO,GAAGf,EAAK,QAAQ,IACvB,EAAKA,EAAK,KAAO,MAAQA,EAAK,IAAM,EAAO,MAAQ,MACnD,EAAK,IAAKA,EAAK,GAAK,EAAQ,KAAKkB,QAAQ,MAC/C,MAAO,IACAlB,EACH,OACA,OACA,OACA,OACA,KACA,SAGHZ,SAAS,CAAC,GAEf,MAAO,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,QAAS,EAAAhB,EAAEM,OAAO,CAClD,GAAI,EAAAN,EAAES,OAAOC,SAASC,UAAUC,GAAKU,EAAEC,MAAMX,EAAG,EAAG,KAAKJ,SAAS,GACjE,KAAM,EAAAR,EAAEO,SAASC,SAAS,MAC1B,GAAI,EAAAR,EAAEO,SAASC,SAAS,OACxBA,SAAS,CAAC,GAEd,KAAM,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQ,EAAAhB,EAAEM,OAAO,CAChD,GAAI,EAAAN,EAAEiB,KAAK,CAAC,KAAM,KAAM,KAAM,SAC9B,GAAI,EAAAjB,EAAEO,SACN,GAAI,EAAAP,EAAEiB,KAAK,CAAC,MAAO,MAAO,QAAQT,SAAS,UAC3CA,SAAS,CAAC,GAEd,KAAM,EAAAR,EAAE4B,OAAO,EAAA5B,EAAEO,SAASS,SAAS,OAAQ,EAAAhB,EAAEM,OAAO,CAChD,EAAG,EAAAN,EAAES,OAAOC,SAASC,UAAUC,GAAKU,EAAEC,MAAMX,GAAI,IAAK,MACrD,GAAI,EAAAZ,EAAEO,YACNC,SAAS,CAAC,KCnZlB,MAAM,EAAS,CAEX+B,eAAgB,UAGhBC,OAAO,EAGPC,eAAgB,EAMhBC,SAAU,WAGVC,iBAAkB,IAGlBC,eAAgB,IAKhBC,kBAAmB,CACf,IAAO,CAAC,KAAM,OAMlBC,yBAA0B,CACtB,UACA,kBACA,gBACA,aACA,UACA,YA0BFC,EAAyB,CAI3B,CACIC,aAAc,UACdC,aAAc,KAAM,EACpBC,SAAU,KAEd,CACIF,aAAc,kBACdC,aAAc,KAAM,EACpBC,SAAU,KAEd,CACIF,aAAc,gBACdC,aAAc,KAAM,EACpBC,SAAU,KAMd,CACIF,aAAc,kBACdC,aAAc,CAACE,EAAKC,KAChB,IAAKA,IAAcD,EAAIE,cAAe,OAAO,EAC7C,MAAMC,EAAQF,EAAUE,MAAM,mBAC9B,IAAKA,EAAO,OAAO,EACnB,MAAMC,EAAaD,EAAM,GAAGE,OAGtBC,EAAUN,EAAIE,gBAAkBE,EAMtC,OAJI,EAAOf,OAASiB,GAChBC,QAAQC,IAAI,mBAAmBJ,SAAkBJ,EAAIE,iBAGlDI,GAEXP,SAAU,IAOd,CACIF,aAAc,+CACdC,aAAc,CAACE,EAAKC,KAChB,IAAKA,EAAW,OAAO,EACvB,MAAME,EAAQF,EAAUE,MAAM,gDAC9B,IAAKA,EAAO,OAAO,EAEnB,MAAMM,EAAgBN,EAAM,GAAGE,OACzBK,EAAYP,EAAM,GAGlBQ,EAAcX,EAAIY,SAAS,KAAKH,GACtC,IAAKE,EAID,OAHI,EAAOtB,OACPkB,QAAQC,IAAI,sBAAsBC,MAE/B,EAOX,GAHoBT,EAAIa,eAAeC,OAAS,EAG/B,CAEb,MAAMC,EAAW,CAACN,GACd,EAAOf,kBAAkBe,IACzBM,EAASC,QAAQ,EAAOtB,kBAAkBe,IAI9C,IAAIQ,GAAc,EAClB,IAAK,MAAMC,KAAQH,EAAU,CACzB,MAAMI,EAAUD,EAAKE,QAAQ,sBAAuB,QAC9CC,EAAY,IAAIC,OAClB,+BAA+BH,gCAC/B,KAEJ,GAAInB,EAAIa,eAAeU,KAAKC,GAAOH,EAAUI,KAAKD,IAAO,CACrDP,GAAc,EACV,EAAO5B,OACPkB,QAAQC,IAAI,kBAAkBU,QAAWT,KAE7C,KACJ,CACJ,CAEA,IAAKQ,EAID,OAHI,EAAO5B,OACPkB,QAAQC,IAAI,wBAAwBC,YAEjC,CAEf,MACQ,EAAOpB,OACPkB,QAAQC,IAAI,8BAA8BC,KAKlD,MAQMiB,EARgD,CAClD,IAAO,EAAE,IAAK,IACd,IAAO,CAAC,GAAI,IACZ,IAAO,CAAC,GAAI,IACZ,IAAO,CAAC,GAAI,IACZ,IAAO,CAAC,GAAI,MAGUhB,GAC1B,IAAKgB,EAAO,OAAO,EAEnB,MAAMC,EAAQhB,EAAY,KAAO,EAC3BiB,EAAYD,GAASD,EAAM,IAAMC,GAASD,EAAM,GAMtD,OAJI,EAAOrC,OACPkB,QAAQC,IAAI,mBAAmBC,OAAmBC,UAAkBiB,UAAcD,EAAM,OAAOA,EAAM,WAAWE,KAG7GA,GAEX7B,SAAU,GAId,CACIF,aAAc,qBACdC,aAAc,CAACE,EAAKC,KAChB,IAAKA,EAAW,OAAO,EACvB,MAAME,EAAQF,EAAUE,MAAM,sBAC9B,IAAKA,EAAO,OAAO,EACnB,MAAMM,EAAgBN,EAAM,GAAGE,OAG3B,EAAOhB,QACPkB,QAAQC,IAAI,oBAAoBC,KAChCF,QAAQC,IAAI,oBAAoBR,EAAIa,eAAeC,YAAad,EAAIa,iBAKxE,IAAIgB,EAAoBpB,EACpBqB,GAAe,EAEnB,IAAK,MAAOC,EAAUC,KAAYC,OAAOC,QAAQ,EAAOxC,mBACpD,GAAIsC,EAAQG,SAAS1B,GAAgB,CACjCoB,EAAoBE,EACpBD,GAAe,EACX,EAAOzC,OACPkB,QAAQC,IAAI,uBAAuBC,aAAyBsB,KAEhE,KACJ,CAMJ,KAFoB/B,EAAIa,eAAeC,OAAS,GAE9B,CAEd,MAAMsB,OAAuDC,IAAzCrC,EAAIY,SAAS,KAAKiB,GAUtC,OARI,EAAOxC,QACH+C,EACA7B,QAAQC,IAAI,sBAAsBC,IAAgBqB,EAAe,UAAUD,KAAuB,eAElGtB,QAAQC,IAAI,sBAAsBC,IAAgBqB,EAAe,UAAUD,KAAuB,iBAInGO,CACX,CAKA,IAAIE,EAEAR,EAEAQ,EAAa,CAAC7B,IAGd6B,EAAa,CAAC7B,GACV,EAAOf,kBAAkBe,IACzB6B,EAAWtB,QAAQ,EAAOtB,kBAAkBe,KAKpD,IAAI8B,EAAe,EACnB,MAAMC,EAA2B,GAEjC,IAAK,MAAMtB,KAAQoB,EAAY,CAC3B,MAAMnB,EAAUD,EAAKE,QAAQ,sBAAuB,QAC9CC,EAAY,IAAIC,OAClB,+BAA+BH,gCAC/B,KAEEsB,EAAQzC,EAAIa,eAAe6B,OAAOlB,GAAOH,EAAUI,KAAKD,IAAMV,OAEhE2B,EAAQ,IACRF,GAAgBE,EAChBD,EAAexB,KAAK,GAAGE,KAAQuB,OAE3B,EAAOpD,OACPkB,QAAQC,IAAI,mBAAmBU,SAAYG,SAAiBoB,KAGxE,CAGA,MAAM3C,EAAeyC,GAAgB,EAErC,GAAI,EAAOlD,MAAO,CACd,MAAMsD,EAAWb,EAAe,aAAaD,KAAuB,GAC9De,GAAad,GAAgB,EAAOpC,kBAAkBe,GACtD,SAAS,EAAOf,kBAAkBe,GAAeoC,KAAK,SACtD,GACAC,EAAaN,EAAe1B,OAAS,EAAI,UAAU0B,EAAeK,KAAK,QAAU,GAEnF/C,EACAS,QAAQC,IAAI,mBAAmBC,IAAgBkC,IAAWC,WAAmBL,KAAgBO,KAE7FvC,QAAQC,IAAI,mBAAmBC,IAAgBkC,IAAWC,WAAmBL,YAErF,CAEA,OAAOzC,GAEXC,SAAU,GAMd,CACIF,aAAc,kBACdC,aAAc,CAACE,EAAKC,KAChB,IAAKA,EAAW,OAAO,EACvB,MAAME,EAAQF,EAAUE,MAAM,mBAC9B,IAAKA,EAAO,OAAO,EACnB,MAAM4C,EAAY5C,EAAM,GAAGE,OACrBrB,EAAQgB,EAAIY,SAAS,IAAI,IAAM,EAe/Bc,EAZgD,CAClD,GAAM,CAAC,EAAG,GACV,GAAM,CAAC,EAAG,GACV,GAAM,CAAC,EAAG,IACV,GAAM,CAAC,GAAI,IACX,GAAM,CAAC,GAAI,IACX,GAAM,CAAC,GAAI,IACX,GAAM,CAAC,GAAI,IACX,GAAM,CAAC,GAAI,IACX,GAAM,CAAC,GAAI,KAGWqB,GAC1B,IAAKrB,EAID,OAHI,EAAOrC,OACPkB,QAAQC,IAAI,mBAAmBuC,MAE5B,EAGX,MAAMnB,EAAY5C,GAAS0C,EAAM,IAAM1C,GAAS0C,EAAM,GAMtD,OAJI,EAAOrC,OACPkB,QAAQC,IAAI,iBAAiBuC,SAAiB/D,UAAc0C,EAAM,OAAOA,EAAM,WAAWE,KAGvFA,GAEX7B,SAAU,GAMd,CACIF,aAAc,kBACdC,aAAc,CAACE,EAAKC,KAChB,IAAKA,EAAW,OAAO,EACvB,MAAME,EAAQF,EAAUE,MAAM,mBAC9B,IAAKA,EAAO,OAAO,EACnB,MAAM6C,EAAY7C,EAAM,GAAGE,OAGrBc,EAAU6B,EAAU5B,QAAQ,sBAAuB,QACnD6B,EAAa,IAAI3B,OACnB,2CAA2CH,4CAC3C,KAGEF,EAAcjB,EAAIa,eAAeU,KAAKC,GAAOyB,EAAWxB,KAAKD,IAMnE,OAJI,EAAOnC,OAAS4B,GAChBV,QAAQC,IAAI,mBAAmBwC,KAG5B/B,GAEXlB,SAAU,GAMd,CACIF,aAAc,aACdC,aAAc,KAAM,EACpBC,SAAU,KAMd,CACIF,aAAc,sCACdC,aAAc,CAACE,EAAKC,KAChB,IAAKA,EAAW,OAAO,EACvB,MAAME,EAAQF,EAAUE,MAAM,uCAC9B,IAAKA,EAAO,OAAO,EAEnB,MAAM+C,EAAW/C,EAAM,GACjBgD,EAAWhD,EAAM,GAAGE,OAGpBc,EAAUgC,EAAS/B,QAAQ,sBAAuB,QAClDgC,EAAY,IAAI9B,OAAOH,EAAS,KAGhCoB,EAAevC,EAAIa,eAAe6B,OAAOlB,GAAO4B,EAAU3B,KAAKD,IAAMV,OAGrEhB,EAAeyC,GAAgB,EAMrC,OAJI,EAAOlD,OAASkD,EAAe,GAC/BhC,QAAQC,IAAI,WAAW0C,QAAeC,WAAkBZ,SAAoBzC,KAGzEA,GAEXC,SAAU,IAQlB,IAAIsD,GAAe,EACfC,EAAkB,EAKtBC,eAAeC,IACX,IAEI,MAAMC,EAAiB,IAAIC,QAAkBC,IACzCC,WAAW,IAAMD,GAAQ,GAAQ,EAAOnE,oBAItCqE,EAAc,iBACVC,sBAAsB,QACrB,GAFS,GAMpB,aAAaJ,QAAQK,KAAK,CAACF,EAAaJ,GAC5C,CAAE,MAAOO,GAEL,OADAzD,QAAQ0D,KAAK,sBAAuBD,IAC7B,CACX,CACJ,CAsGAT,eAAeW,EAAuBC,EAA6B,UAE/D,MAAMC,EAAMC,KAAKD,MACjB,GAAIA,EAAMd,EAAkB,EAAO7D,eAC3B,EAAOJ,OACPkB,QAAQC,IAAI,8BAMpB,GAFA8C,EAAkBc,EAEdf,EACI,EAAOhE,OACPkB,QAAQC,IAAI,4BAFpB,CAMA6C,GAAe,EAEf,IACI,MAAMiB,QAxHdf,iBAGI,UADuBC,IAKnB,OAHI,EAAOnE,OACPkB,QAAQC,IAAI,0BAET,KAIX,IAAIK,EAA2B,GAC/B,IAEI,MAAM0D,EAAgBC,mBACtB,GAAID,GAAiB,EAAG,CAEpB,MAAME,EAAcC,gBAAgB,KAAKH,KACrCE,GAAeA,EAAY3D,OAAS,IAEpCD,EAAiB4D,EACZE,OAAO,EAAOrF,gBACdsF,IAAIC,IACD,IAAIC,EAAUD,EAAEE,SAAW,GAkB3B,OAdAD,EAAUA,EAAQ1D,QAAQ,mBAAoB,IAG9C0D,EAAUA,EAAQ1D,QAAQ,WAAY,IAGtC0D,EAAUA,EAAQ1D,QAAQ,8CAA+C,IAGzE0D,EAAUA,EAAQ1D,QAAQ,4BAA6B,IAGvD0D,EAAUA,EAAQ1D,QAAQ,kBAAmB,IAEtC0D,EAAQzE,SAElBqC,OAAOlB,GAAOA,EAAIV,OAAS,GAE5B,EAAOzB,OACPkB,QAAQC,IAAI,uBAAwBK,GAGhD,CACJ,CAAE,MAAOmD,GAED,EAAO3E,OACPkB,QAAQ0D,KAAK,iBAAkBD,GAEnCnD,EAAiB,EACrB,CAGA,IAAID,EAAkD,KACtD,IAGI,GADsB4D,oBACD,EAAG,CACpB,MAAMQ,EAAYC,aAAa,CAAEC,KAAM,UAAWC,YAAa,IACzDC,EAAWjH,EAAEkH,IAAIL,EAAW,YAAa,MAC3CI,IACAxE,EAAUpC,EAAO8G,MAAMF,GAE/B,CAGA,IAAKxE,EAID,OAHI,EAAOvB,OACPkB,QAAQC,IAAI,4BAET,IAEf,CAAE,MAAOwD,GAEL,OADAzD,QAAQ0D,KAAK,sBAAuBD,GAC7B,IACX,CAEA,MAAM9D,EAAgBU,GAAS,IAAI,IAAI,MAAQ,KAM/C,OAJI,EAAOvB,OACPkB,QAAQC,IAAI,oBAAoBN,WAAuBW,EAAeC,UAGnE,CACHZ,gBACAW,iBACAD,UAER,CA0B8B2E,GAGtB,IAAKjB,EAID,YAHI,EAAOjF,OACPkB,QAAQC,IAAI,0BAMpB,IAAIgF,EAAgB,EAAOpG,eAC3B,GAAsB,YAAlBoG,EAA6B,CAC7B,MAAMC,EAAiBC,sBAAsB,WAE7C,GADAF,EAAgBC,EAAeE,SAAW,IACrCH,EAED,YADAjF,QAAQ0D,KAAK,wBAGrB,CAEA,IAAI2B,EAAe,EACfC,EAAgB,EAChBC,EAAiB,EAGrB,MAAMC,EAAc,IAAInG,GAAOoG,KAAK,CAACC,EAAGC,KAAOA,EAAEnG,UAAY,IAAMkG,EAAElG,UAAY,IA2HjF,SAxHMoG,oBAAoBX,EAAeY,IACjC,EAAO/G,QACPkB,QAAQC,IAAI,oBAAoB2D,SAAYqB,QAAoBY,EAAUtF,cAC1EP,QAAQC,IAAI,sBAAsB8D,EAAQpE,sBAAsBoE,EAAQ1D,SAAS,IAAI,IAAM,aAAa0D,EAAQzD,eAAeC,WAGnI,IAAK,MAAMuF,KAASD,EAAW,CAG3B,IAAKC,EAAMC,QACP,SAGJ,MAAMrG,EAAYoG,EAAMnF,MAAQ,GAChC,IAAKjB,EAAW,CACR,EAAOZ,OACPkB,QAAQ0D,KAAK,sBAEjB,QACJ,CAEA,IAAIsC,EAAoC,KAGxC,IAAK,MAAMC,KAAQT,EAAa,CAM5B,GAJiC,iBAAtBS,EAAK3G,aACNI,EAAUkC,SAASqE,EAAK3G,cACxB2G,EAAK3G,aAAa4B,KAAKxB,GAEpB,CACTsG,EAAcC,EACd,KACJ,CACJ,CAIA,IAAKD,EACD,SAGJ,MAAME,EAAcJ,EAAMK,SAASxB,KAGnC,GAAa,WAATf,EAAmB,CAEnB,IAAIwC,GAAmB,EACvB,IACIA,EAAmBJ,EAAYzG,aAAawE,EAASrE,EACzD,CAAE,MAAO+D,GACLzD,QAAQqG,MAAM,iBAAiB3G,UAAmB+D,GAClD,QACJ,CAGA,MAAM6C,EAAa,UAAUpF,KAAKxB,IAC9B,kBAAkBwB,KAAKxB,IACvB,gBAAgBwB,KAAKxB,IACrB,aAAawB,KAAKxB,GAGlB0G,GAAoC,aAAhBF,GAEpBJ,EAAMK,SAASxB,KAAO,WACtBU,IACAE,IACI,EAAOzG,OACPkB,QAAQC,IAAI,sBAAsBP,MAE9B0G,GAAoC,aAAhBF,GAA+BI,IAE3DR,EAAMK,SAASxB,KAAO,YACtBW,IACAC,IACI,EAAOzG,OACPkB,QAAQC,IAAI,uBAAuBP,KAG/C,MAEI,GAAoB,aAAhBwG,EAA4B,CAC5B,IAAIK,GAAoB,EAKpBA,EAFoB,iBAApB,EAAOvH,WAGoB,aAApB,EAAOA,SAEM,EAAOI,yBAAyB4B,KAAKwF,GACrDA,EAAQtF,KAAKxB,IAIG,UAAUwB,KAAKxB,IAC/B,kBAAkBwB,KAAKxB,IACvB,gBAAgBwB,KAAKxB,IAGxB6G,IACDT,EAAMK,SAASxB,KAAO,YACtBW,IACAC,IACI,EAAOzG,OACPkB,QAAQC,IAAI,oBAAoBP,KAG5C,CAER,CAMA,OAJI,EAAOZ,OACPkB,QAAQC,IAAI,iBAAiB2D,WAAc2B,aAA0BF,WAAsBC,QAGxFO,IAIPR,EAAe,GAAKC,EAAgB,EAAG,CACvC,MACMd,EAAU,GADU,WAATZ,EAAoB,SAAW,gBACbyB,WAAsBC,MACzDtF,QAAQyG,KAAK,WAAWjC,KACpB,EAAO1F,OACP4H,OAAOD,KAAKjC,EAAS,QAE7B,MACQ,EAAO1F,OACPkB,QAAQC,IAAI,uBAAuB2D,OAG/C,CAAE,MAAOH,GAECA,aAAakD,OAASlD,EAAEe,QAAQ5C,SAAS,QACzC6B,aAAakD,OAASlD,EAAEe,QAAQ5C,SAAS,OAMvC,EAAO9C,OACPkB,QAAQC,IAAI,iCANhBD,QAAQqG,MAAM,eAAgB5C,GAC1B,EAAO3E,OACP4H,OAAOL,MAAM,SAAS5C,aAAakD,MAAQlD,EAAEe,QAAU,SAAU,SAO7E,C,QACI1B,GAAe,CACnB,CApLA,CAqLJ,CAMA8D,EAAE,KACEC,aAAa7D,UACThD,QAAQyG,KAAK,iBACbzG,QAAQyG,KAAK,iBAAiB,EAAOzH,YAGrC,MAAM8H,QAAiB7D,IACnB6D,GACA9G,QAAQyG,KAAK,4BAGP,IAAItD,QAAQC,GAAWC,WAAWD,EAAS,aAC3CO,EAAuB,UAC7B3D,QAAQyG,KAAK,oBAEbzG,QAAQ0D,KAAK,+BAQjBqD,QAAQC,cAAcC,aAAcjE,UAC5B,EAAOlE,OACPkB,QAAQC,IAAI,qCAEV0D,EAAuB,YAIjCoD,QAAQC,cAAcE,eAAgBlE,MAAO4B,IACrC,EAAO9F,OACPkB,QAAQC,IAAI,kBAAkB2E,2BAI5B,IAAIzB,QAAQC,GAAWC,WAAWD,EAAS,YAC3CO,EAAuB,YAIjCoD,QAAQC,cAAcG,iBAAkBnE,UAChC,EAAOlE,OACPkB,QAAQC,IAAI,uCAGV,IAAIkD,QAAQC,GAAWC,WAAWD,EAAS,YAC3CO,EAAuB,aAQjCoD,QAAQC,cAAcI,aAAcpE,UAC5B,EAAOlE,OACPkB,QAAQC,IAAI,oCAGV,IAAIkD,QAAQC,GAAWC,WAAWD,EAAS,YAC3CO,EAAuB,YAIjCoD,QAAQC,cAAcK,aAAcrE,UAC5B,EAAOlE,OACPkB,QAAQC,IAAI,oCAGV,IAAIkD,QAAQC,GAAWC,WAAWD,EAAS,YAC3CO,EAAuB,YAIjCoD,QAAQC,cAAcM,sBAAuBtE,UACrC,EAAOlE,OACPkB,QAAQC,IAAI,6CAGV,IAAIkD,QAAQC,GAAWC,WAAWD,EAAS,YAC3CO,EAAuB,YAM7BmD,GACAC,QAAQQ,IAAIC,OAAOC,sBAAuBzE,UAClC,EAAOlE,OACPkB,QAAQC,IAAI,6CAGV,IAAIkD,QAAQC,GAAWC,WAAWD,EAAS,YAC3CO,EAAuB,YAIrC,MAAM+D,EACkB,eAApB,EAAO1I,SAA4B,gBACX,aAApB,EAAOA,SAA0B,WAC7B,YAEZgB,QAAQyG,KAAK,qBAAqBiB,KAC9BZ,EACAJ,OAAOiB,QAAQ,cAAcD,IAAgB,QAE7ChB,OAAOD,KAAK,uBAAwB,SA3G5CI","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/踏月寻仙-测试版/schema.ts","src://tavern_helper_template/src/踏月寻仙-动态世界书管理/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","// ============================================================================\n// 踏月寻仙 - MVU 变量结构定义 (Zod Schema for MVU Variables)\n// ============================================================================\n// 修炼境界等级与境界描述映射\n// 等级 1-4:   练气（初期、中期、后期、大圆满）\n// 等级 5-8:   筑基（初期、中期、后期、大圆满）\n// 等级 9-12:  金丹（初期、中期、后期、大圆满）\n// 等级 13-16: 元婴（初期、中期、后期、大圆满）\n// 等级 17-20: 化神（初期、中期、后期、大圆满）\n// 等级 21-24: 炼虚（初期、中期、后期、大圆满）\n// 等级 25-28: 合体（初期、中期、后期、大圆满）\n// 等级 29-32: 大乘（初期、中期、后期、大圆满）\n// 等级 33-36: 渡劫（初期、中期、后期、大圆满）\nconst REALM_NAMES = ['练气', '筑基', '金丹', '元婴', '化神', '炼虚', '合体', '大乘', '渡劫'];\nconst REALM_STAGES = ['初期', '中期', '后期', '大圆满'];\n// 修炼境界等级与突破阈值映射\nconst REALM_THRESHOLDS = [100, 100, 100, 100, 200, 200, 200, 200, 400, 400, 400, 400, 800, 800, 800, 800, 1600, 1600, 1600, 1600, 3200, 3200, 3200, 3200, 6400, 6400, 6400, 6400, 12800, 12800, 12800, 12800, 25600, 25600, 25600, 25600];\n// 修炼境界等级与寿元上限映射\nconst REALM_LIFESPANS = [100, 100, 100, 100, 200, 200, 200, 200, 500, 500, 500, 500, 1000, 1000, 1000, 1000, 2000, 2000, 2000, 2000, 5000, 5000, 5000, 5000, 10000, 10000, 10000, 10000, 50000, 50000, 50000, 50000, 100000, 100000, 100000, 100000];\n// 物品 Schema\nconst ItemSchema = z.object({\n    名称: z.string().prefault(''),\n    描述: z.string().prefault(''),\n    品阶: z.string().prefault(''),\n    数量: z.coerce.number().transform(v => Math.max(1, v)).prefault(1), // 默认为 1 且最小为 1，避免被过滤\n});\n// 宗门势力 Schema - 优化版\nconst FactionSchema = z.object({\n    地: z.string().describe('所在地'),\n    特: z.string().describe('核心特点'),\n    力: z.string().describe('最高战力'),\n    营: z.enum(['正', '魔', '中']),\n    模: z.enum(['超大', '大', '小', '微', '特']),\n});\n// 功法 Schema - 优化版\nconst TechniqueSchema = z.object({\n    阶: z.enum(['凡', '黄', '玄', '地', '天', '仙', '圣']),\n    性: z.string().describe('属性'),\n    效: z.string().describe('效果'),\n});\n// 法宝兵器 Schema - 极简版\nconst TreasureSchema = z.object({\n    阶: z.enum(['凡器', '法器', '灵器', '法宝', '灵宝', '仙器', '圣器', '道器']),\n    类: z.string().describe('类型'),\n}).transform(data => ({\n    ...data,\n    特: data.阶 === '仙器' ? '顶级' : data.阶 === '灵宝' ? '强' : data.阶 === '法宝' ? '中' : '普通',\n}));\n// 地点 Schema - 优化版\nconst LocationSchema = z.object({\n    域: z.enum(['天层', '神州', '东苍', '南炎', '西庚', '北冥', '下层', '四海']),\n    类: z.enum(['秘境', '城镇', '宗门', '禁地', '遗迹', '地形']),\n    危: z.coerce.number().transform(v => _.clamp(v, 0, 100)),\n    特: z.string().describe('特点'),\n    资: z.array(z.string()).prefault([]),\n});\n// 灵根 Schema - 极简版（速度根据质自动计算）\nconst SpiritRootSchema = z.object({\n    质: z.enum(['劣', '下', '中', '上', '极', '天', '异']),\n    性: z.string().describe('属性'),\n    稀: z.enum(['常', '少', '罕', '稀', '传']),\n}).transform(data => {\n    const 速度映射 = { 劣: '0.3倍', 下: '0.5倍', 中: '1倍', 上: '2倍', 极: '3倍', 天: '5倍', 异: '4倍' };\n    return {\n        ...data,\n        速: 速度映射[data.质] || '1倍',\n        特: data.质 === '天' ? '单系顶级' : data.质 === '异' ? '变异稀有' : data.质 === '极' ? '双系优秀' : '常规',\n    };\n});\n// 体质 Schema - 优化版\nconst PhysiqueSchema = z.object({\n    质: z.enum(['凡', '灵', '道', '圣', '神']),\n    特: z.string().describe('特性'),\n    稀: z.enum(['常', '少', '罕', '稀', '传']),\n}).transform(data => ({\n    ...data,\n    优: data.质 === '神' ? '至高' : data.质 === '圣' ? '极强' : data.质 === '道' ? '强' : data.质 === '灵' ? '中' : '无',\n}));\n// 完整的 MVU 变量结构 - 完全参考角色卡示例的结构\nexport const Schema = z.object({\n    世界时钟: z.object({\n        纪元: z.string().prefault('末法时代'),\n        年份: z.coerce.number().prefault(1),\n        月份: z.coerce.number().transform(v => _.clamp(v, 1, 12)).prefault(1),\n        日期: z.coerce.number().transform(v => _.clamp(v, 1, 30)).prefault(1),\n        时辰: z.string().prefault('子时'),\n    }).prefault({\n        纪元: '末法时代',\n        年份: 1,\n        月份: 1,\n        日期: 1,\n        时辰: '子时',\n    }),\n    世界地图: z.record(z.string().describe('区域名'), z.object({\n        layer: z.enum(['天层', '地层', '下层']).prefault('地层'),\n        danger: z.coerce.number().transform(v => _.clamp(v, 0, 100)),\n        desc: z.string().prefault(''),\n        connections: z.array(z.string()).prefault([]),\n    })).prefault({}),\n    世界图志: z.record(z.string().describe('事件名'), z.object({\n        状态: z.string().prefault(''),\n        事件: z.string().prefault(''),\n    })).prefault({}),\n    宗门势力库: z.record(z.string().describe('宗门名'), FactionSchema).prefault({\n        // 正道\n        剑阁: { 地: '神州剑门关', 特: '剑道源头', 力: '渡劫后期', 营: '正', 模: '超大' },\n        万法宗: { 地: '神州问道峰', 特: '万法本源', 力: '渡劫初期', 营: '正', 模: '超大' },\n        金刚寺: { 地: '西天佛山', 特: '佛修炼体', 力: '大乘中期', 营: '正', 模: '大' },\n        药王谷: { 地: '神农架', 特: '医炼丹药', 力: '大乘初期', 营: '正', 模: '大' },\n        儒门: { 地: '文圣山', 特: '浩然正气', 力: '大乘中期', 营: '正', 模: '大' },\n        青龙殿: { 地: '东苍青龙山', 特: '守护青帝', 力: '大乘初期', 营: '正', 模: '大' },\n        玄武宗: { 地: '北冥玄冰山', 特: '镇守归墟', 力: '大乘后期', 营: '正', 模: '大' },\n        建木宗: { 地: '东苍建木树', 特: '木系道法', 力: '合体中期', 营: '正', 模: '小' },\n        百花谷: { 地: '百花秘境', 特: '女修花道', 力: '合体后期', 营: '正', 模: '小' },\n        // 魔道\n        血神教: { 地: '血魔渊', 特: '血道炼法', 力: '渡劫中期', 营: '魔', 模: '超大' },\n        天魔宗: { 地: '天魔山', 特: '天魔大道', 力: '大乘中期', 营: '魔', 模: '大' },\n        // 中立\n        妖盟: { 地: '万妖森林', 特: '妖族联盟', 力: '渡劫中期', 营: '中', 模: '超大' },\n        大夏王朝: { 地: '中州皇城', 特: '世俗统治', 力: '大乘初期', 营: '中', 模: '大' },\n        九州商会: { 地: '九大主城', 特: '商业联盟', 力: '大乘初期', 营: '中', 模: '大' },\n        离火宫: { 地: '南炎火山', 特: '朱雀供奉', 力: '合体圆满', 营: '中', 模: '小' },\n        铸剑山庄: { 地: '南炎地火', 特: '炼器第一', 力: '合体后期', 营: '中', 模: '小' },\n    }),\n    功法库: z.record(z.string().describe('功法名'), TechniqueSchema).prefault({\n        // 基础 - 保留核心\n        引气诀: { 阶: '凡', 性: '通用', 效: '入门' },\n        筑基真解: { 阶: '玄', 性: '通用', 效: '筑基' },\n        金丹大道: { 阶: '地', 性: '通用', 效: '结丹' },\n        // 五行天阶 - 合并相似\n        万剑归宗诀: { 阶: '天', 性: '金剑', 效: '剑阁镇宗' },\n        建木通天诀: { 阶: '天', 性: '木', 效: '建木镇宗' },\n        北冥真经: { 阶: '天', 性: '水', 效: '玄武吞噬' },\n        朱雀涅槃经: { 阶: '天', 性: '火', 效: '离火涅槃' },\n        不动明王身: { 阶: '天', 性: '土佛', 效: '金刚防御' },\n        // 仙阶\n        万木朝宗: { 阶: '仙', 性: '木', 效: '青帝遗法' },\n        海纳百川: { 阶: '仙', 性: '水', 效: '归墟本源' },\n        祝融神火: { 阶: '仙', 性: '火', 效: '火神遗法' },\n        轮回经: { 阶: '仙', 性: '轮回', 效: '{{user}}专属' },\n        斩轮回剑典: { 阶: '仙', 性: '剑轮回', 效: '{{user}}前世' },\n        剑意通神: { 阶: '仙', 性: '剑道', 效: '剑意化形' },\n        // 特殊 - 保留关键\n        九天雷神诀: { 阶: '天', 性: '雷', 效: '雷霆' },\n        虚空经: { 阶: '天', 性: '空间', 效: '空间' },\n        万法归宗: { 阶: '天', 性: '通用', 效: '模拟' },\n        医仙宝典: { 阶: '天', 性: '医道', 效: '医道' },\n        天魔策: { 阶: '天', 性: '魔道', 效: '速成' },\n    }),\n    法宝库: z.record(z.string().describe('法宝名'), TreasureSchema).prefault({\n        // 核心仙器（白名单）\n        镇渊剑: { 阶: '仙器', 类: '剑' },\n        双鱼佩: { 阶: '仙器', 类: '护身' },\n        // 基础法宝\n        青锋剑: { 阶: '法器', 类: '剑' },\n        储物戒: { 阶: '灵器', 类: '储物' },\n        // 四象灵宝\n        青龙剑: { 阶: '灵宝', 类: '剑' },\n        白虎剑: { 阶: '灵宝', 类: '剑' },\n        朱雀剑: { 阶: '灵宝', 类: '剑' },\n        玄武剑: { 阶: '灵宝', 类: '剑' },\n    }),\n    地点库: z.record(z.string().describe('地点名'), LocationSchema).prefault({\n        // 天层 - 保留核心禁地\n        天渊: { 域: '天层', 类: '禁地', 危: 95, 特: '星辰裂隙', 资: ['星辰碎片', '陨铁'] },\n        罡风带: { 域: '天层', 类: '禁地', 危: 90, 特: '罡风屏障', 资: ['罡风精华'] },\n        // 神州 - 压缩描述但保留关键信息\n        问道峰: { 域: '神州', 类: '宗门', 危: 10, 特: '万法宗', 资: ['功法', '灵药'] },\n        剑门关: { 域: '神州', 类: '宗门', 危: 15, 特: '剑阁', 资: ['剑意', '飞剑'] },\n        藏书阁: { 域: '神州', 类: '宗门', 危: 5, 特: '古籍', 资: ['功法', '秘术'] },\n        酆都城: { 域: '神州', 类: '城镇', 危: 30, 特: '鬼市', 资: ['幽冥材料'] },\n        龙门瀑: { 域: '神州', 类: '秘境', 危: 40, 特: '化龙', 资: ['龙气'] },\n        // 东苍 - 保留重要遗迹和秘境\n        建木林: { 域: '东苍', 类: '地形', 危: 50, 特: '古树精', 资: ['灵木', '妖丹'] },\n        青帝陵: { 域: '东苍', 类: '遗迹', 危: 85, 特: '青帝传承', 资: ['青帝传承'] },\n        百花境: { 域: '东苍', 类: '秘境', 危: 20, 特: '花海', 资: ['灵花'] },\n        // 南炎 - 火系核心地点\n        不灭火山: { 域: '南炎', 类: '地形', 危: 80, 特: '朱雀涅槃', 资: ['朱雀火'] },\n        涅槃台: { 域: '南炎', 类: '遗迹', 危: 70, 特: '涅槃', 资: ['涅槃感悟'] },\n        // 西庚 - 剑道圣地\n        万剑冢: { 域: '西庚', 类: '禁地', 危: 85, 特: '剑意', 资: ['剑意', '古剑'] },\n        // 北冥 - 水系核心\n        玄冰山: { 域: '北冥', 类: '宗门', 危: 50, 特: '玄武宗', 资: ['玄冰'] },\n        归墟眼: { 域: '北冥', 类: '禁地', 危: 99, 特: '归墟', 资: ['归墟感悟'] },\n        // 下层 - 危险禁地\n        黄泉迹: { 域: '下层', 类: '遗迹', 危: 90, 特: '幽冥', 资: ['黄泉水'] },\n        炎渊: { 域: '下层', 类: '禁地', 危: 95, 特: '地心火', 资: ['地心火'] },\n    }),\n    灵根库: z.record(z.string().describe('灵根名'), SpiritRootSchema).prefault({\n        // 天灵根\n        金天根: { 质: '天', 性: '金', 稀: '传' },\n        木天根: { 质: '天', 性: '木', 稀: '传' },\n        水天根: { 质: '天', 性: '水', 稀: '传' },\n        火天根: { 质: '天', 性: '火', 稀: '传' },\n        土天根: { 质: '天', 性: '土', 稀: '传' },\n        // 多灵根\n        三灵根: { 质: '上', 性: '三系', 稀: '罕' },\n        四灵根: { 质: '中', 性: '四系', 稀: '少' },\n        五行杂根: { 质: '下', 性: '五行', 稀: '常' },\n        // 变异灵根\n        冰根: { 质: '异', 性: '冰', 稀: '传' },\n        雷根: { 质: '异', 性: '雷', 稀: '传' },\n        离火根: { 质: '异', 性: '离火', 稀: '传' },\n        空间根: { 质: '异', 性: '空间', 稀: '传' },\n        时间根: { 质: '异', 性: '时间', 稀: '传' },\n        混沌根: { 质: '异', 性: '混沌', 稀: '传' },\n        轮回根: { 质: '异', 性: '轮回', 稀: '传' },\n    }),\n    体质库: z.record(z.string().describe('体质名'), PhysiqueSchema).prefault({\n        凡体: { 质: '凡', 特: '普通', 稀: '常' },\n        // 灵体 - 合并相似属性体质\n        玄冰体: { 质: '灵', 特: '冰系增强', 稀: '罕' },\n        离火体: { 质: '灵', 特: '火系增强', 稀: '罕' },\n        木灵体: { 质: '灵', 特: '恢复增强', 稀: '罕' },\n        天籁体: { 质: '灵', 特: '音律神通', 稀: '罕' },\n        花妖体: { 质: '灵', 特: '魅惑控制', 稀: '稀' },\n        // 道体\n        朱雀脉: { 质: '道', 特: '火系涅槃', 稀: '传' },\n        真龙脉: { 质: '道', 特: '龙族神通', 稀: '传' },\n        战体: { 质: '道', 特: '战力倍增', 稀: '传' },\n        梦魇体: { 质: '道', 特: '幻术掌控', 稀: '传' },\n        雪魂体: { 质: '道', 特: '冰系极致', 稀: '传' },\n        // 圣体\n        混沌体: { 质: '圣', 特: '万法无阻', 稀: '传' },\n        道体: { 质: '圣', 特: '悟性极高', 稀: '传' },\n        金身: { 质: '圣', 特: '防御无敌', 稀: '传' },\n        // 神体\n        轮回体: { 质: '神', 特: '{{user}}专属轮回', 稀: '传' },\n        时空体: { 质: '神', 特: '时空掌控', 稀: '传' },\n    }),\n    本尊: z\n        .object({\n        等级: z.coerce.number().transform(v => _.clamp(v, 1, 36)).prefault(1),\n        修为: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\n        灵根: z.string().prefault('五行杂灵根'),\n        体质: z.string().prefault('凡体'),\n        功法: z.string().prefault('无'),\n        本命兵器: z.string().prefault('无'),\n        神通列表: z.record(z.string().describe('神通名'), z.string().describe('神通描述')).prefault({}),\n        灵石: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\n        已活岁月: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\n        尝试突破: z.boolean().prefault(false),\n        行踪: z.object({\n            当前区域: z.string().prefault('未知之地'),\n            所属层级: z.string().prefault('地层'),\n            环境描述: z.string().prefault(''),\n            危险度: z.coerce.number().prefault(10),\n            可用通道: z.array(z.string()).prefault([]),\n            导航信息: z.string().prefault(''),\n        }).prefault({\n            当前区域: '未知之地',\n            所属层级: '地层',\n            环境描述: '',\n            危险度: 10,\n            可用通道: [],\n            导航信息: '',\n        }),\n        身份: z.object({\n            姓名: z.string().prefault('无名氏'),\n            宗门: z.string().prefault('散修'),\n            出身: z.string().prefault('凡人'),\n        }).prefault({\n            姓名: '无名氏',\n            宗门: '散修',\n            出身: '凡人',\n        }),\n        背包: z\n            .record(z.string().describe('物品名'), ItemSchema)\n            .prefault({})\n            .transform(data => _.pickBy(data, ({ 数量 }) => 数量 > 0)),\n        法宝: z\n            .record(z.string().describe('法宝名'), ItemSchema)\n            .prefault({})\n            .transform(data => _.pickBy(data, ({ 数量 }) => 数量 > 0)),\n        杂物袋: z\n            .record(z.string().describe('杂物名'), ItemSchema)\n            .prefault({})\n            .transform(data => _.pickBy(data, ({ 数量 }) => 数量 > 0)),\n    })\n        .prefault({\n        等级: 1,\n        修为: 0,\n        灵根: '五行杂灵根',\n        体质: '凡体',\n        功法: '无',\n        本命兵器: '无',\n        神通列表: {},\n        灵石: 0,\n        已活岁月: 0,\n        尝试突破: false,\n        行踪: {\n            当前区域: '未知之地',\n            所属层级: '地层',\n            环境描述: '',\n            危险度: 10,\n            可用通道: [],\n            导航信息: '',\n        },\n        身份: {\n            姓名: '无名氏',\n            宗门: '散修',\n            出身: '凡人',\n        },\n        背包: {},\n        法宝: {},\n        杂物袋: {},\n    })\n        .transform(data => {\n        const level = data.等级;\n        const 突破阈值 = REALM_THRESHOLDS[level - 1] ?? 100;\n        const 寿元上限 = REALM_LIFESPANS[level - 1] ?? 100;\n        const majorIdx = Math.floor((level - 1) / 4);\n        const minorIdx = (level - 1) % 4;\n        const 境界描述 = `${REALM_NAMES[majorIdx] ?? '练气'}${REALM_STAGES[minorIdx] ?? '初期'}`;\n        const 寿元状态 = `${data.已活岁月}/${寿元上限}`;\n        const 状态 = data.尝试突破 ? '突破中' : data.修为 >= 突破阈值 ? '瓶颈期' : '修炼中';\n        const 进度 = `${((data.修为 / 突破阈值) * 100).toFixed(1)}%`;\n        return {\n            ...data,\n            突破阈值,\n            寿元上限,\n            境界描述,\n            寿元状态,\n            状态,\n            进度,\n        };\n    }),\n    红颜角色库: z.record(z.string().describe('角色名'), z.object({\n        级: z.coerce.number().transform(v => _.clamp(v, 1, 36)),\n        根: z.string().describe('灵根'),\n        质: z.string().describe('体质'),\n        龄: z.string().describe('年龄'),\n        属: z.string().describe('所属'),\n        法: z.string().describe('功法'),\n        器: z.string().describe('本命兵器'),\n        通: z.array(z.string()).prefault([]),\n        型: z.enum(['核心', '重要', '次要']),\n    })).prefault({\n        许听雨: { 级: 28, 根: '水本源天', 质: '归墟神体', 龄: '外26实12000', 属: '归墟之主', 法: '万水归源先天', 器: '沧海遗珠先天', 通: ['归墟歌', '逆流虚妄', '寂灭海域', '万水同源'], 型: '核心' },\n        虞汐颜: { 级: 12, 根: '水阴阳异', 质: '双鱼体', 龄: '化形0年', 属: '{{user}}玉佩', 法: '双生天极/阴阳', 器: '双鱼佩本体', 通: ['枯木春', '夺命妆', '双鱼梦'], 型: '核心' },\n        白清弦: { 级: 29, 根: '金天根', 质: '剑体', 龄: '外30实1000+', 属: '散修剑宗师', 法: '剑意仙/天音天', 器: '清弦琴剑灵宝', 通: ['琴剑杀', '剑意歌', '万剑心'], 型: '核心' },\n        焰绯月: { 级: 12, 根: '离火根极', 质: '朱雀脉', 龄: '25', 属: '离火宫圣女', 法: '朱雀天', 器: '绯月弓法宝', 通: ['离火天', '朱雀身', '凤凰槃'], 型: '重要' },\n        幻千丝: { 级: 13, 根: '暗幻双根', 质: '梦魇体', 龄: '外20未知', 属: '散修幽冥', 法: '织梦天', 器: '千丝网灵宝', 通: ['织梦笼', '心魔境', '千丝缚'], 型: '重要' },\n        花想容: { 级: 8, 根: '木根', 质: '花妖体', 龄: '外12', 属: '建木宗', 法: '百花地', 器: '牡丹瓣', 通: ['花海域', '治愈粉', '魅惑香'], 型: '次要' },\n        敖清霜: { 级: 14, 根: '水龙双根', 质: '真龙脉', 龄: '外20实150', 属: '龙宫三公主', 法: '沧海天', 器: '龙鳞甲灵宝', 通: ['龙变化', '呼风雨', '龙威慑'], 型: '次要' },\n    }),\n    红颜: z\n        .record(z.string().describe('红颜名'), z\n        .object({\n        等级: z.coerce.number().transform(v => _.clamp(v, 1, 36)).prefault(1),\n        修为: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\n        灵根: z.string().prefault('五行杂灵根'),\n        体质: z.string().prefault('凡体'),\n        功法: z.string().prefault('无'),\n        本命兵器: z.string().prefault('无'),\n        神通列表: z.record(z.string().describe('神通名'), z.string().describe('神通描述')).prefault({}),\n        灵石: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\n        已活岁月: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\n        尝试突破: z.boolean().prefault(false),\n        好感度: z.coerce.number().transform(v => _.clamp(v, -100, 100)).prefault(0),\n        关系: z.string().prefault('陌生人'),\n        重要性: z.string().prefault('路人'),\n    })\n        .prefault({\n        等级: 1,\n        修为: 0,\n        灵根: '五行杂灵根',\n        体质: '凡体',\n        功法: '无',\n        本命兵器: '无',\n        神通列表: {},\n        灵石: 0,\n        已活岁月: 0,\n        尝试突破: false,\n        好感度: 0,\n        关系: '陌生人',\n        重要性: '路人',\n    })\n        .transform(data => {\n        const level = data.等级;\n        const 突破阈值 = REALM_THRESHOLDS[level - 1] ?? 100;\n        const 寿元上限 = REALM_LIFESPANS[level - 1] ?? 100;\n        const majorIdx = Math.floor((level - 1) / 4);\n        const minorIdx = (level - 1) % 4;\n        const 境界描述 = `${REALM_NAMES[majorIdx] ?? '练气'}${REALM_STAGES[minorIdx] ?? '初期'}`;\n        const 寿元状态 = `${data.已活岁月}/${寿元上限}`;\n        const 状态 = data.尝试突破 ? '突破中' : data.修为 >= 突破阈值 ? '瓶颈期' : '修炼中';\n        const 进度 = `${((data.修为 / 突破阈值) * 100).toFixed(1)}%`;\n        return {\n            ...data,\n            突破阈值,\n            寿元上限,\n            境界描述,\n            寿元状态,\n            状态,\n            进度,\n        };\n    }))\n        .prefault({}),\n    // NPC图鉴 - 极简版（保留向后兼容）\n    NPC图鉴: z.record(z.string().describe('NPC名'), z.object({\n        等级: z.coerce.number().transform(v => _.clamp(v, 1, 36)).prefault(1),\n        所在宗门: z.string().prefault('散修'),\n        备注: z.string().prefault(''),\n    })).prefault({}),\n    // 任务列表 - 极简版\n    任务列表: z.record(z.string().describe('任务名'), z.object({\n        类型: z.enum(['主线', '支线', '每日', '临危受命']),\n        目标: z.string(),\n        状态: z.enum(['进行中', '已完成', '已失败']).prefault('进行中'),\n    })).prefault({}),\n    // 声望系统 - 极简版\n    声望系统: z.record(z.string().describe('势力名'), z.object({\n        值: z.coerce.number().transform(v => _.clamp(v, -100, 100)),\n        关系: z.string(),\n    })).prefault({}),\n});\n// 配置常量\nexport const CONFIG = {\n    REALMS: {\n        MAJOR: REALM_NAMES,\n        MINOR: REALM_STAGES,\n    },\n    ELEMENTS: {\n        火: { effect: '灼烧', visual: '烈焰', nature: '爆裂', color: '#ff4444' },\n        水: { effect: '缠绕', visual: '激流', nature: '柔韧', color: '#4488ff' },\n        冰: { effect: '冻结', visual: '寒霜', nature: '极寒', color: '#88ddff' },\n        雷: { effect: '麻痹', visual: '紫电', nature: '狂暴', color: '#aa44ff' },\n        风: { effect: '切割', visual: '罡风', nature: '无形', color: '#88ff88' },\n        土: { effect: '镇压', visual: '岩铠', nature: '厚重', color: '#aa8844' },\n        木: { effect: '寄生', visual: '藤蔓', nature: '生生不息', color: '#44aa44' },\n        金: { effect: '穿透', visual: '锐金', nature: '锋利', color: '#ffdd44' },\n        暗: { effect: '腐蚀', visual: '黑雾', nature: '诡谲', color: '#442244' },\n        光: { effect: '净化', visual: '圣辉', nature: '神圣', color: '#ffffaa' },\n        混沌: { effect: '湮灭', visual: '灰光', nature: '虚无', color: '#888888' },\n    },\n};\n// 获取灵根元素颜色\nexport function getRootColor(root) {\n    for (const [elem, data] of Object.entries(CONFIG.ELEMENTS)) {\n        if (root.includes(elem)) {\n            return data.color;\n        }\n    }\n    return '#aaaaaa'; // 默认灰色\n}\n// 获取境界等级颜色\nexport function getRealmColor(level) {\n    const majorIdx = Math.floor((level - 1) / 4);\n    const colors = [\n        '#888888', // 练气 - 灰色\n        '#44aa44', // 筑基 - 绿色\n        '#4488ff', // 金丹 - 蓝色\n        '#aa44ff', // 元婴 - 紫色\n        '#ff4444', // 化神 - 红色\n        '#ffaa00', // 炼虚 - 橙色\n        '#ffdd44', // 合体 - 金色\n        '#ffffff', // 大乘 - 白色\n        '#ff88ff', // 渡劫 - 粉色\n    ];\n    return colors[majorIdx] || '#888888';\n}\n// 获取危险度颜色\nexport function getDangerColor(danger) {\n    if (danger >= 90)\n        return '#ff0000';\n    if (danger >= 70)\n        return '#ff4400';\n    if (danger >= 50)\n        return '#ff8800';\n    if (danger >= 30)\n        return '#ffcc00';\n    return '#44aa44';\n}\n","// ============================================================================\n// 动态世界书管理脚本 - 根据上下文智能启用/禁用世界书条目\n//\n// 功能：根据当前区域、境界、人物等上下文自动启用/禁用世界书条目，节省 token\n// ============================================================================\n\nimport { Schema } from '../踏月寻仙-测试版/schema';\n\n// ============================================================================\n// 配置项\n// ============================================================================\n\nconst CONFIG = {\n    // 要管理的世界书名称（修改为你的世界书名）\n    WORLDBOOK_NAME: 'current',  // 'current' 表示当前角色卡的主世界书\n\n    // 是否启用调试日志\n    DEBUG: true,  // 临时开启调试日志以排查问题\n\n    // 上下文窗口（检查最近几条消息）\n    CONTEXT_WINDOW: 2,  // 只检查最近2条消息，更精准\n\n    // 策略模式：\n    // - 'aggressive': 激进模式 - 用户输入时开启，AI回复后立即关闭大部分（最省token）\n    // - 'balanced': 平衡模式 - 用户输入时开启，AI回复后保留核心条目（推荐）\n    // - 'conservative': 保守模式 - 始终保持相关条目开启（最安全但最费token）\n    STRATEGY: 'balanced' as 'aggressive' | 'balanced' | 'conservative',\n\n    // MVU 初始化最大等待时间(毫秒)\n    MVU_INIT_TIMEOUT: 3000,\n\n    // 处理间隔时间(毫秒) - 避免频繁触发\n    DEBOUNCE_DELAY: 500,\n\n    // 角色别名映射：主名称 -> 别名数组\n    // 用于处理一体双魂、昵称等特殊情况\n    // 示例：'虞汐颜': ['虞汐', '虞颜'] - 提到虞汐或虞颜都会匹配虞汐颜\n    CHARACTER_ALIASES: {\n        '虞汐颜': ['虞汐', '虞颜'],\n        // 可以继续添加其他角色的别名\n        // '白清弦': ['白师姐', '清弦师姐'],\n    } as Record<string, string[]>,\n\n    // 在 AI 回复后保持开启的条目类型（仅在 balanced 模式下生效）\n    KEEP_ENABLED_AFTER_REPLY: [\n        /^\\[系统\\]/,\n        /^\\[mvu_update\\]/,\n        /^\\[mvu\\]变量列表$/,\n        /^\\[红颜索引\\]$/,\n        /^\\[地图\\]/,  // 保持当前地图开启\n        /^\\[境界\\]/,  // 保持当前境界开启\n    ],\n};\n\n// ============================================================================\n// 规则定义 - 根据你的角色卡自定义这些规则\n// ============================================================================\n\ninterface WorldbookRule {\n    /** 条目名称匹配模式 */\n    entryPattern: string | RegExp;\n    /** 启用条件（context: 上下文, entryName: 条目名称） */\n    shouldEnable: (context: Context, entryName?: string) => boolean;\n    /** 优先级（数字越大越优先，默认 0） */\n    priority?: number;\n}\n\ninterface Context {\n    /** 当前所在区域 */\n    currentRegion: string;\n    /** 最近消息内容 */\n    recentMessages: string[];\n    /** MVU 变量数据 */\n    mvuData: ReturnType<typeof Schema.parse> | null;\n}\n\nconst RULES: WorldbookRule[] = [\n    // ============================================================================\n    // 系统设定 - 始终启用（蓝灯）\n    // ============================================================================\n    {\n        entryPattern: /^\\[系统\\]/,\n        shouldEnable: () => true,\n        priority: 100,\n    },\n    {\n        entryPattern: /^\\[mvu_update\\]/,\n        shouldEnable: () => true,\n        priority: 100,\n    },\n    {\n        entryPattern: /^\\[mvu\\]变量列表$/,\n        shouldEnable: () => true,\n        priority: 100,\n    },\n\n    // ============================================================================\n    // 地图相关 - 精确匹配当前区域\n    // ============================================================================\n    {\n        entryPattern: /^\\[地图\\]\\s*(.+)$/,\n        shouldEnable: (ctx, entryName) => {\n            if (!entryName || !ctx.currentRegion) return false;\n            const match = entryName.match(/^\\[地图\\]\\s*(.+)$/);\n            if (!match) return false;\n            const regionName = match[1].trim();\n\n            // 精确匹配：当前区域必须完全等于地图名称\n            const isMatch = ctx.currentRegion === regionName;\n\n            if (CONFIG.DEBUG && isMatch) {\n                console.log(`[动态世界书] 地图匹配成功: ${regionName} === ${ctx.currentRegion}`);\n            }\n\n            return isMatch;\n        },\n        priority: 10,\n    },\n\n    // ============================================================================\n    // 角色相关 - 精确匹配角色名和阶段（支持别名）\n    // ============================================================================\n    // 1. 带阶段的角色条目（如：[角色] 凌寒镜 - 心动期）\n    {\n        entryPattern: /^\\[角色\\]\\s*(.+?)\\s*-\\s*(陌生期|好感期|心动期|确认期|深爱期)$/,\n        shouldEnable: (ctx, entryName) => {\n            if (!entryName) return false;\n            const match = entryName.match(/^\\[角色\\]\\s*(.+?)\\s*-\\s*(陌生期|好感期|心动期|确认期|深爱期)$/);\n            if (!match) return false;\n\n            const characterName = match[1].trim();\n            const stageName = match[2];\n\n            // 检查角色是否在红颜列表中\n            const hongyanData = ctx.mvuData?.红颜?.[characterName];\n            if (!hongyanData) {\n                if (CONFIG.DEBUG) {\n                    console.log(`[动态世界书] 角色不在红颜列表中: ${characterName}`);\n                }\n                return false;\n            }\n\n            // 【修复】如果没有消息（开局），直接根据好感度阶段开启，不检查提及\n            const hasMessages = ctx.recentMessages.length > 0;\n\n            // 如果有消息，需要检查是否被提及\n            if (hasMessages) {\n                // 获取角色的所有可能名称（主名称 + 别名）\n                const allNames = [characterName];\n                if (CONFIG.CHARACTER_ALIASES[characterName]) {\n                    allNames.push(...CONFIG.CHARACTER_ALIASES[characterName]);\n                }\n\n                // 检查是否提到任何一个名称\n                let isMentioned = false;\n                for (const name of allNames) {\n                    const escaped = name.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n                    const nameRegex = new RegExp(\n                        `(?:^|[^\\\\p{Script=Han}\\\\w])(${escaped})(?:[^\\\\p{Script=Han}\\\\w]|$)`,\n                        'u'\n                    );\n                    if (ctx.recentMessages.some(msg => nameRegex.test(msg))) {\n                        isMentioned = true;\n                        if (CONFIG.DEBUG) {\n                            console.log(`[动态世界书] 匹配到别名: ${name} -> ${characterName}`);\n                        }\n                        break;\n                    }\n                }\n\n                if (!isMentioned) {\n                    if (CONFIG.DEBUG) {\n                        console.log(`[动态世界书] 角色未在近期消息中提及: ${characterName} (含别名)`);\n                    }\n                    return false;\n                }\n            } else {\n                if (CONFIG.DEBUG) {\n                    console.log(`[动态世界书] 开局无消息，直接根据好感度阶段开启: ${characterName}`);\n                }\n            }\n\n            // 好感度阶段精确映射\n            const favorStages: Record<string, [number, number]> = {\n                '陌生期': [-100, 20],\n                '好感期': [21, 40],\n                '心动期': [41, 60],\n                '确认期': [61, 80],\n                '深爱期': [81, 100],\n            };\n\n            const range = favorStages[stageName];\n            if (!range) return false;\n\n            const favor = hongyanData.好感度 ?? 0;\n            const isInRange = favor >= range[0] && favor <= range[1];\n\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 角色阶段匹配: ${characterName} - ${stageName}, 好感度=${favor}, 范围=[${range[0]}, ${range[1]}], 匹配=${isInRange}`);\n            }\n\n            return isInRange;\n        },\n        priority: 9,\n    },\n\n    // 2. 基础角色条目（如：[角色] 凌寒镜）- 支持别名匹配，开局时根据红颜列表开启\n    {\n        entryPattern: /^\\[角色\\]\\s*([^-]+)$/,\n        shouldEnable: (ctx, entryName) => {\n            if (!entryName) return false;\n            const match = entryName.match(/^\\[角色\\]\\s*([^-]+)$/);\n            if (!match) return false;\n            const characterName = match[1].trim();\n\n            // 【调试】检查上下文消息\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 🔍 检查角色: ${characterName}`);\n                console.log(`[动态世界书] 🔍 最近消息 (${ctx.recentMessages.length}条):`, ctx.recentMessages);\n            }\n\n            // 【关键修复】检查这是不是某个角色的别名条目\n            // 如果是别名条目，找到它对应的主角色名\n            let mainCharacterName = characterName;\n            let isAliasEntry = false;\n            \n            for (const [mainName, aliases] of Object.entries(CONFIG.CHARACTER_ALIASES)) {\n                if (aliases.includes(characterName)) {\n                    mainCharacterName = mainName;\n                    isAliasEntry = true;\n                    if (CONFIG.DEBUG) {\n                        console.log(`[动态世界书] 🔗 识别到别名条目: ${characterName} -> 主角色: ${mainName}`);\n                    }\n                    break;\n                }\n            }\n\n            // 【关键修复】开局时直接根据红颜列表开启（使用主角色名检查）\n            const hasMessages = ctx.recentMessages.length > 0;\n            \n            if (!hasMessages) {\n                // 开局：检查主角色是否在红颜列表中\n                const isInHongyan = ctx.mvuData?.红颜?.[mainCharacterName] !== undefined;\n                \n                if (CONFIG.DEBUG) {\n                    if (isInHongyan) {\n                        console.log(`[动态世界书] ✅ 开局-应该开启: ${characterName}${isAliasEntry ? ` (主角色: ${mainCharacterName})` : ''} (在红颜列表中)`);\n                    } else {\n                        console.log(`[动态世界书] ❌ 开局-不应开启: ${characterName}${isAliasEntry ? ` (主角色: ${mainCharacterName})` : ''} (不在红颜列表中)`);\n                    }\n                }\n                \n                return isInHongyan;\n            }\n\n            // 有消息：检查提及次数\n            // 如果这是别名条目，检查这个别名是否被提及\n            // 如果这是主条目，检查主名称或任何别名是否被提及\n            let checkNames: string[];\n            \n            if (isAliasEntry) {\n                // 别名条目：只检查这个别名本身\n                checkNames = [characterName];\n            } else {\n                // 主条目：检查主名称 + 所有别名\n                checkNames = [characterName];\n                if (CONFIG.CHARACTER_ALIASES[characterName]) {\n                    checkNames.push(...CONFIG.CHARACTER_ALIASES[characterName]);\n                }\n            }\n\n            // 累计所有名称的提及次数\n            let mentionCount = 0;\n            const mentionDetails: string[] = [];\n            \n            for (const name of checkNames) {\n                const escaped = name.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n                const nameRegex = new RegExp(\n                    `(?:^|[^\\\\p{Script=Han}\\\\w])(${escaped})(?:[^\\\\p{Script=Han}\\\\w]|$)`,\n                    'u'\n                );\n                const count = ctx.recentMessages.filter(msg => nameRegex.test(msg)).length;\n                \n                if (count > 0) {\n                    mentionCount += count;\n                    mentionDetails.push(`${name}(${count}次)`);\n                    \n                    if (CONFIG.DEBUG) {\n                        console.log(`[动态世界书] 🔍 匹配到: ${name}, 正则=${nameRegex}, 次数=${count}`);\n                    }\n                }\n            }\n\n            // 【严格】必须在最近消息中被明确提及至少1次才开启\n            const shouldEnable = mentionCount >= 1;\n\n            if (CONFIG.DEBUG) {\n                const typeInfo = isAliasEntry ? ` [别名条目 -> ${mainCharacterName}]` : '';\n                const aliasInfo = !isAliasEntry && CONFIG.CHARACTER_ALIASES[characterName]\n                    ? ` [别名: ${CONFIG.CHARACTER_ALIASES[characterName].join(', ')}]`\n                    : '';\n                const detailInfo = mentionDetails.length > 0 ? ` 提及详情: ${mentionDetails.join(', ')}` : '';\n                \n                if (shouldEnable) {\n                    console.log(`[动态世界书] ✅ 应该开启: ${characterName}${typeInfo}${aliasInfo}, 累计提及=${mentionCount}次${detailInfo}`);\n                } else {\n                    console.log(`[动态世界书] ❌ 不应开启: ${characterName}${typeInfo}${aliasInfo}, 累计提及=${mentionCount}次 (需≥1次)`);\n                }\n            }\n\n            return shouldEnable;\n        },\n        priority: 8,\n    },\n\n    // ============================================================================\n    // 境界相关 - 精确匹配当前境界等级\n    // ============================================================================\n    {\n        entryPattern: /^\\[境界\\]\\s*(.+)$/,\n        shouldEnable: (ctx, entryName) => {\n            if (!entryName) return false;\n            const match = entryName.match(/^\\[境界\\]\\s*(.+)$/);\n            if (!match) return false;\n            const realmName = match[1].trim();\n            const level = ctx.mvuData?.本尊?.等级 ?? 1;\n\n            // 境界等级映射（根据踏月寻仙设定，与 schema.ts 保持一致）\n            const realmRanges: Record<string, [number, number]> = {\n                '练气': [1, 4],\n                '筑基': [5, 8],\n                '金丹': [9, 12],\n                '元婴': [13, 16],\n                '化神': [17, 20],\n                '炼虚': [21, 24],  // 修正：schema 中是\"炼虚\"而非\"合体\"\n                '合体': [25, 28],\n                '大乘': [29, 32],\n                '渡劫': [33, 36],\n            };\n\n            const range = realmRanges[realmName];\n            if (!range) {\n                if (CONFIG.DEBUG) {\n                    console.log(`[动态世界书] 未知境界名称: ${realmName}`);\n                }\n                return false;\n            }\n\n            const isInRange = level >= range[0] && level <= range[1];\n\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 境界匹配: ${realmName}, 等级=${level}, 范围=[${range[0]}, ${range[1]}], 匹配=${isInRange}`);\n            }\n\n            return isInRange;\n        },\n        priority: 7,\n    },\n\n    // ============================================================================\n    // 事件相关 - 精确匹配事件关键词\n    // ============================================================================\n    {\n        entryPattern: /^\\[事件\\]\\s*(.+)$/,\n        shouldEnable: (ctx, entryName) => {\n            if (!entryName) return false;\n            const match = entryName.match(/^\\[事件\\]\\s*(.+)$/);\n            if (!match) return false;\n            const eventName = match[1].trim();\n\n            // 精确匹配：事件名必须作为独立词出现\n            const escaped = eventName.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n            const eventRegex = new RegExp(\n                `(?:^|[\\\\s\\\\p{P}，。！？；：\"\"''「」『』【】《》〈〉（）])(${escaped})(?:[\\\\s\\\\p{P}，。！？；：\"\"''「」『』【】《》〈〉（）]|$)`,\n                'u'\n            );\n\n            const isMentioned = ctx.recentMessages.some(msg => eventRegex.test(msg));\n\n            if (CONFIG.DEBUG && isMentioned) {\n                console.log(`[动态世界书] 事件匹配成功: ${eventName}`);\n            }\n\n            return isMentioned;\n        },\n        priority: 3,\n    },\n\n    // ============================================================================\n    // 红颜索引 - 始终启用\n    // ============================================================================\n    {\n        entryPattern: /^\\[红颜索引\\]$/,\n        shouldEnable: () => true,\n        priority: 100,\n    },\n\n    // ============================================================================\n    // 物品/法宝/功法/势力/地点库 - 精确匹配条目\n    // ============================================================================\n    {\n        entryPattern: /^\\[(物品|法宝|功法|势力|地点|灵根|体质)\\]\\s*(.+)$/,\n        shouldEnable: (ctx, entryName) => {\n            if (!entryName) return false;\n            const match = entryName.match(/^\\[(物品|法宝|功法|势力|地点|灵根|体质)\\]\\s*(.+)$/);\n            if (!match) return false;\n\n            const category = match[1];\n            const itemName = match[2].trim();\n\n            // 精确匹配：物品名必须在消息中完整出现\n            const escaped = itemName.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n            const itemRegex = new RegExp(escaped, 'u');\n\n            // 检查最近消息中是否提到\n            const mentionCount = ctx.recentMessages.filter(msg => itemRegex.test(msg)).length;\n\n            // 至少提到2次才启用（避免误触发）\n            const shouldEnable = mentionCount >= 2;\n\n            if (CONFIG.DEBUG && mentionCount > 0) {\n                console.log(`[动态世界书] ${category}匹配: ${itemName}, 提及次数=${mentionCount}, 启用=${shouldEnable}`);\n            }\n\n            return shouldEnable;\n        },\n        priority: 5,\n    },\n];\n\n// ============================================================================\n// 核心逻辑\n// ============================================================================\n\nlet isProcessing = false;\nlet lastProcessTime = 0;\n\n/**\n * 安全地等待 MVU 初始化,带超时机制\n */\nasync function waitForMvu(): Promise<boolean> {\n    try {\n        // 创建超时 Promise\n        const timeoutPromise = new Promise<boolean>((resolve) => {\n            setTimeout(() => resolve(false), CONFIG.MVU_INIT_TIMEOUT);\n        });\n\n        // 创建初始化 Promise\n        const initPromise = (async () => {\n            await waitGlobalInitialized('Mvu');\n            return true;\n        })();\n\n        // 竞速,返回先完成的\n        return await Promise.race([initPromise, timeoutPromise]);\n    } catch (e) {\n        console.warn('[动态世界书] MVU 初始化等待失败', e);\n        return false;\n    }\n}\n\nasync function getContext(): Promise<Context | null> {\n    // 安全地等待 MVU 初始化\n    const mvuReady = await waitForMvu();\n    if (!mvuReady) {\n        if (CONFIG.DEBUG) {\n            console.log('[动态世界书] MVU 未就绪,跳过本次更新');\n        }\n        return null;\n    }\n\n    // 获取最近的消息（安全地获取，避免消息数不足导致错误）\n    let recentMessages: string[] = [];\n    try {\n        // 获取最后消息 ID\n        const lastMessageId = getLastMessageId();\n        if (lastMessageId >= 0) {\n            // 有消息，获取所有消息\n            const allMessages = getChatMessages(`0-${lastMessageId}`);\n            if (allMessages && allMessages.length > 0) {\n                // 取最近的 N 条消息\n                recentMessages = allMessages\n                    .slice(-CONFIG.CONTEXT_WINDOW)\n                    .map(m => {\n                        let content = m.message || '';\n                        \n                        // 【修复】移除不应作为剧情内容的各种标记和代码块\n                        // 1. 移除动态世界书的调试日志（如：[动态世界书] 检查角色: xxx）\n                        content = content.replace(/\\[动态世界书\\][^\\n]*/g, '');\n                        \n                        // 2. 移除 MVU 更新日志（如：【匹配开启: xxx】、【不应开启: xxx】等）\n                        content = content.replace(/【[^】]*】/g, '');\n                        \n                        // 3. 移除 UpdateVariable 标签块（包含变量初始化数据，不是剧情内容）\n                        content = content.replace(/<UpdateVariable>[\\s\\S]*?<\\/UpdateVariable>/g, '');\n                        \n                        // 4. 移除 mvu 更新命令块（如：```mvu_update ... ```）\n                        content = content.replace(/```mvu_update[\\s\\S]*?```/g, '');\n                        \n                        // 5. 移除其他代码块（但保留正文）\n                        content = content.replace(/```[\\s\\S]*?```/g, '');\n                        \n                        return content.trim();\n                    })\n                    .filter(msg => msg.length > 0); // 过滤掉空消息\n                \n                if (CONFIG.DEBUG) {\n                    console.log(`[动态世界书] 🔍 过滤后的消息内容:`, recentMessages);\n                }\n            }\n        }\n    } catch (e) {\n        // 获取失败，使用空数组\n        if (CONFIG.DEBUG) {\n            console.warn('[动态世界书] 获取消息失败', e);\n        }\n        recentMessages = [];\n    }\n\n    // 获取 MVU 数据\n    let mvuData: ReturnType<typeof Schema.parse> | null = null;\n    try {\n        // 先尝试从最后一楼获取\n        const lastMessageId = getLastMessageId();\n        if (lastMessageId >= 0) {\n            const variables = getVariables({ type: 'message', message_id: -1 });\n            const statData = _.get(variables, 'stat_data', null);\n            if (statData) {\n                mvuData = Schema.parse(statData);\n            }\n        }\n\n        // 如果没有获取到,返回 null 表示数据未就绪\n        if (!mvuData) {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] MVU 数据未就绪,跳过本次更新');\n            }\n            return null;\n        }\n    } catch (e) {\n        console.warn('[动态世界书] 获取 MVU 数据失败', e);\n        return null;\n    }\n\n    const currentRegion = mvuData?.本尊?.行踪?.当前区域 ?? '未知';\n\n    if (CONFIG.DEBUG) {\n        console.log(`[动态世界书] 上下文: 区域=\"${currentRegion}\", 消息数=${recentMessages.length}`);\n    }\n\n    return {\n        currentRegion,\n        recentMessages,\n        mvuData,\n    };\n}\n\n/**\n * 更新世界书条目\n * @param mode 'enable' - 用户输入前启用相关条目; 'disable' - AI回复后禁用非核心条目\n */\nasync function updateWorldbookEntries(mode: 'enable' | 'disable' = 'enable') {\n    // 防抖处理 - 避免频繁触发\n    const now = Date.now();\n    if (now - lastProcessTime < CONFIG.DEBOUNCE_DELAY) {\n        if (CONFIG.DEBUG) {\n            console.log('[动态世界书] 触发过于频繁,跳过本次更新');\n        }\n        return;\n    }\n    lastProcessTime = now;\n\n    if (isProcessing) {\n        if (CONFIG.DEBUG) {\n            console.log('[动态世界书] 正在处理中，跳过本次更新');\n        }\n        return;\n    }\n    isProcessing = true;\n\n    try {\n        const context = await getContext();\n\n        // 如果上下文获取失败(MVU未初始化),直接返回,不报错\n        if (!context) {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 上下文未就绪,跳过本次更新');\n            }\n            return;\n        }\n\n        // 获取世界书名称\n        let worldbookName = CONFIG.WORLDBOOK_NAME;\n        if (worldbookName === 'current') {\n            const charWorldbooks = getCharWorldbookNames('current');\n            worldbookName = charWorldbooks.primary || '';\n            if (!worldbookName) {\n                console.warn('[动态世界书] 当前角色卡没有绑定主世界书');\n                return;\n            }\n        }\n\n        let enabledCount = 0;\n        let disabledCount = 0;\n        let totalProcessed = 0;\n\n        // 按优先级排序规则\n        const sortedRules = [...RULES].sort((a, b) => (b.priority ?? 0) - (a.priority ?? 0));\n\n        // 使用 updateWorldbookWith 更新世界书\n        await updateWorldbookWith(worldbookName, worldbook => {\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 开始处理世界书 [${mode}模式]: ${worldbookName}, 共 ${worldbook.length} 个条目`);\n                console.log(`[动态世界书] 当前上下文: 区域=\"${context.currentRegion}\", 等级=${context.mvuData?.本尊?.等级 ?? '未知'}, 消息数=${context.recentMessages.length}`);\n            }\n\n            for (const entry of worldbook) {\n                // 【关键修改】不跳过未启用的条目，因为我们要管理所有条目\n                // 但条目本身必须是 enabled: true 才能被酒馆加载\n                if (!entry.enabled) {\n                    continue;\n                }\n\n                const entryName = entry.name || '';\n                if (!entryName) {\n                    if (CONFIG.DEBUG) {\n                        console.warn('[动态世界书] 发现无名称条目，跳过');\n                    }\n                    continue;\n                }\n\n                let matchedRule: WorldbookRule | null = null;\n\n                // 查找匹配的规则（按优先级从高到低）\n                for (const rule of sortedRules) {\n                    const matches =\n                        typeof rule.entryPattern === 'string'\n                            ? entryName.includes(rule.entryPattern)\n                            : rule.entryPattern.test(entryName);\n\n                    if (matches) {\n                        matchedRule = rule;\n                        break; // 找到第一个匹配的规则就停止\n                    }\n                }\n\n                // 【关键修改】如果没有匹配的规则，说明这个条目不受动态管理\n                // 对于不受管理的条目，保持其原有状态\n                if (!matchedRule) {\n                    continue;\n                }\n\n                const currentType = entry.strategy.type;\n\n                // 根据模式决定操作\n                if (mode === 'enable') {\n                    // 启用模式：根据规则评估是否应该启用\n                    let shouldBeConstant = false;\n                    try {\n                        shouldBeConstant = matchedRule.shouldEnable(context, entryName);\n                    } catch (e) {\n                        console.error(`[动态世界书] 评估条目 \"${entryName}\" 时出错:`, e);\n                        continue;\n                    }\n\n                    // 【关键修复】始终检查核心条目，避免误关闭\n                    const isAlwaysOn = /^\\[系统\\]/.test(entryName) ||\n                        /^\\[mvu_update\\]/.test(entryName) ||\n                        /^\\[mvu\\]变量列表$/.test(entryName) ||\n                        /^\\[红颜索引\\]$/.test(entryName);\n\n                    // 精准控制：符合条件的开启，不符合条件的关闭\n                    if (shouldBeConstant && currentType !== 'constant') {\n                        // 绿灯 → 蓝灯\n                        entry.strategy.type = 'constant';\n                        enabledCount++;\n                        totalProcessed++;\n                        if (CONFIG.DEBUG) {\n                            console.log(`[动态世界书] ✅ 开启(绿→蓝): ${entryName}`);\n                        }\n                    } else if (!shouldBeConstant && currentType === 'constant' && !isAlwaysOn) {\n                        // 蓝灯 → 绿灯（但保留核心条目）\n                        entry.strategy.type = 'selective';\n                        disabledCount++;\n                        totalProcessed++;\n                        if (CONFIG.DEBUG) {\n                            console.log(`[动态世界书] ⚠️ 关闭(蓝→绿): ${entryName}`);\n                        }\n                    }\n                } else {\n                    // 禁用模式：根据策略决定是否保留\n                    if (currentType === 'constant') {\n                        let shouldKeepEnabled = false;\n\n                        // 根据策略决定是否保留\n                        if (CONFIG.STRATEGY === 'conservative') {\n                            // 保守模式：保持所有已启用的条目\n                            shouldKeepEnabled = true;\n                        } else if (CONFIG.STRATEGY === 'balanced') {\n                            // 平衡模式：保留核心条目\n                            shouldKeepEnabled = CONFIG.KEEP_ENABLED_AFTER_REPLY.some(pattern =>\n                                pattern.test(entryName)\n                            );\n                        } else {\n                            // 激进模式：只保留最核心的系统条目\n                            shouldKeepEnabled = /^\\[系统\\]/.test(entryName) ||\n                                /^\\[mvu_update\\]/.test(entryName) ||\n                                /^\\[mvu\\]变量列表$/.test(entryName);\n                        }\n\n                        if (!shouldKeepEnabled) {\n                            entry.strategy.type = 'selective';\n                            disabledCount++;\n                            totalProcessed++;\n                            if (CONFIG.DEBUG) {\n                                console.log(`[动态世界书] ⚠️ 改为绿灯: ${entryName}`);\n                            }\n                        }\n                    }\n                }\n            }\n\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 处理完成 [${mode}模式]，修改 ${totalProcessed} 个条目 (启用 ${enabledCount} 个, 禁用 ${disabledCount} 个)`);\n            }\n\n            return worldbook;\n        });\n\n        // 输出更新摘要\n        if (enabledCount > 0 || disabledCount > 0) {\n            const modeText = mode === 'enable' ? '准备AI回复' : 'AI回复完成';\n            const message = `${modeText}: 启用 ${enabledCount} 个, 禁用 ${disabledCount} 个`;\n            console.info(`[动态世界书] ${message}`);\n            if (CONFIG.DEBUG) {\n                toastr.info(message, '动态世界书');\n            }\n        } else {\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 本次无需更新条目状态 [${mode}模式]`);\n            }\n        }\n    } catch (e) {\n        // 只在非初始化错误时报告\n        if (!(e instanceof Error && e.message.includes('MVU')) &&\n            !(e instanceof Error && e.message.includes('初始化'))) {\n            console.error('[动态世界书] 更新失败', e);\n            if (CONFIG.DEBUG) {\n                toastr.error(`更新失败: ${e instanceof Error ? e.message : '未知错误'}`, '动态世界书');\n            }\n        } else {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] MVU 相关错误,可能是正在初始化,跳过');\n            }\n        }\n    } finally {\n        isProcessing = false;\n    }\n}\n\n// ============================================================================\n// 初始化\n// ============================================================================\n\n$(() => {\n    errorCatched(async () => {\n        console.info('[动态世界书] 脚本已加载');\n        console.info(`[动态世界书] 当前策略: ${CONFIG.STRATEGY}`);\n\n        // 安全地等待 MVU 初始化\n        const mvuReady = await waitForMvu();\n        if (mvuReady) {\n            console.info('[动态世界书] MVU 框架已初始化');\n\n            // 延迟初始检查,确保所有数据都已就绪\n            await new Promise(resolve => setTimeout(resolve, 1500));\n            await updateWorldbookEntries('enable');\n            console.info('[动态世界书] 初始化检查完成');\n        } else {\n            console.warn('[动态世界书] MVU 初始化超时,将在后续事件中尝试');\n        }\n\n        // ========================================================================\n        // 核心逻辑：用户输入前启用，AI回复后禁用\n        // ========================================================================\n\n        // 监听用户发送消息 - 在用户输入后、AI 回复前启用相关条目\n        eventOn(tavern_events.MESSAGE_SENT, async () => {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 🟢 用户发送消息，启用相关世界书条目');\n            }\n            await updateWorldbookEntries('enable');\n        });\n\n        // 监听重roll（切换swipe）- 相当于重新生成，需要启用相关条目\n        eventOn(tavern_events.MESSAGE_SWIPED, async (message_id: number) => {\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 🔄 消息 #${message_id} 重roll，启用相关世界书条目`);\n            }\n            // 【修复】延迟等待消息内容完全更新后再处理\n            // MESSAGE_SWIPED 事件会在消息切换时立即触发，但消息内容可能还没更新完成\n            await new Promise(resolve => setTimeout(resolve, 300));\n            await updateWorldbookEntries('enable');\n        });\n\n        // 监听 AI 消息接收完成 - AI 回复后禁用非核心条目以节省 token\n        eventOn(tavern_events.MESSAGE_RECEIVED, async () => {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 🔴 AI 回复完成，禁用非核心世界书条目');\n            }\n            // 延迟一小段时间，确保消息完全接收\n            await new Promise(resolve => setTimeout(resolve, 200));\n            await updateWorldbookEntries('disable');\n        });\n\n        // ========================================================================\n        // 辅助逻辑：聊天切换、变量更新等场景\n        // ========================================================================\n\n        // 监听聊天切换事件（新开聊天或切换聊天时触发）\n        eventOn(tavern_events.CHAT_CHANGED, async () => {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 触发事件: CHAT_CHANGED');\n            }\n            // 延迟时间增加到2秒,确保聊天和MVU完全加载\n            await new Promise(resolve => setTimeout(resolve, 2000));\n            await updateWorldbookEntries('enable');\n        });\n\n        // 监听新建聊天事件\n        eventOn(tavern_events.CHAT_CREATED, async () => {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 触发事件: CHAT_CREATED');\n            }\n            // 延迟时间增加到2秒,确保聊天和MVU完全初始化\n            await new Promise(resolve => setTimeout(resolve, 2000));\n            await updateWorldbookEntries('enable');\n        });\n\n        // 监听角色页面加载完成事件（切换角色时触发）\n        eventOn(tavern_events.CHARACTER_PAGE_LOADED, async () => {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 触发事件: CHARACTER_PAGE_LOADED');\n            }\n            // 延迟时间增加到2秒,确保角色和MVU完全加载\n            await new Promise(resolve => setTimeout(resolve, 2000));\n            await updateWorldbookEntries('enable');\n        });\n\n        // 监听 MVU 变量更新 - 变量更新后重新评估需要启用的条目\n        // 注意: 这个事件会频繁触发,因此使用防抖机制\n        // 只有在 MVU 初始化成功时才注册此监听器\n        if (mvuReady) {\n            eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, async () => {\n                if (CONFIG.DEBUG) {\n                    console.log('[动态世界书] 触发事件: VARIABLE_UPDATE_ENDED');\n                }\n                // 延迟100ms,避免在变量更新期间触发\n                await new Promise(resolve => setTimeout(resolve, 100));\n                await updateWorldbookEntries('enable');\n            });\n        }\n\n        const strategyText =\n            CONFIG.STRATEGY === 'aggressive' ? '激进模式（最省token）' :\n                CONFIG.STRATEGY === 'balanced' ? '平衡模式（推荐）' :\n                    '保守模式（最安全）';\n\n        console.info(`[动态世界书] 监听器已设置，策略：${strategyText}`);\n        if (mvuReady) {\n            toastr.success(`动态世界书已启用 - ${strategyText}`, '踏月寻仙');\n        } else {\n            toastr.info(`动态世界书已加载，等待MVU初始化...`, '踏月寻仙');\n        }\n    })();\n});"],"names":["z","REALM_NAMES","REALM_STAGES","REALM_THRESHOLDS","REALM_LIFESPANS","ItemSchema","object","string","prefault","coerce","number","transform","v","Math","max","FactionSchema","describe","enum","TechniqueSchema","TreasureSchema","data","LocationSchema","_","clamp","array","SpiritRootSchema","PhysiqueSchema","Schema","record","layer","danger","desc","connections","boolean","pickBy","level","majorIdx","floor","toFixed","WORLDBOOK_NAME","DEBUG","CONTEXT_WINDOW","STRATEGY","MVU_INIT_TIMEOUT","DEBOUNCE_DELAY","CHARACTER_ALIASES","KEEP_ENABLED_AFTER_REPLY","RULES","entryPattern","shouldEnable","priority","ctx","entryName","currentRegion","match","regionName","trim","isMatch","console","log","characterName","stageName","hongyanData","mvuData","recentMessages","length","allNames","push","isMentioned","name","escaped","replace","nameRegex","RegExp","some","msg","test","range","favor","isInRange","mainCharacterName","isAliasEntry","mainName","aliases","Object","entries","includes","isInHongyan","undefined","checkNames","mentionCount","mentionDetails","count","filter","typeInfo","aliasInfo","join","detailInfo","realmName","eventName","eventRegex","category","itemName","itemRegex","isProcessing","lastProcessTime","async","waitForMvu","timeoutPromise","Promise","resolve","setTimeout","initPromise","waitGlobalInitialized","race","e","warn","updateWorldbookEntries","mode","now","Date","context","lastMessageId","getLastMessageId","allMessages","getChatMessages","slice","map","m","content","message","variables","getVariables","type","message_id","statData","get","parse","getContext","worldbookName","charWorldbooks","getCharWorldbookNames","primary","enabledCount","disabledCount","totalProcessed","sortedRules","sort","a","b","updateWorldbookWith","worldbook","entry","enabled","matchedRule","rule","currentType","strategy","shouldBeConstant","error","isAlwaysOn","shouldKeepEnabled","pattern","info","toastr","Error","$","errorCatched","mvuReady","eventOn","tavern_events","MESSAGE_SENT","MESSAGE_SWIPED","MESSAGE_RECEIVED","CHAT_CHANGED","CHAT_CREATED","CHARACTER_PAGE_LOADED","Mvu","events","VARIABLE_UPDATE_ENDED","strategyText","success"],"ignoreList":[],"sourceRoot":""}