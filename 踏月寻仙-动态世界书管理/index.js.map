{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/踏月寻仙-测试版/schema/constants.ts","src://tavern_helper_template/src/踏月寻仙-测试版/schema/common.ts","src://tavern_helper_template/src/踏月寻仙-测试版/schema/utils.ts","src://tavern_helper_template/src/踏月寻仙-测试版/schema/characters.ts","src://tavern_helper_template/src/踏月寻仙-测试版/schema/protagonist.ts","src://tavern_helper_template/src/踏月寻仙-测试版/schema/systems.ts","src://tavern_helper_template/src/踏月寻仙-测试版/schema/world.ts","src://tavern_helper_template/src/踏月寻仙-测试版/schema.ts","src://tavern_helper_template/src/踏月寻仙-动态世界书管理/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","// ============================================================================\r\n// 踏月寻仙 - 常量定义\r\n// ============================================================================\r\n\r\n// 修炼境界等级与境界描述映射\r\n// 等级 1-4:   练气（初期、中期、后期、大圆满）\r\n// 等级 5-8:   筑基（初期、中期、后期、大圆满）\r\n// 等级 9-12:  金丹（初期、中期、后期、大圆满）\r\n// 等级 13-16: 元婴（初期、中期、后期、大圆满）\r\n// 等级 17-20: 化神（初期、中期、后期、大圆满）\r\n// 等级 21-24: 炼虚（初期、中期、后期、大圆满）\r\n// 等级 25-28: 合体（初期、中期、后期、大圆满）\r\n// 等级 29-32: 大乘（初期、中期、后期、大圆满）\r\n// 等级 33-36: 渡劫（初期、中期、后期、大圆满）\r\nexport const REALM_NAMES = ['练气', '筑基', '金丹', '元婴', '化神', '炼虚', '合体', '大乘', '渡劫'];\r\nexport const REALM_STAGES = ['初期', '中期', '后期', '大圆满'];\r\n\r\n// 修炼境界等级与突破阈值映射\r\n// 练气到金丹（1-12级）：每个小境界递增100\r\n// 元婴开始（13级+）：每4个小境界翻倍\r\nexport const REALM_THRESHOLDS = [\r\n    // 练气（1-4）：100, 200, 300, 400\r\n    100, 200, 300, 400,\r\n    // 筑基（5-8）：500, 600, 700, 800\r\n    500, 600, 700, 800,\r\n    // 金丹（9-12）：900, 1000, 1100, 1200\r\n    900, 1000, 1100, 1200,\r\n    // 元婴（13-16）：2400\r\n    2400, 2400, 2400, 2400,\r\n    // 化神（17-20）：4800\r\n    4800, 4800, 4800, 4800,\r\n    // 炼虚（21-24）：9600\r\n    9600, 9600, 9600, 9600,\r\n    // 合体（25-28）：19200\r\n    19200, 19200, 19200, 19200,\r\n    // 大乘（29-32）：38400\r\n    38400, 38400, 38400, 38400,\r\n    // 渡劫（33-36）：76800\r\n    76800, 76800, 76800, 76800,\r\n];\r\n\r\n// 修炼境界等级与寿元上限映射\r\nexport const REALM_LIFESPANS = [100, 100, 100, 100, 200, 200, 200, 200, 500, 500, 500, 500, 1000, 1000, 1000, 1000, 2000, 2000, 2000, 2000, 5000, 5000, 5000, 5000, 10000, 10000, 10000, 10000, 50000, 50000, 50000, 50000, 100000, 100000, 100000, 100000];\r\n\r\n// 配置常量\r\nexport const CONFIG = {\r\n    REALMS: {\r\n        MAJOR: REALM_NAMES,\r\n        MINOR: REALM_STAGES,\r\n    },\r\n    ELEMENTS: {\r\n        火: { effect: '灼烧', visual: '烈焰', nature: '爆裂', color: '#ff4444' },\r\n        水: { effect: '缠绕', visual: '激流', nature: '柔韧', color: '#4488ff' },\r\n        冰: { effect: '冻结', visual: '寒霜', nature: '极寒', color: '#88ddff' },\r\n        雷: { effect: '麻痹', visual: '紫电', nature: '狂暴', color: '#aa44ff' },\r\n        风: { effect: '切割', visual: '罡风', nature: '无形', color: '#88ff88' },\r\n        土: { effect: '镇压', visual: '岩铠', nature: '厚重', color: '#aa8844' },\r\n        木: { effect: '寄生', visual: '藤蔓', nature: '生生不息', color: '#44aa44' },\r\n        金: { effect: '穿透', visual: '锐金', nature: '锋利', color: '#ffdd44' },\r\n        暗: { effect: '腐蚀', visual: '黑雾', nature: '诡谲', color: '#442244' },\r\n        光: { effect: '净化', visual: '圣辉', nature: '神圣', color: '#ffffaa' },\r\n        混沌: { effect: '湮灭', visual: '灰光', nature: '虚无', color: '#888888' },\r\n    },\r\n};","// ============================================================================\r\n// 踏月寻仙 - 共享 Schema（物品、神通、品阶映射）\r\n// ============================================================================\r\n\r\nimport { z } from 'zod';\r\nimport { REALM_LIFESPANS, REALM_NAMES, REALM_STAGES, REALM_THRESHOLDS } from './constants';\r\nimport { calculateBaseCombatPower } from './utils';\r\n\r\n// 品阶容错映射\r\nexport const 品阶映射: Record<string, string> = {\r\n    '凡': '凡', '凡阶': '凡', '凡级': '凡', '凡品': '凡',\r\n    '黄': '黄', '黄阶': '黄', '黄级': '黄', '黄品': '黄',\r\n    '玄': '玄', '玄阶': '玄', '玄级': '玄', '玄品': '玄',\r\n    '地': '地', '地阶': '地', '地级': '地', '地品': '地',\r\n    '天': '天', '天阶': '天', '天级': '天', '天品': '天',\r\n    '仙': '仙', '仙阶': '仙', '仙级': '仙', '仙品': '仙',\r\n    '圣': '圣', '圣阶': '圣', '圣级': '圣', '圣品': '圣',\r\n    '先天': '先天', '先天阶': '先天', '先天级': '先天',\r\n};\r\n\r\n// 熟练度容错映射\r\nexport const 熟练度映射: Record<string, string> = {\r\n    '入门': '入门', '初级': '入门', '初学': '入门', '新手': '入门',\r\n    '熟练': '熟练', '中级': '熟练', '娴熟': '熟练',\r\n    '精通': '精通', '高级': '精通', '精湛': '精通',\r\n    '大成': '大成', '大师': '大成', '宗师': '大成',\r\n    '圆满': '圆满', '完美': '圆满', '极致': '圆满',\r\n    '化境': '化境', '化神': '化境', '返璞归真': '化境', '出神入化': '化境',\r\n};\r\n\r\n// 物品 Schema\r\nexport const ItemSchema = z.object({\r\n    名称: z.string().prefault(''),\r\n    描述: z.string().prefault(''),\r\n    品阶: z.string().prefault(''),\r\n    数量: z.coerce.number().transform(v => Math.max(0, v)).prefault(1),\r\n});\r\n\r\n// 神通 Schema（本尊和红颜共用）\r\nexport const SkillSchema = z.object({\r\n    名称: z.string().prefault(''),\r\n    描述: z.string().prefault(''),\r\n    类型: z.enum(['功法', '神通', '秘术']).prefault('神通'),\r\n    品阶: z.string()\r\n        .transform(v => 品阶映射[v] || '凡')\r\n        .catch('凡'),\r\n    熟练度: z.string()\r\n        .transform(v => 熟练度映射[v] || '入门')\r\n        .catch('入门'),\r\n    领悟时间: z.coerce.number().catch(() => Date.now()),\r\n    威力等级: z.coerce.number().optional(),\r\n}).transform(skill => {\r\n    // 仅当威力等级不存在或为0时才计算\r\n    if (!skill.威力等级 || skill.威力等级 === 0) {\r\n        const 品阶权重: Record<string, number> = { 凡: 1, 黄: 2, 玄: 3, 地: 4, 天: 5, 仙: 6, 圣: 7, 先天: 8 };\r\n        const 熟练度权重: Record<string, number> = { 入门: 1, 熟练: 2, 精通: 3, 大成: 4, 圆满: 5, 化境: 6 };\r\n\r\n        const 品阶值 = 品阶权重[skill.品阶] || 1;\r\n        const 熟练值 = 熟练度权重[skill.熟练度] || 1;\r\n\r\n        return {\r\n            ...skill,\r\n            威力等级: 品阶值 * 10 + 熟练值,\r\n        };\r\n    }\r\n    return skill;\r\n});\r\n\r\n// 背包类物品 Schema（自动过滤数量<=0的物品）\r\nexport const InventorySchema = z\r\n    .record(z.string().describe('物品名'), ItemSchema)\r\n    .prefault({})\r\n    .transform(data => _.pickBy(data, ({ 数量 }) => 数量 > 0));\r\n\r\n// 境界计算 transform（本尊和红颜共用）\r\nexport function computeRealmInfo(data: {\r\n    等级: number;\r\n    修为: number;\r\n    已活岁月: number;\r\n    尝试突破: boolean;\r\n    神通列表?: Record<string, { 威力等级?: number }>;\r\n    体质?: string;\r\n}, includesCombatPower: boolean = false) {\r\n    const level = data.等级;\r\n    const 突破阈值 = REALM_THRESHOLDS[level - 1] ?? 100;\r\n    const 寿元上限 = REALM_LIFESPANS[level - 1] ?? 100;\r\n    const majorIdx = Math.floor((level - 1) / 4);\r\n    const minorIdx = (level - 1) % 4;\r\n    const 境界描述 = `${REALM_NAMES[majorIdx] ?? '练气'}${REALM_STAGES[minorIdx] ?? '初期'}`;\r\n    const 寿元状态 = `${data.已活岁月}/${寿元上限}`;\r\n    const 状态 = data.尝试突破 ? '突破中' : data.修为 >= 突破阈值 ? '瓶颈期' : '修炼中';\r\n    const 进度 = `${((data.修为 / 突破阈值) * 100).toFixed(1)}%`;\r\n\r\n    const base = { 突破阈值, 寿元上限, 境界描述, 寿元状态, 状态, 进度 };\r\n\r\n    if (!includesCombatPower) return base;\r\n\r\n    // 战力计算：境界基础（指数级） + 神通加成 + 体质加成\r\n    const 境界战力 = calculateBaseCombatPower(level);\r\n    const 神通列表 = Object.values(data.神通列表 || {});\r\n    const 最高神通威力 = 神通列表.length > 0\r\n        ? Math.max(...神通列表.map(s => s.威力等级 || 0))\r\n        : 0;\r\n    const 体质加成 = (() => {\r\n        const 体质 = data.体质 || '';\r\n        if (体质.includes('神')) return 500;\r\n        if (体质.includes('圣')) return 200;\r\n        if (体质.includes('道')) return 100;\r\n        if (体质.includes('灵')) return 50;\r\n        return 0;\r\n    })();\r\n    const 战力值 = 境界战力 + 最高神通威力 + 体质加成;\r\n\r\n    return { ...base, 战力值 };\r\n}","// ============================================================================\r\n// 踏月寻仙 - 工具函数\r\n// ============================================================================\r\n\r\nimport { CONFIG, REALM_NAMES, REALM_STAGES } from './constants';\r\n\r\n// 获取灵根元素颜色\r\nexport function getRootColor(root: string): string {\r\n    for (const [elem, data] of Object.entries(CONFIG.ELEMENTS)) {\r\n        if (root.includes(elem)) {\r\n            return data.color;\r\n        }\r\n    }\r\n    return '#cc99ff'; // 默认薰衣草紫（神秘优雅，适合特殊灵根）\r\n}\r\n\r\n// 获取境界等级颜色\r\nexport function getRealmColor(level: number): string {\r\n    const majorIdx = Math.floor((level - 1) / 4);\r\n    const colors = [\r\n        '#888888', // 练气 - 灰色\r\n        '#44aa44', // 筑基 - 绿色\r\n        '#4488ff', // 金丹 - 蓝色\r\n        '#aa44ff', // 元婴 - 紫色\r\n        '#ff4444', // 化神 - 红色\r\n        '#ffaa00', // 炼虚 - 橙色\r\n        '#ffdd44', // 合体 - 金色\r\n        '#ffffff', // 大乘 - 白色\r\n        '#ff88ff', // 渡劫 - 粉色\r\n    ];\r\n    return colors[majorIdx] || '#888888';\r\n}\r\n\r\n// 获取危险度颜色\r\nexport function getDangerColor(danger: number): string {\r\n    if (danger >= 90) return '#ff0000';\r\n    if (danger >= 70) return '#ff4400';\r\n    if (danger >= 50) return '#ff8800';\r\n    if (danger >= 30) return '#ffcc00';\r\n    return '#44aa44';\r\n}\r\n\r\n// 根据境界描述解析等级（如\"金丹后期\" → 11）\r\nexport function parseRealmToLevel(realm: string): number {\r\n    // 先匹配大境界\r\n    let majorIdx = -1;\r\n    for (let i = 0; i < REALM_NAMES.length; i++) {\r\n        if (realm.includes(REALM_NAMES[i])) {\r\n            majorIdx = i;\r\n            break;\r\n        }\r\n    }\r\n    if (majorIdx === -1) return 1; // 无法识别，返回最低等级\r\n\r\n    // 再匹配小境界\r\n    let minorIdx = 0; // 默认初期\r\n    for (let i = 0; i < REALM_STAGES.length; i++) {\r\n        if (realm.includes(REALM_STAGES[i])) {\r\n            minorIdx = i;\r\n            break;\r\n        }\r\n    }\r\n\r\n    return majorIdx * 4 + minorIdx + 1;\r\n}\r\n\r\n// 根据境界等级计算基础战力（指数级增长，跨大境界约10倍差距）\r\nexport function calculateBaseCombatPower(level: number): number {\r\n    const majorIdx = Math.floor((level - 1) / 4); // 大境界索引(0-8)\r\n    const minorIdx = (level - 1) % 4;              // 小境界索引(0-3)\r\n\r\n    // 基础战力：每个大境界翻10倍，小境界内线性增长20%\r\n    const 大境界基础 = Math.pow(10, majorIdx + 1); // 10, 100, 1000, 10000...\r\n    const 小境界加成 = 大境界基础 * 0.2 * minorIdx; // 每小境界+20%基础\r\n\r\n    return Math.round(大境界基础 + 小境界加成);\r\n}\r\n\r\n// 根据战力差距返回战力评估\r\nexport function evaluateCombatPower(myPower: number, enemyPower: number): string {\r\n    const ratio = myPower / enemyPower;\r\n    if (ratio >= 2.0) return '碾压';\r\n    if (ratio >= 1.3) return '优势';\r\n    if (ratio >= 0.8) return '势均力敌';\r\n    if (ratio >= 0.5) return '劣势';\r\n    return '绝望';\r\n}","// ============================================================================\r\n// 踏月寻仙 - 角色 Schema（红颜角色库、红颜、NPC图鉴）\r\n// ============================================================================\r\n\r\nimport { z } from 'zod';\r\nimport { SkillSchema, computeRealmInfo } from './common';\r\n\r\n// 红颜角色库 Schema（静态角色数据）\r\nexport const CharacterLibEntrySchema = z.object({\r\n    级: z.coerce.number().transform(v => _.clamp(v, 1, 36)),\r\n    根: z.string().describe('灵根'),\r\n    质: z.string().describe('体质'),\r\n    龄: z.string().describe('年龄'),\r\n    属: z.string().describe('所属'),\r\n    法: z.string().describe('功法'),\r\n    器: z.string().describe('本命兵器'),\r\n    通: z.array(z.string()).prefault([]),\r\n});\r\n\r\n// 红颜角色库默认数据\r\nexport const DEFAULT_CHARACTER_LIB = {\r\n    许听雨: { 级: 33, 根: '水本源天', 质: '归墟神体', 龄: '外26实12000', 属: '归墟之主', 法: '万水归源先天', 器: '沧海遗珠先天', 通: ['归墟歌', '逆流虚妄', '寂灭海域', '万水同源'] },\r\n    虞汐颜: { 级: 12, 根: '水阴阳异', 质: '双鱼体', 龄: '化形0年', 属: '{{user}}玉佩', 法: '双生天极/阴阳', 器: '双鱼佩本体', 通: ['枯木春', '夺命妆', '双鱼梦'] },\r\n    白清弦: { 级: 29, 根: '金天根', 质: '剑体', 龄: '外30实1000+', 属: '散修剑宗师', 法: '剑意仙/天音天', 器: '清弦琴剑灵宝', 通: ['琴剑杀', '剑意歌', '万剑心'] },\r\n    南宫云裳: { 级: 16, 根: '火天根', 质: '神凰道体', 龄: '外10实118', 属: '大夏栖凤宫主', 法: '九转涅槃仙', 器: '栖梧簪灵宝', 通: ['南明离火', '凰威镇世', '羽化虚空'] },\r\n    梦杳泠: { 级: 23, 根: '瑞兽异根', 质: '乘黄圣体', 龄: '外8实万年+', 属: '无(末代乘黄)', 法: '乘黄本源天', 器: '无', 通: ['瑞光庇佑', '灵觉通明', '本源爆发'] },\r\n    幻千丝: { 级: 13, 根: '暗幻双根', 质: '梦魇体', 龄: '外20未知', 属: '散修幽冥', 法: '织梦天', 器: '千丝网灵宝', 通: ['织梦笼', '心魔境', '千丝缚'] },\r\n    晚棠: { 级: 15, 根: '幽冥灵根', 质: '噬魂之体', 龄: '未知', 属: '散修', 法: '幽冥归魂经天', 器: '引魂铃灵宝', 通: ['冥河指引', '冥莲沉梦', '归魂摆舟'] },\r\n};\r\n\r\n// 红颜（动态角色数据）Schema\r\nexport const CompanionSchema = z\r\n    .object({\r\n        等级: z.coerce.number().transform(v => _.clamp(v, 1, 36)).prefault(1),\r\n        修为: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\r\n        灵根: z.string().prefault('五行杂灵根'),\r\n        体质: z.string().prefault('凡体'),\r\n        功法: z.string().prefault('无'),\r\n        本命兵器: z.string().prefault('无'),\r\n        神通列表: z.record(z.string().describe('神通名'), SkillSchema).prefault({}),\r\n        灵石: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\r\n        已活岁月: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\r\n        尝试突破: z.boolean().prefault(false),\r\n        好感度: z.coerce.number().transform(v => _.clamp(v, -100, 100)).prefault(0),\r\n        关系: z.string().prefault('陌生人'),\r\n        重要性: z.string().prefault('路人'),\r\n    })\r\n    .prefault({\r\n        等级: 1,\r\n        修为: 0,\r\n        灵根: '五行杂灵根',\r\n        体质: '凡体',\r\n        功法: '无',\r\n        本命兵器: '无',\r\n        神通列表: {},\r\n        灵石: 0,\r\n        已活岁月: 0,\r\n        尝试突破: false,\r\n        好感度: 0,\r\n        关系: '陌生人',\r\n        重要性: '路人',\r\n    })\r\n    .transform(data => {\r\n        const realmInfo = computeRealmInfo(data, false);\r\n        return { ...data, ...realmInfo };\r\n    });\r\n\r\n// NPC图鉴 Schema - 极简版\r\nexport const NpcSchema = z.object({\r\n    等级: z.coerce.number().transform(v => _.clamp(v, 1, 36)).prefault(1),\r\n    所在宗门: z.string().prefault('散修'),\r\n    备注: z.string().prefault(''),\r\n});","// ============================================================================\r\n// 踏月寻仙 - 本尊 Schema\r\n// ============================================================================\r\n\r\nimport { z } from 'zod';\r\nimport { InventorySchema, SkillSchema, computeRealmInfo } from './common';\r\n\r\n// 战斗状态容错映射\r\nconst 战斗状态映射: Record<string, string> = {\r\n    '非战斗': '非战斗', '和平': '非战斗', '安全': '非战斗', '脱战': '非战斗',\r\n    '对峙': '对峙', '警戒': '对峙', '僵持': '对峙', '对视': '对峙',\r\n    '激战': '激战', '战斗': '激战', '交战': '激战', '厮杀': '激战',\r\n    '重伤': '重伤', '负伤': '重伤', '伤重': '重伤',\r\n    '濒死': '濒死', '将死': '濒死', '垂危': '濒死', '危急': '濒死',\r\n};\r\n\r\nconst 伤势映射: Record<string, string> = {\r\n    '无伤': '无伤', '无': '无伤', '完好': '无伤', '健康': '无伤',\r\n    '轻伤': '轻伤', '小伤': '轻伤', '微伤': '轻伤',\r\n    '重伤': '重伤', '伤重': '重伤', '大伤': '重伤',\r\n    '濒死': '濒死', '将死': '濒死', '垂危': '濒死',\r\n};\r\n\r\nconst 战力评估映射: Record<string, string> = {\r\n    '碾压': '碾压', '压倒': '碾压', '秒杀': '碾压', '吊打': '碾压',\r\n    '优势': '优势', '占优': '优势', '上风': '优势', '有利': '优势',\r\n    '势均力敌': '势均力敌', '均势': '势均力敌', '平手': '势均力敌', '相当': '势均力敌', '旗鼓相当': '势均力敌',\r\n    '劣势': '劣势', '下风': '劣势', '不利': '劣势', '落后': '劣势',\r\n    '绝望': '绝望', '必死': '绝望', '碾压劣势': '绝望', '无望': '绝望',\r\n};\r\n\r\nconst 敌人状态映射: Record<string, string> = {\r\n    '完好': '完好', '无伤': '完好', '健康': '完好', '全盛': '完好',\r\n    '轻伤': '轻伤', '小伤': '轻伤', '微伤': '轻伤',\r\n    '重伤': '重伤', '伤重': '重伤', '大伤': '重伤',\r\n    '濒死': '濒死', '将死': '濒死', '垂危': '濒死',\r\n    '已死': '已死', '死亡': '已死', '击杀': '已死', '阵亡': '已死',\r\n};\r\n\r\n// 劫种映射\r\nconst 劫种映射: Record<string, string> = {\r\n    '无': '无', '': '无', '无劫': '无',\r\n    '雷劫': '雷劫', '天雷': '雷劫', '雷': '雷劫',\r\n    '心劫': '心劫', '心魔': '心劫', '魔劫': '心劫',\r\n    '天劫': '天劫', '大劫': '天劫',\r\n    '情劫': '情劫', '情关': '情劫',\r\n    '因果劫': '因果劫', '因果': '因果劫',\r\n    '红尘劫': '红尘劫', '红尘': '红尘劫',\r\n    '轮回劫': '轮回劫', '轮回': '轮回劫',\r\n};\r\n\r\nconst 劫难等级映射: Record<string, string> = {\r\n    '小劫': '小劫', '小': '小劫', '初级': '小劫',\r\n    '中劫': '中劫', '中': '中劫', '中级': '中劫',\r\n    '大劫': '大劫', '大': '大劫', '高级': '大劫',\r\n    '天罚': '天罚', '天': '天罚', '极': '天罚', '天道': '天罚',\r\n};\r\n\r\nconst 渡劫结果映射: Record<string, string> = {\r\n    '无': '无', '': '无', '未渡劫': '无',\r\n    '成功': '成功', '通过': '成功', '渡过': '成功',\r\n    '失败': '失败', '未过': '失败', '失': '失败',\r\n};\r\n\r\n// 战斗状态 Schema\r\nconst CombatStatusSchema = z.object({\r\n    正在战斗: z.boolean().prefault(false),\r\n    当前状态: z.string()\r\n        .transform(v => 战斗状态映射[v] || '非战斗')\r\n        .prefault('非战斗'),\r\n    灵力值: z.coerce.number().transform(v => _.clamp(v, 0, 100)).prefault(100),\r\n    伤势等级: z.string()\r\n        .transform(v => 伤势映射[v] || '无伤')\r\n        .prefault('无伤'),\r\n    已用底牌: z.array(z.string()).prefault([]),\r\n    战斗回合: z.coerce.number().prefault(0),\r\n}).prefault({\r\n    正在战斗: false,\r\n    当前状态: '非战斗',\r\n    灵力值: 100,\r\n    伤势等级: '无伤',\r\n    已用底牌: [],\r\n    战斗回合: 0,\r\n});\r\n\r\n// 当前敌人 Schema\r\nconst EnemySchema = z.object({\r\n    名称: z.string().prefault('未知敌人'),\r\n    境界: z.string().prefault('未知'),\r\n    战力评估: z.string()\r\n        .transform(v => 战力评估映射[v] || '势均力敌')\r\n        .prefault('势均力敌'),\r\n    状态: z.string()\r\n        .transform(v => 敌人状态映射[v] || '完好')\r\n        .prefault('完好'),\r\n    特点: z.string().prefault(''),\r\n});\r\n\r\n// 渡劫状态 Schema\r\nconst TribulationSchema = z.object({\r\n    正在渡劫: z.boolean().prefault(false),\r\n    劫种: z.string()\r\n        .transform(v => 劫种映射[v] || '无')\r\n        .prefault('无'),\r\n    劫难等级: z.string()\r\n        .transform(v => 劫难等级映射[v] || '小劫')\r\n        .prefault('小劫'),\r\n    当前阶段: z.coerce.number().transform(v => _.clamp(v, 0, 9)).prefault(0),\r\n    总阶段数: z.coerce.number().transform(v => Math.max(1, v)).prefault(3),\r\n    劫力承受: z.coerce.number().transform(v => _.clamp(v, 0, 100)).prefault(100),\r\n    已用护道: z.array(z.string()).prefault([]),\r\n    劫难描述: z.string().prefault(''),\r\n    触发原因: z.string().prefault(''),\r\n    上次渡劫结果: z.string()\r\n        .transform(v => 渡劫结果映射[v] || '无')\r\n        .prefault('无'),\r\n    渡劫冷却: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\r\n    失败惩罚记录: z.string().prefault(''),\r\n}).prefault({\r\n    正在渡劫: false,\r\n    劫种: '无',\r\n    劫难等级: '小劫',\r\n    当前阶段: 0,\r\n    总阶段数: 3,\r\n    劫力承受: 100,\r\n    已用护道: [],\r\n    劫难描述: '',\r\n    触发原因: '',\r\n    上次渡劫结果: '无',\r\n    渡劫冷却: 0,\r\n    失败惩罚记录: '',\r\n});\r\n\r\n// 行踪 Schema\r\nconst LocationTrackSchema = z.object({\r\n    当前区域: z.string().prefault('未知之地'),\r\n    所属层级: z.string().prefault('地层'),\r\n    环境描述: z.string().prefault(''),\r\n    危险度: z.coerce.number().prefault(10),\r\n    可用通道: z.array(z.string()).prefault([]),\r\n    导航信息: z.string().prefault(''),\r\n}).prefault({\r\n    当前区域: '未知之地',\r\n    所属层级: '地层',\r\n    环境描述: '',\r\n    危险度: 10,\r\n    可用通道: [],\r\n    导航信息: '',\r\n});\r\n\r\n// 身份 Schema\r\nconst IdentitySchema = z.object({\r\n    姓名: z.string().prefault('无名氏'),\r\n    宗门: z.string().prefault('散修'),\r\n    出身: z.string().prefault('凡人'),\r\n}).prefault({\r\n    姓名: '无名氏',\r\n    宗门: '散修',\r\n    出身: '凡人',\r\n});\r\n\r\n// 本尊 Schema\r\nexport const ProtagonistSchema = z\r\n    .object({\r\n        等级: z.coerce.number().transform(v => _.clamp(v, 1, 36)).prefault(1),\r\n        修为: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\r\n        灵根: z.string().prefault('五行杂灵根'),\r\n        体质: z.string().prefault('凡体'),\r\n        功法: z.string().prefault('无'),\r\n        本命兵器: z.string().prefault('无'),\r\n        神通列表: z.record(z.string().describe('神通名'), SkillSchema).prefault({}),\r\n        灵石: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\r\n        已活岁月: z.coerce.number().transform(v => Math.max(0, v)).prefault(0),\r\n        尝试突破: z.boolean().prefault(false),\r\n        行踪: LocationTrackSchema,\r\n        身份: IdentitySchema,\r\n        背包: InventorySchema,\r\n        法宝: InventorySchema,\r\n        杂物袋: InventorySchema,\r\n        战斗状态: CombatStatusSchema,\r\n        当前敌人: z.array(EnemySchema).prefault([]),\r\n        渡劫状态: TribulationSchema,\r\n    })\r\n    .prefault({\r\n        等级: 1,\r\n        修为: 0,\r\n        灵根: '五行杂灵根',\r\n        体质: '凡体',\r\n        功法: '无',\r\n        本命兵器: '无',\r\n        神通列表: {},\r\n        灵石: 0,\r\n        已活岁月: 0,\r\n        尝试突破: false,\r\n        行踪: {\r\n            当前区域: '未知之地',\r\n            所属层级: '地层',\r\n            环境描述: '',\r\n            危险度: 10,\r\n            可用通道: [],\r\n            导航信息: '',\r\n        },\r\n        身份: {\r\n            姓名: '无名氏',\r\n            宗门: '散修',\r\n            出身: '凡人',\r\n        },\r\n        背包: {},\r\n        法宝: {},\r\n        杂物袋: {},\r\n        战斗状态: {\r\n            正在战斗: false,\r\n            当前状态: '非战斗',\r\n            灵力值: 100,\r\n            伤势等级: '无伤',\r\n            已用底牌: [],\r\n            战斗回合: 0,\r\n        },\r\n        当前敌人: [],\r\n        渡劫状态: {\r\n            正在渡劫: false,\r\n            劫种: '无',\r\n            劫难等级: '小劫',\r\n            当前阶段: 0,\r\n            总阶段数: 3,\r\n            劫力承受: 100,\r\n            已用护道: [],\r\n            劫难描述: '',\r\n            触发原因: '',\r\n            上次渡劫结果: '无',\r\n            渡劫冷却: 0,\r\n            失败惩罚记录: '',\r\n        },\r\n    })\r\n    .transform(data => {\r\n        const realmInfo = computeRealmInfo(data, true);\r\n        return { ...data, ...realmInfo };\r\n    });","// ============================================================================\r\n// 踏月寻仙 - 系统 Schema（任务列表、声望系统、可参与机遇、当前处境）\r\n// ============================================================================\r\n\r\nimport { z } from 'zod';\r\n\r\n// 任务列表 Schema - 移除自动清理逻辑，保持数据完整性\r\nexport const QuestSchema = z.object({\r\n    名称: z.string().prefault(''),\r\n    类型: z.enum(['主线', '支线', '每日', '临危受命', '秘境探索']).prefault('主线'),\r\n    目标: z.string().prefault(''),\r\n    状态: z.enum(['进行中', '已完成', '已失败']).prefault('进行中'),\r\n    // 秘境专属字段（仅当类型为秘境探索时需要）\r\n    秘境信息: z\r\n        .object({\r\n            域: z.enum(['天层', '神州', '东苍', '南炎', '西庚', '北冥', '下层', '四海']).optional(),\r\n            危: z.coerce.number().transform(v => _.clamp(v, 0, 100)).optional(),\r\n            特: z.string().optional(),\r\n            奖: z.union([\r\n                z.array(z.string()),\r\n                z.string().transform(v => v ? [v] : []),\r\n            ]).prefault([]),\r\n            限: z.string().optional(),\r\n        })\r\n        .optional(),\r\n    创建时间: z.union([\r\n        z.coerce.number(), // 兼容已有的时间戳\r\n        z.string().transform(() => {\r\n            // AI 输入修仙时间格式时，简化处理：直接用当前时间\r\n            return Date.now();\r\n        })\r\n    ]).prefault(() => Date.now()),\r\n});\r\n\r\n// 声望条目 Schema\r\nexport const ReputationEntrySchema = z.object({\r\n    值: z.coerce.number().transform(v => _.clamp(v, -100, 100)).prefault(0),\r\n    关系: z.string().prefault('陌生'),\r\n    更新时间: z.coerce.number().prefault(() => Date.now()),\r\n});\r\n\r\n// 声望系统 Schema（带自动关系计算 transform）\r\nexport const ReputationSystemSchema = z\r\n    .record(z.string().describe('势力名'), ReputationEntrySchema)\r\n    .prefault({})\r\n    .transform(factions => {\r\n        // 自动根据声望值计算关系描述\r\n        return _(factions)\r\n            .mapValues(faction => {\r\n                const value = faction.值;\r\n                let 自动关系: string;\r\n\r\n                if (value >= 80) {\r\n                    自动关系 = '盟友';\r\n                } else if (value >= 60) {\r\n                    自动关系 = '友善';\r\n                } else if (value >= 30) {\r\n                    自动关系 = '友好';\r\n                } else if (value >= 10) {\r\n                    自动关系 = '中立偏好';\r\n                } else if (value >= -10) {\r\n                    自动关系 = '中立';\r\n                } else if (value >= -30) {\r\n                    自动关系 = '中立偏恶';\r\n                } else if (value >= -60) {\r\n                    自动关系 = '敌对';\r\n                } else if (value >= -80) {\r\n                    自动关系 = '仇恨';\r\n                } else {\r\n                    自动关系 = '不死不休';\r\n                }\r\n\r\n                // 如果用户手动设置了关系，优先使用用户设置；否则使用自动计算的关系\r\n                const 最终关系 = faction.关系 && faction.关系 !== '陌生' ? faction.关系 : 自动关系;\r\n\r\n                return {\r\n                    ...faction,\r\n                    关系: 最终关系,\r\n                };\r\n            })\r\n            .value();\r\n    });\r\n\r\n// 可参与机遇 Schema\r\nexport const OpportunitySchema = z.object({\r\n    名称: z.string().prefault(''),\r\n    来源: z.string().prefault(''), // 如：剧情推进、任务触发、NPC邀请、地点发现、时限事件\r\n    类型: z.enum(['探索', '任务', '交易', '结交', '争夺', '修炼', '红颜', '随机']).prefault('探索'),\r\n    描述: z.string().prefault(''),\r\n    回报预期: z.string().prefault(''), // 如：中等灵石收益、可能获得功法线索\r\n    风险评估: z.string().prefault(''), // 如：低风险、有战斗可能\r\n    时限: z.string().optional(), // 如：本日结束前、三日内\r\n    关联事件: z.string().optional(), // 关联的世界事件或任务\r\n    优先级: z.coerce.number().transform(v => _.clamp(v, 1, 5)).prefault(3), // 1-5，5最高\r\n});","// ============================================================================\r\n// 踏月寻仙 - 世界设定 Schema（宗门、功法、法宝、地点、灵根、体质）\r\n// ============================================================================\r\n\r\nimport { z } from 'zod';\r\nimport { 品阶映射 } from './common';\r\n\r\n// 宗门势力 Schema - 优化版\r\nexport const FactionSchema = z.object({\r\n    地: z.string().describe('所在地'),\r\n    特: z.string().describe('核心特点'),\r\n    力: z.string().describe('最高战力'),\r\n    营: z.enum(['正', '魔', '中']),\r\n    模: z.enum(['超大', '大', '小', '微', '特']),\r\n});\r\n\r\n// 功法 Schema - 优化版（添加品阶容错转换）\r\nexport const TechniqueSchema = z.object({\r\n    阶: z.string()\r\n        .transform(v => 品阶映射[v] || '凡')\r\n        .catch('凡'),\r\n    性: z.string().describe('属性'),\r\n    效: z.string().describe('效果'),\r\n});\r\n\r\n// 法宝兵器 Schema - 极简版\r\n// 品阶从低到高: 凡器 < 法器 < 灵器 < 法宝 < 灵宝 < 仙器 < 圣器 < 道器 < 本命\r\n// 本命法宝: 与主人神魂相连，可随主人成长，威力随契合度提升，极为稀有\r\nexport const TreasureSchema = z.object({\r\n    阶: z.enum(['凡器', '法器', '灵器', '法宝', '灵宝', '仙器', '圣器', '道器', '本命']),\r\n    类: z.string().describe('类型'),\r\n    // 本命法宝专属字段\r\n    本命特性: z.string().optional().describe('本命法宝独有特性'),\r\n    器灵: z.string().optional().describe('器灵名称'),\r\n}).transform(data => ({\r\n    ...data,\r\n    特: data.阶 === '本命' ? '至尊' : data.阶 === '道器' ? '超凡' : data.阶 === '圣器' ? '极品' : data.阶 === '仙器' ? '顶级' : data.阶 === '灵宝' ? '强' : data.阶 === '法宝' ? '中' : '普通',\r\n}));\r\n\r\n// 地点 Schema - 优化版\r\nexport const LocationSchema = z.object({\r\n    域: z.enum(['天层', '神州', '东苍', '南炎', '西庚', '北冥', '下层', '四海']),\r\n    类: z.enum(['秘境', '城镇', '宗门', '禁地', '遗迹', '地形']),\r\n    危: z.coerce.number().transform(v => _.clamp(v, 0, 100)),\r\n    特: z.string().describe('特点'),\r\n    资: z.union([\r\n        z.array(z.string()),\r\n        z.string().transform(v => v ? [v] : []),\r\n    ]).prefault([]),\r\n});\r\n\r\n// 灵根 Schema - 极简版（速度根据质自动计算）\r\nexport const SpiritRootSchema = z.object({\r\n    质: z.enum(['劣', '下', '中', '上', '极', '天', '异']),\r\n    性: z.string().describe('属性'),\r\n    稀: z.enum(['常', '少', '罕', '稀', '传']),\r\n}).transform(data => {\r\n    const 速度映射 = { 劣: '0.3倍', 下: '0.5倍', 中: '1倍', 上: '2倍', 极: '3倍', 天: '5倍', 异: '4倍' };\r\n    return {\r\n        ...data,\r\n        速: 速度映射[data.质] || '1倍',\r\n        特: data.质 === '天' ? '单系顶级' : data.质 === '异' ? '变异稀有' : data.质 === '极' ? '双系优秀' : '常规',\r\n    };\r\n});\r\n\r\n// 体质 Schema - 优化版\r\nexport const PhysiqueSchema = z.object({\r\n    质: z.enum(['凡', '灵', '道', '圣', '神']),\r\n    特: z.string().describe('特性'),\r\n    稀: z.enum(['常', '少', '罕', '稀', '传']),\r\n}).transform(data => ({\r\n    ...data,\r\n    优: data.质 === '神' ? '至高' : data.质 === '圣' ? '极强' : data.质 === '道' ? '强' : data.质 === '灵' ? '中' : '无',\r\n}));\r\n\r\n// 宗门势力库默认数据\r\nexport const DEFAULT_FACTIONS = {\r\n    // 正道\r\n    剑阁: { 地: '神州剑门关', 特: '剑道源头', 力: '渡劫后期', 营: '正' as const, 模: '超大' as const },\r\n    万法宗: { 地: '神州问道峰', 特: '万法本源', 力: '渡劫初期', 营: '正' as const, 模: '超大' as const },\r\n    金刚寺: { 地: '西天佛山', 特: '佛修炼体', 力: '大乘中期', 营: '正' as const, 模: '大' as const },\r\n    药王谷: { 地: '神农架', 特: '医炼丹药', 力: '大乘初期', 营: '正' as const, 模: '大' as const },\r\n    儒门: { 地: '文圣山', 特: '浩然正气', 力: '大乘中期', 营: '正' as const, 模: '大' as const },\r\n    青龙殿: { 地: '东苍青龙山', 特: '守护青帝', 力: '大乘初期', 营: '正' as const, 模: '大' as const },\r\n    玄武宗: { 地: '北冥玄冰山', 特: '镇守归墟', 力: '大乘后期', 营: '正' as const, 模: '大' as const },\r\n    青云门: { 地: '神州青云山', 特: '水脉一系', 力: '大乘初期', 营: '正' as const, 模: '大' as const },\r\n    建木宗: { 地: '东苍建木树', 特: '木系道法', 力: '合体中期', 营: '正' as const, 模: '小' as const },\r\n    百花谷: { 地: '百花秘境', 特: '女修花道', 力: '合体后期', 营: '正' as const, 模: '小' as const },\r\n    // 魔道\r\n    血神教: { 地: '血魔渊', 特: '血道炼法', 力: '渡劫中期', 营: '魔' as const, 模: '超大' as const },\r\n    天魔宗: { 地: '天魔山', 特: '天魔大道', 力: '大乘中期', 营: '魔' as const, 模: '大' as const },\r\n    // 中立\r\n    妖盟: { 地: '万妖森林', 特: '妖族联盟', 力: '渡劫中期', 营: '中' as const, 模: '超大' as const },\r\n    大夏王朝: { 地: '中州皇城', 特: '世俗统治', 力: '大乘初期', 营: '中' as const, 模: '大' as const },\r\n    九州商会: { 地: '九大主城', 特: '商业联盟', 力: '大乘初期', 营: '中' as const, 模: '大' as const },\r\n    离火宫: { 地: '南炎火山', 特: '朱雀供奉', 力: '合体圆满', 营: '中' as const, 模: '小' as const },\r\n    铸剑山庄: { 地: '南炎地火', 特: '炼器第一', 力: '合体后期', 营: '中' as const, 模: '小' as const },\r\n};\r\n\r\n// 法宝库默认数据\r\nexport const DEFAULT_TREASURES = {\r\n    镇渊剑: { 阶: '仙器' as const, 类: '剑' },\r\n    双鱼佩: {\r\n        阶: '本命' as const,\r\n        类: '玉佩',\r\n        本命特性: '源血契约、阴阳双生、器灵化形、与主共修、生死相依、锁血护主',\r\n        器灵: '虞汐颜',\r\n    },\r\n};\r\n\r\n// 地点库默认数据\r\nexport const DEFAULT_LOCATIONS = {\r\n    // 天层 - 保留核心禁地\r\n    天渊: { 域: '天层' as const, 类: '禁地' as const, 危: 95, 特: '星辰裂隙', 资: ['星辰碎片', '陨铁'] },\r\n    罡风带: { 域: '天层' as const, 类: '禁地' as const, 危: 90, 特: '罡风屏障', 资: ['罡风精华'] },\r\n    // 神州\r\n    问道峰: { 域: '神州' as const, 类: '宗门' as const, 危: 10, 特: '万法宗', 资: ['功法', '灵药'] },\r\n    剑门关: { 域: '神州' as const, 类: '宗门' as const, 危: 15, 特: '剑阁', 资: ['剑意', '飞剑'] },\r\n    藏书阁: { 域: '神州' as const, 类: '宗门' as const, 危: 5, 特: '古籍', 资: ['功法', '秘术'] },\r\n    酆都城: { 域: '神州' as const, 类: '城镇' as const, 危: 30, 特: '鬼市', 资: ['幽冥材料'] },\r\n    龙门瀑: { 域: '神州' as const, 类: '秘境' as const, 危: 40, 特: '化龙', 资: ['龙气'] },\r\n    // 东苍\r\n    建木林: { 域: '东苍' as const, 类: '地形' as const, 危: 50, 特: '古树精', 资: ['灵木', '妖丹'] },\r\n    青帝陵: { 域: '东苍' as const, 类: '遗迹' as const, 危: 85, 特: '青帝传承', 资: ['青帝传承'] },\r\n    百花境: { 域: '东苍' as const, 类: '秘境' as const, 危: 20, 特: '花海', 资: ['灵花'] },\r\n    // 南炎\r\n    不灭火山: { 域: '南炎' as const, 类: '地形' as const, 危: 80, 特: '朱雀涅槃', 资: ['朱雀火'] },\r\n    涅槃台: { 域: '南炎' as const, 类: '遗迹' as const, 危: 70, 特: '涅槃', 资: ['涅槃感悟'] },\r\n    // 西庚\r\n    万剑冢: { 域: '西庚' as const, 类: '禁地' as const, 危: 85, 特: '剑意', 资: ['剑意', '古剑'] },\r\n    // 北冥\r\n    玄冰山: { 域: '北冥' as const, 类: '宗门' as const, 危: 50, 特: '玄武宗', 资: ['玄冰'] },\r\n    归墟眼: { 域: '北冥' as const, 类: '禁地' as const, 危: 99, 特: '归墟', 资: ['归墟感悟'] },\r\n    // 下层\r\n    黄泉迹: { 域: '下层' as const, 类: '遗迹' as const, 危: 90, 特: '幽冥', 资: ['黄泉水'] },\r\n    炎渊: { 域: '下层' as const, 类: '禁地' as const, 危: 95, 特: '地心火', 资: ['地心火'] },\r\n};","// ============================================================================\n// 踏月寻仙 - MVU 变量结构定义 (入口文件)\n// ============================================================================\n// 从子模块导入并组合最终 Schema\n\nimport { z } from 'zod';\n\n// 子模块导入\n// import { AchievementSystemSchema } from './schema/achievements'; // 成就系统暂时禁用\nimport { CharacterLibEntrySchema, CompanionSchema, DEFAULT_CHARACTER_LIB, NpcSchema } from './schema/characters';\nimport { ProtagonistSchema } from './schema/protagonist';\nimport { OpportunitySchema, QuestSchema, ReputationSystemSchema } from './schema/systems';\nimport { DEFAULT_FACTIONS, DEFAULT_LOCATIONS, DEFAULT_TREASURES, FactionSchema, LocationSchema, PhysiqueSchema, SpiritRootSchema, TechniqueSchema, TreasureSchema } from './schema/world';\n\n// 重新导出所有子模块的公开内容\n// export * from './schema/achievements'; // 成就系统暂时禁用\nexport { CharacterLibEntrySchema, CompanionSchema, DEFAULT_CHARACTER_LIB, NpcSchema } from './schema/characters';\nexport { computeRealmInfo, InventorySchema, ItemSchema, SkillSchema, 品阶映射, 熟练度映射 } from './schema/common';\nexport { CONFIG, REALM_LIFESPANS, REALM_NAMES, REALM_STAGES, REALM_THRESHOLDS } from './schema/constants';\nexport { ProtagonistSchema } from './schema/protagonist';\nexport { OpportunitySchema, QuestSchema, ReputationEntrySchema, ReputationSystemSchema } from './schema/systems';\nexport { calculateBaseCombatPower, evaluateCombatPower, getDangerColor, getRealmColor, getRootColor, parseRealmToLevel } from './schema/utils';\nexport { DEFAULT_FACTIONS, DEFAULT_LOCATIONS, DEFAULT_TREASURES, FactionSchema, LocationSchema, PhysiqueSchema, SpiritRootSchema, TechniqueSchema, TreasureSchema } from './schema/world';\n\n// ============================================================================\n// 完整的 MVU 变量结构\n// ============================================================================\n\nexport const Schema = z.object({\n    世界时钟: z.object({\n        纪元: z.string().prefault('末法时代'),\n        年份: z.coerce.number().prefault(1),\n        月份: z.coerce.number().transform(v => _.clamp(v, 1, 12)).prefault(1),\n        日期: z.coerce.number().transform(v => _.clamp(v, 1, 30)).prefault(1),\n        时辰: z.string().prefault('子时'),\n    }).prefault({\n        纪元: '末法时代',\n        年份: 1,\n        月份: 1,\n        日期: 1,\n        时辰: '子时',\n    }),\n\n    世界地图: z.record(z.string().describe('区域名'), z.object({\n        layer: z.enum(['天层', '地层', '下层']).prefault('地层'),\n        danger: z.coerce.number().transform(v => _.clamp(v, 0, 100)),\n        desc: z.string().prefault(''),\n        connections: z.array(z.string()).prefault([]),\n    })).prefault({}),\n\n    世界图志: z.record(z.string().describe('事件名'), z.object({\n        状态: z.string().prefault(''),\n        事件: z.string().prefault(''),\n    })).prefault({}),\n\n    宗门势力库: z.record(z.string().describe('宗门名'), FactionSchema).prefault(DEFAULT_FACTIONS),\n\n    // 功法库 - AI 自由创造，只需提供 { 阶, 性, 效 }\n    功法库: z.record(z.string().describe('功法名'), TechniqueSchema).prefault({}),\n\n    // 法宝库 - 仅保留剧情关键法宝，其他 AI 自由创造\n    法宝库: z.record(z.string().describe('法宝名'), TreasureSchema).prefault(DEFAULT_TREASURES),\n\n    地点库: z.record(z.string().describe('地点名'), LocationSchema).prefault(DEFAULT_LOCATIONS),\n\n    // 灵根库 - AI 自由创造，只需提供 { 质, 性, 稀 }，速度和特性由 transform 自动计算\n    灵根库: z.record(z.string().describe('灵根名'), SpiritRootSchema).prefault({}),\n\n    // 体质库 - AI 自由创造，只需提供 { 质, 特, 稀 }，优势由 transform 自动计算\n    体质库: z.record(z.string().describe('体质名'), PhysiqueSchema).prefault({}),\n\n    本尊: ProtagonistSchema,\n\n    红颜角色库: z.record(z.string().describe('角色名'), CharacterLibEntrySchema).prefault(DEFAULT_CHARACTER_LIB),\n\n    红颜: z.record(z.string().describe('红颜名'), CompanionSchema).prefault({}),\n\n    // NPC图鉴 - 极简版（保留向后兼容）\n    NPC图鉴: z.record(z.string().describe('NPC名'), NpcSchema).prefault({}),\n\n    // 任务列表 - 移除自动清理逻辑，保持数据完整性\n    任务列表: z.record(z.string().describe('任务ID'), QuestSchema).prefault({}),\n\n    // 声望系统 - 健壮性与智能管理优化\n    声望系统: ReputationSystemSchema,\n\n    // ========== 成就/里程碑系统（暂时禁用） ==========\n    // 成就系统: AchievementSystemSchema,\n\n    // ========== 行动提示系统 ==========\n    可参与机遇: z.array(OpportunitySchema).prefault([]),\n\n    // 当前处境描述（用于行动提示面板顶部显示）\n    当前处境: z.string().prefault(''),\n});\n\n// 导出 Schema 类型\nexport type SchemaType = z.output<typeof Schema>;\n","// ============================================================================\n// 动态世界书管理脚本 - 根据上下文智能启用/禁用世界书条目\n//\n// 功能：根据当前区域、境界、人物等上下文自动启用/禁用世界书条目，节省 token\n// ============================================================================\n\nimport { Schema } from '../踏月寻仙-测试版/schema';\n\n// ============================================================================\n// 配置项\n// ============================================================================\n\nconst CONFIG = {\n    // 要管理的世界书名称（修改为你的世界书名）\n    WORLDBOOK_NAME: 'current',  // 'current' 表示当前角色卡的主世界书\n\n    // 是否启用调试日志\n    DEBUG: true,  // 临时开启调试日志以排查问题\n\n    // 上下文窗口（检查最近几条消息）\n    CONTEXT_WINDOW: 2,  // 只检查最近2条消息，更精准\n\n    // 策略模式：\n    // - 'aggressive': 激进模式 - 用户输入时开启，AI回复后立即关闭大部分（最省token）\n    // - 'balanced': 平衡模式 - 用户输入时开启，AI回复后保留核心条目（推荐）\n    // - 'conservative': 保守模式 - 始终保持相关条目开启（最安全但最费token）\n    STRATEGY: 'balanced' as 'aggressive' | 'balanced' | 'conservative',\n\n    // MVU 初始化最大等待时间(毫秒)\n    MVU_INIT_TIMEOUT: 3000,\n\n    // 处理间隔时间(毫秒) - 避免频繁触发\n    DEBOUNCE_DELAY: 500,\n\n    // 角色别名映射：主名称 -> 别名数组\n    // 用于处理一体双魂、昵称等特殊情况\n    // 示例：'虞汐颜': ['虞汐', '虞颜'] - 提到虞汐或虞颜都会匹配虞汐颜\n    CHARACTER_ALIASES: {\n        '虞汐颜': ['虞汐', '虞颜'],\n        // 可以继续添加其他角色的别名\n        // '白清弦': ['白师姐', '清弦师姐'],\n    } as Record<string, string[]>,\n\n    // 在 AI 回复后保持开启的条目类型（仅在 balanced 模式下生效）\n    KEEP_ENABLED_AFTER_REPLY: [\n        /^\\[系统\\]/,\n        /^\\[mvu_update\\]/,\n        /^\\[mvu\\]变量列表$/,\n        /^\\[红颜索引\\]$/,\n        /^\\[地图\\]/,  // 保持当前地图开启\n        /^\\[境界\\]/,  // 保持当前境界开启\n    ],\n};\n\n// ============================================================================\n// 地图智能匹配 - 映射表\n// ============================================================================\n\n/** 区域名/地点名 → 对应的地图条目名（[地图] 后面的部分） */\nconst REGION_TO_MAP: Record<string, string[]> = {\n    // 五大主域 - 直接匹配\n    '神州': ['神州'],\n    '东苍': ['东苍'],\n    '西庚': ['西庚'],\n    '南炎': ['南炎'],\n    '北冥': ['北冥'],\n    // 四海\n    '四海': ['四海'],\n    '潮音海': ['四海'],\n    '龙眠海': ['四海'],\n    '蓬莱幻海': ['四海'],\n    '归墟之海': ['四海', '归墟'],\n    // 天层\n    '天渊': ['天渊'],\n    '九天罡风带': ['天渊'],\n    // 下层禁地\n    '归墟': ['归墟'],\n    '黄泉古迹': ['黄泉古迹'],\n    '无尽炎渊': ['无尽炎渊'],\n    '雷暴海': ['雷暴海'],\n    // 地点库中的具体地点 → 所属域的地图\n    '问道峰': ['神州'], '藏书阁': ['神州'], '酆都城': ['神州'],\n    '九曲天河': ['神州'], '龙门瀑布': ['神州'], '剑门关': ['神州'],\n    '建木森林': ['东苍'], '青帝陵': ['东苍'], '百花秘境': ['东苍'],\n    '万剑冢': ['西庚'], '庚金矿脉': ['西庚'], '白虎峡谷': ['西庚'],\n    '不灭火山': ['南炎'], '地火窟': ['南炎'], '涅槃台': ['南炎'],\n    '玄冰山': ['北冥'], '归墟海眼': ['北冥', '归墟'], '冥海': ['北冥'],\n    // 常见缩写与变体（确保 AI 常见简写也能第一层匹配）\n    '黄泉': ['黄泉古迹'], '炎渊': ['无尽炎渊'],\n    '冥河': ['黄泉古迹'], '彼岸花海': ['黄泉古迹'], '冥河滩涂': ['黄泉古迹'],\n    '九天': ['天渊'], '罡风': ['天渊'],\n    '龙门瀑': ['神州'],\n    '建木林': ['东苍'], '建木': ['东苍'], '百花境': ['东苍'],\n    '庚金': ['西庚'],\n    '玄冰': ['北冥'], '归墟眼': ['北冥', '归墟'],\n};\n\n/** 层级 → 默认地图（当无法精确匹配时的兜底） */\nconst LAYER_TO_DEFAULT_MAP: Record<string, string> = {\n    '天层': '天渊',\n    '地层': '神州',\n    '下层': '归墟',\n};\n\n/** 域(domain) → 对应的地图条目名（用于通过地点库反查所属地图） */\nconst DOMAIN_TO_MAP: Record<string, string[]> = {\n    '天层': ['天渊'],\n    '神州': ['神州'],\n    '东苍': ['东苍'],\n    '南炎': ['南炎'],\n    '西庚': ['西庚'],\n    '北冥': ['北冥'],\n    // 注意：不映射 '下层'，因为下层有多个子区域（归墟/黄泉古迹/无尽炎渊/雷暴海），\n    // 应通过 所属层级 精确匹配子区域，而非笼统映射到某一个\n    '四海': ['四海'],\n};\n\n/** 上一次成功匹配的地图（惯性推断缓存，用于处理 AI 生成的未知地名） */\nlet lastSuccessfulMaps: Set<string> | null = null;\n\n// ============================================================================\n// 地图智能匹配 - 辅助函数\n// ============================================================================\n\n/** 常见的无意义后缀，AI 经常附加在区域名后面 */\nconst REGION_SUFFIXES = [\n    '大陆', '星域', '区域', '领地', '境内', '外围', '深处', '入口', '边缘',\n    '腹地', '中心', '核心', '内部', '附近', '周边', '一带', '地区', '之地',\n    '所在', '方向', '地带', '范围', '以内', '以外', '上方', '下方', '之中',\n    '之内', '之外', '地域', '界域', '空间', '世界', '地界',\n];\n\n/**\n * 归一化区域名：剥离括号、引号、常见后缀、空白等，返回清理后的名称\n *\n * 示例：\n * - \"黄泉古迹（冥河滩涂）\" → \"黄泉古迹\"\n * - \"东苍大陆\" → \"东苍\"\n * - \"天渊星域\" → \"天渊\"\n * - \"  归墟·深渊  \" → \"归墟·深渊\"\n * - \"「问道峰」\" → \"问道峰\"\n */\nfunction normalizeRegionName(name: string): string {\n    if (!name) return '';\n    let result = name.trim();\n    // 1. 剥离各种括号及其内容\n    result = result.replace(/[（(][^）)]*[）)]/g, '');\n    result = result.replace(/[「『【《][^」』】》]*[」』】》]/g, '');\n    // 2. 剥离引号\n    result = result.replace(/[\"\"''「」]/g, '');\n    // 3. 剥离常见无意义后缀（从长到短匹配，避免 \"大\" 误剥离）\n    const sortedSuffixes = [...REGION_SUFFIXES].sort((a, b) => b.length - a.length);\n    for (const suffix of sortedSuffixes) {\n        if (result.endsWith(suffix) && result.length > suffix.length) {\n            result = result.slice(0, -suffix.length);\n            break; // 只剥一次，避免过度剥离\n        }\n    }\n    return result.trim();\n}\n\n/**\n * 对输入名称进行多策略匹配，返回所有匹配到的地图名\n *\n * 匹配策略（按优先级）：\n * 1. 精确匹配（原始名 + 归一化名）\n * 2. 分段匹配（按分隔符拆分后，每段做精确 + 归一化匹配）\n * 3. 包含匹配（输入包含 key 或 key 包含输入）\n * 4. 分段后的包含匹配\n */\nfunction fuzzyMatchRegionToMaps(input: string, debugPrefix?: string): string[] {\n    if (!input) return [];\n    const results = new Set<string>();\n    const normalized = normalizeRegionName(input);\n\n    // === 策略 1：精确匹配（原始 + 归一化） ===\n    for (const candidate of new Set([input, normalized])) {\n        if (candidate && REGION_TO_MAP[candidate]) {\n            REGION_TO_MAP[candidate].forEach(m => results.add(m));\n            if (CONFIG.DEBUG && debugPrefix) {\n                console.log(`[动态世界书] ${debugPrefix}精确匹配: \"${candidate}\" → [${REGION_TO_MAP[candidate].join(',')}]`);\n            }\n        }\n    }\n\n    // === 策略 2：分段匹配 ===\n    // 处理 \"下层·黄泉古迹·彼岸花海\" → [\"下层\", \"黄泉古迹\", \"彼岸花海\"]\n    const segments = new Set<string>();\n    for (const candidate of new Set([input, normalized])) {\n        if (!candidate) continue;\n        candidate.split(/[·、/\\\\—\\-～~]/).forEach(s => {\n            const trimmed = s.trim();\n            if (trimmed) {\n                segments.add(trimmed);\n                const norm = normalizeRegionName(trimmed);\n                if (norm && norm !== trimmed) segments.add(norm);\n            }\n        });\n    }\n    for (const seg of segments) {\n        if (REGION_TO_MAP[seg]) {\n            const before = results.size;\n            REGION_TO_MAP[seg].forEach(m => results.add(m));\n            if (CONFIG.DEBUG && debugPrefix && results.size > before) {\n                console.log(`[动态世界书] ${debugPrefix}分段匹配: \"${seg}\" → [${REGION_TO_MAP[seg].join(',')}]`);\n            }\n        }\n    }\n\n    // 如果前两层已有结果，直接返回（精确度足够高）\n    if (results.size > 0) return [...results];\n\n    // === 策略 3：包含匹配（归一化后） ===\n    // \"黄泉古迹深处\" 归一化为 \"黄泉古迹\" → 包含 key \"黄泉古迹\" ✅\n    // \"冥河滩涂\" → key \"冥河\" 被包含 ✅\n    for (const [regionKey, maps] of Object.entries(REGION_TO_MAP)) {\n        if (regionKey.length < 2) continue; // 跳过太短的 key\n        if (normalized.includes(regionKey) || regionKey.includes(normalized)) {\n            maps.forEach(m => results.add(m));\n            if (CONFIG.DEBUG && debugPrefix) {\n                console.log(`[动态世界书] ${debugPrefix}包含匹配: \"${normalized}\" ↔ \"${regionKey}\" → [${maps.join(',')}]`);\n            }\n        }\n    }\n\n    if (results.size > 0) return [...results];\n\n    // === 策略 4：分段后的包含匹配 ===\n    for (const seg of segments) {\n        if (seg.length < 2) continue;\n        for (const [regionKey, maps] of Object.entries(REGION_TO_MAP)) {\n            if (regionKey.length < 2) continue;\n            if (seg.includes(regionKey) || regionKey.includes(seg)) {\n                maps.forEach(m => results.add(m));\n                if (CONFIG.DEBUG && debugPrefix) {\n                    console.log(`[动态世界书] ${debugPrefix}分段包含匹配: \"${seg}\" ↔ \"${regionKey}\" → [${maps.join(',')}]`);\n                }\n            }\n        }\n    }\n\n    return [...results];\n}\n\n/** 消息关键词 → 应额外启用的地图 */\nconst KEYWORD_TO_MAP: Record<string, string[]> = {\n    // 北冥相关\n    '玄武': ['北冥'], '鲛人': ['北冥'], '冥船': ['北冥'],\n    // 南炎相关\n    '朱雀': ['南炎'], '离火宫': ['南炎'], '炎魔': ['南炎'], '铸剑山庄': ['南炎'],\n    // 东苍相关\n    '青龙': ['东苍'], '建木': ['东苍'], '悬空城': ['东苍'],\n    // 西庚相关\n    '白虎': ['西庚'], '兵家': ['西庚'], '慕容世家': ['西庚'],\n    // 禁地相关\n    '归墟': ['归墟'], '黄泉': ['黄泉古迹'], '炎渊': ['无尽炎渊'],\n    '祝融': ['无尽炎渊'], '雷暴': ['雷暴海'],\n    // 天层相关\n    '天渊': ['天渊'], '星辰碎片': ['天渊'], '龙凤战场': ['天渊'],\n};\n\n// ============================================================================\n// 规则定义 - 根据你的角色卡自定义这些规则\n// ============================================================================\n\ninterface WorldbookRule {\n    /** 条目名称匹配模式 */\n    entryPattern: string | RegExp;\n    /** 启用条件（context: 上下文, entryName: 条目名称） */\n    shouldEnable: (context: Context, entryName?: string) => boolean;\n    /** 优先级（数字越大越优先，默认 0） */\n    priority?: number;\n}\n\ninterface Context {\n    /** 当前所在区域 */\n    currentRegion: string;\n    /** 所属层级（如 黄泉古迹、东苍、天层 等，比 当前区域 更宏观） */\n    currentLayer: string;\n    /** 最近消息内容 */\n    recentMessages: string[];\n    /** MVU 变量数据 */\n    mvuData: ReturnType<typeof Schema.parse> | null;\n}\n\nconst RULES: WorldbookRule[] = [\n    // ============================================================================\n    // 系统设定 - 始终启用（蓝灯）\n    // ============================================================================\n    {\n        entryPattern: /^\\[系统\\]/,\n        shouldEnable: () => true,\n        priority: 100,\n    },\n    {\n        entryPattern: /^\\[mvu_update\\]/,\n        shouldEnable: () => true,\n        priority: 100,\n    },\n    {\n        entryPattern: /^\\[mvu\\]变量列表$/,\n        shouldEnable: () => true,\n        priority: 100,\n    },\n\n    // ============================================================================\n    // 地图相关 - 世界空间结构始终启用\n    // ============================================================================\n    {\n        entryPattern: '[地图] 世界空间结构',\n        shouldEnable: () => true,\n        priority: 100,\n    },\n\n    // ============================================================================\n    // 地图相关 - 智能多层匹配（精确区域 → 地点库域 → 层级兜底 → 关键词补充）\n    // ============================================================================\n    {\n        entryPattern: /^\\[地图\\]\\s*(.+)$/,\n        shouldEnable: (ctx, entryName) => {\n            if (!entryName) return false;\n            const match = entryName.match(/^\\[地图\\]\\s*(.+)$/);\n            if (!match) return false;\n            const mapName = match[1].trim();\n\n            // 世界空间结构由上面的规则管理\n            if (mapName === '世界空间结构') return true;\n\n            const shouldEnableMaps = new Set<string>();\n\n            // ====================================================================\n            // 第1层：智能模糊匹配当前区域和所属层级\n            // 内部自动处理：精确→归一化→分段→包含→前缀 多策略匹配\n            // ====================================================================\n            fuzzyMatchRegionToMaps(ctx.currentRegion, '区域→').forEach(m => shouldEnableMaps.add(m));\n            fuzzyMatchRegionToMaps(ctx.currentLayer, '层级→').forEach(m => shouldEnableMaps.add(m));\n\n            // ====================================================================\n            // 第1.5层：通过地点库查找所属域（处理 AI 动态创建的地点）\n            // ====================================================================\n            if (shouldEnableMaps.size === 0 && ctx.currentRegion && ctx.mvuData?.地点库) {\n                const normalized = normalizeRegionName(ctx.currentRegion);\n                // 精确匹配 + 归一化匹配\n                const locationData = ctx.mvuData.地点库[ctx.currentRegion] || ctx.mvuData.地点库[normalized];\n                if (locationData?.域) {\n                    const domainMaps = DOMAIN_TO_MAP[locationData.域];\n                    if (domainMaps) {\n                        domainMaps.forEach(m => shouldEnableMaps.add(m));\n                        if (CONFIG.DEBUG) {\n                            console.log(`[动态世界书] 地点库域匹配: ${ctx.currentRegion} → 域=${locationData.域}`);\n                        }\n                    }\n                }\n                // 遍历地点库做包含匹配（处理 \"冥河滩涂\" 包含 \"冥河\" 等情况）\n                if (shouldEnableMaps.size === 0 && normalized.length >= 2) {\n                    for (const [locName, locData] of Object.entries(ctx.mvuData.地点库)) {\n                        if (locName.length < 2) continue;\n                        if (normalized.includes(locName) || locName.includes(normalized)) {\n                            const domainMaps = DOMAIN_TO_MAP[locData.域];\n                            if (domainMaps) {\n                                domainMaps.forEach(m => shouldEnableMaps.add(m));\n                                if (CONFIG.DEBUG) {\n                                    console.log(`[动态世界书] 地点库包含匹配: \"${normalized}\" ↔ \"${locName}\" → 域=${locData.域}`);\n                                }\n                                break;\n                            }\n                        }\n                    }\n                }\n            }\n\n            // 更新惯性缓存（仅在有确信匹配时更新，不受后续层级影响）\n            if (shouldEnableMaps.size > 0) {\n                lastSuccessfulMaps = new Set(shouldEnableMaps);\n            }\n\n            // ====================================================================\n            // 第1.8层：惯性推断（沿用上一次成功匹配的地图，处理 AI 生成的完全未知地名）\n            // ====================================================================\n            if (shouldEnableMaps.size === 0 && lastSuccessfulMaps && lastSuccessfulMaps.size > 0) {\n                lastSuccessfulMaps.forEach(m => shouldEnableMaps.add(m));\n                if (CONFIG.DEBUG) {\n                    console.log(`[动态世界书] 惯性推断: 沿用上次匹配 [${[...lastSuccessfulMaps].join(',')}]`);\n                }\n            }\n\n            // ====================================================================\n            // 第2层：层级兜底（当所有匹配和惯性推断均无结果时，如冷启动场景）\n            // ====================================================================\n            if (shouldEnableMaps.size === 0 && ctx.mvuData?.本尊?.行踪?.所属层级) {\n                const layer = normalizeRegionName(ctx.mvuData.本尊.行踪.所属层级);\n                if (LAYER_TO_DEFAULT_MAP[layer]) {\n                    shouldEnableMaps.add(LAYER_TO_DEFAULT_MAP[layer]);\n                }\n            }\n\n            // ====================================================================\n            // 第3层：消息关键词补充（仅在前面所有层级都无匹配时才作为兜底）\n            // ====================================================================\n            if (shouldEnableMaps.size === 0) {\n                for (const [keyword, maps] of Object.entries(KEYWORD_TO_MAP)) {\n                    if (ctx.recentMessages.some(msg => msg.includes(keyword))) {\n                        maps.forEach(m => shouldEnableMaps.add(m));\n                    }\n                }\n            }\n\n            // 兜底：如果没有任何匹配，默认启用神州\n            if (shouldEnableMaps.size === 0) {\n                shouldEnableMaps.add('神州');\n            }\n\n            const isMatch = shouldEnableMaps.has(mapName);\n\n            if (CONFIG.DEBUG && isMatch) {\n                console.log(`[动态世界书] 地图匹配成功: ${mapName} (当前区域=${ctx.currentRegion}, 层级=${ctx.currentLayer}, 启用集=[${[...shouldEnableMaps].join(',')}])`);\n            }\n\n            return isMatch;\n        },\n        priority: 10,\n    },\n\n    // ============================================================================\n    // 角色相关 - 精确匹配角色名和阶段（支持别名）\n    // ============================================================================\n    // 1. 带阶段的角色条目（如：[角色] 凌寒镜 - 心动期）\n    {\n        entryPattern: /^\\[角色\\]\\s*(.+?)\\s*-\\s*(陌生期|好感期|心动期|确认期|深爱期)$/,\n        shouldEnable: (ctx, entryName) => {\n            if (!entryName) return false;\n            const match = entryName.match(/^\\[角色\\]\\s*(.+?)\\s*-\\s*(陌生期|好感期|心动期|确认期|深爱期)$/);\n            if (!match) return false;\n\n            const characterName = match[1].trim();\n            const stageName = match[2];\n\n            // 检查角色是否在红颜列表中\n            const hongyanData = ctx.mvuData?.红颜?.[characterName];\n            if (!hongyanData) {\n                if (CONFIG.DEBUG) {\n                    console.log(`[动态世界书] 角色不在红颜列表中: ${characterName}`);\n                }\n                return false;\n            }\n\n            // 【修复】如果没有消息（开局），直接根据好感度阶段开启，不检查提及\n            const hasMessages = ctx.recentMessages.length > 0;\n\n            // 如果有消息，需要检查是否被提及\n            if (hasMessages) {\n                // 获取角色的所有可能名称（主名称 + 别名）\n                const allNames = [characterName];\n                if (CONFIG.CHARACTER_ALIASES[characterName]) {\n                    allNames.push(...CONFIG.CHARACTER_ALIASES[characterName]);\n                }\n\n                // 检查是否提到任何一个名称\n                let isMentioned = false;\n                for (const name of allNames) {\n                    const escaped = name.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n                    const nameRegex = new RegExp(\n                        `(?:^|[^\\\\p{Script=Han}\\\\w])(${escaped})(?:[^\\\\p{Script=Han}\\\\w]|$)`,\n                        'u'\n                    );\n                    if (ctx.recentMessages.some(msg => nameRegex.test(msg))) {\n                        isMentioned = true;\n                        if (CONFIG.DEBUG) {\n                            console.log(`[动态世界书] 匹配到别名: ${name} -> ${characterName}`);\n                        }\n                        break;\n                    }\n                }\n\n                if (!isMentioned) {\n                    if (CONFIG.DEBUG) {\n                        console.log(`[动态世界书] 角色未在近期消息中提及: ${characterName} (含别名)`);\n                    }\n                    return false;\n                }\n            } else {\n                if (CONFIG.DEBUG) {\n                    console.log(`[动态世界书] 开局无消息，直接根据好感度阶段开启: ${characterName}`);\n                }\n            }\n\n            // 好感度阶段精确映射\n            const favorStages: Record<string, [number, number]> = {\n                '陌生期': [-100, 20],\n                '好感期': [21, 40],\n                '心动期': [41, 60],\n                '确认期': [61, 80],\n                '深爱期': [81, 100],\n            };\n\n            const range = favorStages[stageName];\n            if (!range) return false;\n\n            const favor = hongyanData.好感度 ?? 0;\n            const isInRange = favor >= range[0] && favor <= range[1];\n\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 角色阶段匹配: ${characterName} - ${stageName}, 好感度=${favor}, 范围=[${range[0]}, ${range[1]}], 匹配=${isInRange}`);\n            }\n\n            return isInRange;\n        },\n        priority: 9,\n    },\n\n    // 2. 基础角色条目（如：[角色] 凌寒镜）- 支持别名匹配，开局时根据红颜列表开启\n    {\n        entryPattern: /^\\[角色\\]\\s*([^-]+)$/,\n        shouldEnable: (ctx, entryName) => {\n            if (!entryName) return false;\n            const match = entryName.match(/^\\[角色\\]\\s*([^-]+)$/);\n            if (!match) return false;\n            const characterName = match[1].trim();\n\n            // 【调试】检查上下文消息\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 🔍 检查角色: ${characterName}`);\n                console.log(`[动态世界书] 🔍 最近消息 (${ctx.recentMessages.length}条):`, ctx.recentMessages);\n            }\n\n            // 【关键修复】检查这是不是某个角色的别名条目\n            // 如果是别名条目，找到它对应的主角色名\n            let mainCharacterName = characterName;\n            let isAliasEntry = false;\n            \n            for (const [mainName, aliases] of Object.entries(CONFIG.CHARACTER_ALIASES)) {\n                if (aliases.includes(characterName)) {\n                    mainCharacterName = mainName;\n                    isAliasEntry = true;\n                    if (CONFIG.DEBUG) {\n                        console.log(`[动态世界书] 🔗 识别到别名条目: ${characterName} -> 主角色: ${mainName}`);\n                    }\n                    break;\n                }\n            }\n\n            // 【关键修复】开局时直接根据红颜列表开启（使用主角色名检查）\n            const hasMessages = ctx.recentMessages.length > 0;\n            \n            if (!hasMessages) {\n                // 开局：检查主角色是否在红颜列表中\n                const isInHongyan = ctx.mvuData?.红颜?.[mainCharacterName] !== undefined;\n                \n                if (CONFIG.DEBUG) {\n                    if (isInHongyan) {\n                        console.log(`[动态世界书] ✅ 开局-应该开启: ${characterName}${isAliasEntry ? ` (主角色: ${mainCharacterName})` : ''} (在红颜列表中)`);\n                    } else {\n                        console.log(`[动态世界书] ❌ 开局-不应开启: ${characterName}${isAliasEntry ? ` (主角色: ${mainCharacterName})` : ''} (不在红颜列表中)`);\n                    }\n                }\n                \n                return isInHongyan;\n            }\n\n            // 有消息：检查提及次数\n            // 如果这是别名条目，检查这个别名是否被提及\n            // 如果这是主条目，检查主名称或任何别名是否被提及\n            let checkNames: string[];\n            \n            if (isAliasEntry) {\n                // 别名条目：只检查这个别名本身\n                checkNames = [characterName];\n            } else {\n                // 主条目：检查主名称 + 所有别名\n                checkNames = [characterName];\n                if (CONFIG.CHARACTER_ALIASES[characterName]) {\n                    checkNames.push(...CONFIG.CHARACTER_ALIASES[characterName]);\n                }\n            }\n\n            // 累计所有名称的提及次数\n            let mentionCount = 0;\n            const mentionDetails: string[] = [];\n            \n            for (const name of checkNames) {\n                const escaped = name.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n                const nameRegex = new RegExp(\n                    `(?:^|[^\\\\p{Script=Han}\\\\w])(${escaped})(?:[^\\\\p{Script=Han}\\\\w]|$)`,\n                    'u'\n                );\n                const count = ctx.recentMessages.filter(msg => nameRegex.test(msg)).length;\n                \n                if (count > 0) {\n                    mentionCount += count;\n                    mentionDetails.push(`${name}(${count}次)`);\n                    \n                    if (CONFIG.DEBUG) {\n                        console.log(`[动态世界书] 🔍 匹配到: ${name}, 正则=${nameRegex}, 次数=${count}`);\n                    }\n                }\n            }\n\n            // 【严格】必须在最近消息中被明确提及至少1次才开启\n            const shouldEnable = mentionCount >= 1;\n\n            if (CONFIG.DEBUG) {\n                const typeInfo = isAliasEntry ? ` [别名条目 -> ${mainCharacterName}]` : '';\n                const aliasInfo = !isAliasEntry && CONFIG.CHARACTER_ALIASES[characterName]\n                    ? ` [别名: ${CONFIG.CHARACTER_ALIASES[characterName].join(', ')}]`\n                    : '';\n                const detailInfo = mentionDetails.length > 0 ? ` 提及详情: ${mentionDetails.join(', ')}` : '';\n                \n                if (shouldEnable) {\n                    console.log(`[动态世界书] ✅ 应该开启: ${characterName}${typeInfo}${aliasInfo}, 累计提及=${mentionCount}次${detailInfo}`);\n                } else {\n                    console.log(`[动态世界书] ❌ 不应开启: ${characterName}${typeInfo}${aliasInfo}, 累计提及=${mentionCount}次 (需≥1次)`);\n                }\n            }\n\n            return shouldEnable;\n        },\n        priority: 8,\n    },\n\n    // ============================================================================\n    // 境界相关 - 精确匹配当前境界等级\n    // ============================================================================\n    {\n        entryPattern: /^\\[境界\\]\\s*(.+)$/,\n        shouldEnable: (ctx, entryName) => {\n            if (!entryName) return false;\n            const match = entryName.match(/^\\[境界\\]\\s*(.+)$/);\n            if (!match) return false;\n            const realmName = match[1].trim();\n            const level = ctx.mvuData?.本尊?.等级 ?? 1;\n\n            // 境界等级映射（根据踏月寻仙设定，与 schema.ts 保持一致）\n            const realmRanges: Record<string, [number, number]> = {\n                '练气': [1, 4],\n                '筑基': [5, 8],\n                '金丹': [9, 12],\n                '元婴': [13, 16],\n                '化神': [17, 20],\n                '炼虚': [21, 24],  // 修正：schema 中是\"炼虚\"而非\"合体\"\n                '合体': [25, 28],\n                '大乘': [29, 32],\n                '渡劫': [33, 36],\n            };\n\n            const range = realmRanges[realmName];\n            if (!range) {\n                if (CONFIG.DEBUG) {\n                    console.log(`[动态世界书] 未知境界名称: ${realmName}`);\n                }\n                return false;\n            }\n\n            const isInRange = level >= range[0] && level <= range[1];\n\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 境界匹配: ${realmName}, 等级=${level}, 范围=[${range[0]}, ${range[1]}], 匹配=${isInRange}`);\n            }\n\n            return isInRange;\n        },\n        priority: 7,\n    },\n\n    // ============================================================================\n    // 红颜索引 - 始终启用\n    // ============================================================================\n    {\n        entryPattern: /^\\[红颜索引\\]$/,\n        shouldEnable: () => true,\n        priority: 100,\n    },\n\n    // ============================================================================\n    // 物品/法宝/功法/势力/地点库 - 精确匹配条目\n    // ============================================================================\n    {\n        entryPattern: /^\\[(物品|法宝|功法|势力|地点|灵根|体质)\\]\\s*(.+)$/,\n        shouldEnable: (ctx, entryName) => {\n            if (!entryName) return false;\n            const match = entryName.match(/^\\[(物品|法宝|功法|势力|地点|灵根|体质)\\]\\s*(.+)$/);\n            if (!match) return false;\n\n            const category = match[1];\n            const itemName = match[2].trim();\n\n            // 精确匹配：物品名必须在消息中完整出现\n            const escaped = itemName.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n            const itemRegex = new RegExp(escaped, 'u');\n\n            // 检查最近消息中是否提到\n            const mentionCount = ctx.recentMessages.filter(msg => itemRegex.test(msg)).length;\n\n            // 至少提到2次才启用（避免误触发）\n            const shouldEnable = mentionCount >= 2;\n\n            if (CONFIG.DEBUG && mentionCount > 0) {\n                console.log(`[动态世界书] ${category}匹配: ${itemName}, 提及次数=${mentionCount}, 启用=${shouldEnable}`);\n            }\n\n            return shouldEnable;\n        },\n        priority: 5,\n    },\n];\n\n// ============================================================================\n// 动态世界书核心逻辑\n// ============================================================================\n\nlet isProcessing = false;\nlet lastProcessTime = 0;\n\n/**\n * 安全地等待 MVU 初始化,带超时机制\n */\nasync function waitForMvu(): Promise<boolean> {\n    try {\n        // 创建超时 Promise\n        const timeoutPromise = new Promise<boolean>((resolve) => {\n            setTimeout(() => resolve(false), CONFIG.MVU_INIT_TIMEOUT);\n        });\n\n        // 创建初始化 Promise\n        const initPromise = (async () => {\n            await waitGlobalInitialized('Mvu');\n            return true;\n        })();\n\n        // 竞速,返回先完成的\n        return await Promise.race([initPromise, timeoutPromise]);\n    } catch (e) {\n        console.warn('[动态世界书] MVU 初始化等待失败', e);\n        return false;\n    }\n}\n\nasync function getContext(): Promise<Context | null> {\n    // 安全地等待 MVU 初始化\n    const mvuReady = await waitForMvu();\n    if (!mvuReady) {\n        if (CONFIG.DEBUG) {\n            console.log('[动态世界书] MVU 未就绪,跳过本次更新');\n        }\n        return null;\n    }\n\n    // 获取最近的消息（安全地获取，避免消息数不足导致错误）\n    let recentMessages: string[] = [];\n    try {\n        // 获取最后消息 ID\n        const lastMessageId = getLastMessageId();\n        if (lastMessageId >= 0) {\n            // 有消息，获取所有消息\n            const allMessages = getChatMessages(`0-${lastMessageId}`);\n            if (allMessages && allMessages.length > 0) {\n                // 取最近的 N 条消息\n                recentMessages = allMessages\n                    .slice(-CONFIG.CONTEXT_WINDOW)\n                    .map(m => {\n                        let content = m.message || '';\n                        \n                        // 【修复】移除不应作为剧情内容的各种标记和代码块\n                        // 1. 移除动态世界书的调试日志（如：[动态世界书] 检查角色: xxx）\n                        content = content.replace(/\\[动态世界书\\][^\\n]*/g, '');\n                        \n                        // 2. 移除 MVU 更新日志（如：【匹配开启: xxx】、【不应开启: xxx】等）\n                        content = content.replace(/【[^】]*】/g, '');\n                        \n                        // 3. 移除 UpdateVariable 标签块（包含变量初始化数据，不是剧情内容）\n                        content = content.replace(/<UpdateVariable>[\\s\\S]*?<\\/UpdateVariable>/g, '');\n                        \n                        // 4. 移除 mvu 更新命令块（如：```mvu_update ... ```）\n                        content = content.replace(/```mvu_update[\\s\\S]*?```/g, '');\n                        \n                        // 5. 移除其他代码块（但保留正文）\n                        content = content.replace(/```[\\s\\S]*?```/g, '');\n                        \n                        return content.trim();\n                    })\n                    .filter(msg => msg.length > 0); // 过滤掉空消息\n                \n                if (CONFIG.DEBUG) {\n                    console.log(`[动态世界书] 🔍 过滤后的消息内容:`, recentMessages);\n                }\n            }\n        }\n    } catch (e) {\n        // 获取失败，使用空数组\n        if (CONFIG.DEBUG) {\n            console.warn('[动态世界书] 获取消息失败', e);\n        }\n        recentMessages = [];\n    }\n\n    // 获取 MVU 数据\n    let mvuData: ReturnType<typeof Schema.parse> | null = null;\n    try {\n        // 先尝试从最后一楼获取\n        const lastMessageId = getLastMessageId();\n        if (lastMessageId >= 0) {\n            const variables = getVariables({ type: 'message', message_id: -1 });\n            const statData = _.get(variables, 'stat_data', null);\n            if (statData) {\n                mvuData = Schema.parse(statData);\n            }\n        }\n\n        // 如果没有获取到,返回 null 表示数据未就绪\n        if (!mvuData) {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] MVU 数据未就绪,跳过本次更新');\n            }\n            return null;\n        }\n    } catch (e) {\n        console.warn('[动态世界书] 获取 MVU 数据失败', e);\n        return null;\n    }\n\n    const currentRegion = mvuData?.本尊?.行踪?.当前区域 ?? '未知';\n    const currentLayer = mvuData?.本尊?.行踪?.所属层级 ?? '';\n\n    if (CONFIG.DEBUG) {\n        console.log(`[动态世界书] 上下文: 区域=\"${currentRegion}\", 层级=\"${currentLayer}\", 消息数=${recentMessages.length}`);\n    }\n\n    return {\n        currentRegion,\n        currentLayer,\n        recentMessages,\n        mvuData,\n    };\n}\n\n/**\n * 更新世界书条目\n * @param mode 'enable' - 用户输入前启用相关条目; 'disable' - AI回复后禁用非核心条目\n */\nasync function updateWorldbookEntries(mode: 'enable' | 'disable' = 'enable') {\n    // 防抖处理 - 避免频繁触发\n    const now = Date.now();\n    if (now - lastProcessTime < CONFIG.DEBOUNCE_DELAY) {\n        if (CONFIG.DEBUG) {\n            console.log('[动态世界书] 触发过于频繁,跳过本次更新');\n        }\n        return;\n    }\n    lastProcessTime = now;\n\n    if (isProcessing) {\n        if (CONFIG.DEBUG) {\n            console.log('[动态世界书] 正在处理中，跳过本次更新');\n        }\n        return;\n    }\n    isProcessing = true;\n\n    try {\n        const context = await getContext();\n\n        // 如果上下文获取失败(MVU未初始化),直接返回,不报错\n        if (!context) {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 上下文未就绪,跳过本次更新');\n            }\n            return;\n        }\n\n        // 获取世界书名称\n        let worldbookName = CONFIG.WORLDBOOK_NAME;\n        if (worldbookName === 'current') {\n            const charWorldbooks = getCharWorldbookNames('current');\n            worldbookName = charWorldbooks.primary || '';\n            if (!worldbookName) {\n                console.warn('[动态世界书] 当前角色卡没有绑定主世界书');\n                return;\n            }\n        }\n\n        let enabledCount = 0;\n        let disabledCount = 0;\n        let totalProcessed = 0;\n\n        // 按优先级排序规则\n        const sortedRules = [...RULES].sort((a, b) => (b.priority ?? 0) - (a.priority ?? 0));\n\n        // 使用 updateWorldbookWith 更新世界书\n        await updateWorldbookWith(worldbookName, worldbook => {\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 开始处理世界书 [${mode}模式]: ${worldbookName}, 共 ${worldbook.length} 个条目`);\n                console.log(`[动态世界书] 当前上下文: 区域=\"${context.currentRegion}\", 等级=${context.mvuData?.本尊?.等级 ?? '未知'}, 消息数=${context.recentMessages.length}`);\n            }\n\n            for (const entry of worldbook) {\n                // 【关键修改】不跳过未启用的条目，因为我们要管理所有条目\n                // 但条目本身必须是 enabled: true 才能被酒馆加载\n                if (!entry.enabled) {\n                    continue;\n                }\n\n                const entryName = entry.name || '';\n                if (!entryName) {\n                    if (CONFIG.DEBUG) {\n                        console.warn('[动态世界书] 发现无名称条目，跳过');\n                    }\n                    continue;\n                }\n\n                let matchedRule: WorldbookRule | null = null;\n\n                // 查找匹配的规则（按优先级从高到低）\n                for (const rule of sortedRules) {\n                    const matches =\n                        typeof rule.entryPattern === 'string'\n                            ? entryName.includes(rule.entryPattern)\n                            : rule.entryPattern.test(entryName);\n\n                    if (matches) {\n                        matchedRule = rule;\n                        break; // 找到第一个匹配的规则就停止\n                    }\n                }\n\n                // 【关键修改】如果没有匹配的规则，说明这个条目不受动态管理\n                // 对于不受管理的条目，保持其原有状态\n                if (!matchedRule) {\n                    continue;\n                }\n\n                const currentType = entry.strategy.type;\n\n                // 根据模式决定操作\n                if (mode === 'enable') {\n                    // 启用模式：根据规则评估是否应该启用\n                    let shouldBeConstant = false;\n                    try {\n                        shouldBeConstant = matchedRule.shouldEnable(context, entryName);\n                    } catch (e) {\n                        console.error(`[动态世界书] 评估条目 \"${entryName}\" 时出错:`, e);\n                        continue;\n                    }\n\n                    // 【关键修复】始终检查核心条目，避免误关闭\n                    const isAlwaysOn = /^\\[系统\\]/.test(entryName) ||\n                        /^\\[mvu_update\\]/.test(entryName) ||\n                        /^\\[mvu\\]变量列表$/.test(entryName) ||\n                        /^\\[红颜索引\\]$/.test(entryName);\n\n                    // 精准控制：符合条件的开启，不符合条件的关闭\n                    if (shouldBeConstant && currentType !== 'constant') {\n                        // 绿灯 → 蓝灯\n                        entry.strategy.type = 'constant';\n                        enabledCount++;\n                        totalProcessed++;\n                        if (CONFIG.DEBUG) {\n                            console.log(`[动态世界书] ✅ 开启(绿→蓝): ${entryName}`);\n                        }\n                    } else if (!shouldBeConstant && currentType === 'constant' && !isAlwaysOn) {\n                        // 蓝灯 → 绿灯（但保留核心条目）\n                        entry.strategy.type = 'selective';\n                        disabledCount++;\n                        totalProcessed++;\n                        if (CONFIG.DEBUG) {\n                            console.log(`[动态世界书] ⚠️ 关闭(蓝→绿): ${entryName}`);\n                        }\n                    }\n                } else {\n                    // 禁用模式：根据策略决定是否保留\n                    if (currentType === 'constant') {\n                        let shouldKeepEnabled = false;\n\n                        // 根据策略决定是否保留\n                        if (CONFIG.STRATEGY === 'conservative') {\n                            // 保守模式：保持所有已启用的条目\n                            shouldKeepEnabled = true;\n                        } else if (CONFIG.STRATEGY === 'balanced') {\n                            // 平衡模式：保留核心条目\n                            shouldKeepEnabled = CONFIG.KEEP_ENABLED_AFTER_REPLY.some(pattern =>\n                                pattern.test(entryName)\n                            );\n                        } else {\n                            // 激进模式：只保留最核心的系统条目\n                            shouldKeepEnabled = /^\\[系统\\]/.test(entryName) ||\n                                /^\\[mvu_update\\]/.test(entryName) ||\n                                /^\\[mvu\\]变量列表$/.test(entryName);\n                        }\n\n                        if (!shouldKeepEnabled) {\n                            entry.strategy.type = 'selective';\n                            disabledCount++;\n                            totalProcessed++;\n                            if (CONFIG.DEBUG) {\n                                console.log(`[动态世界书] ⚠️ 改为绿灯: ${entryName}`);\n                            }\n                        }\n                    }\n                }\n            }\n\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 处理完成 [${mode}模式]，修改 ${totalProcessed} 个条目 (启用 ${enabledCount} 个, 禁用 ${disabledCount} 个)`);\n            }\n\n            return worldbook;\n        });\n\n        // 输出更新摘要\n        if (enabledCount > 0 || disabledCount > 0) {\n            const modeText = mode === 'enable' ? '准备AI回复' : 'AI回复完成';\n            const message = `${modeText}: 启用 ${enabledCount} 个, 禁用 ${disabledCount} 个`;\n            console.info(`[动态世界书] ${message}`);\n            if (CONFIG.DEBUG) {\n                toastr.info(message, '动态世界书');\n            }\n        } else {\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 本次无需更新条目状态 [${mode}模式]`);\n            }\n        }\n    } catch (e) {\n        // 只在非初始化错误时报告\n        if (!(e instanceof Error && e.message.includes('MVU')) &&\n            !(e instanceof Error && e.message.includes('初始化'))) {\n            console.error('[动态世界书] 更新失败', e);\n            if (CONFIG.DEBUG) {\n                toastr.error(`更新失败: ${e instanceof Error ? e.message : '未知错误'}`, '动态世界书');\n            }\n        } else {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] MVU 相关错误,可能是正在初始化,跳过');\n            }\n        }\n    } finally {\n        isProcessing = false;\n    }\n}\n\n// ============================================================================\n// 初始化\n// ============================================================================\n\n$(() => {\n    errorCatched(async () => {\n        console.info('[动态世界书] 脚本已加载');\n        console.info(`[动态世界书] 当前策略: ${CONFIG.STRATEGY}`);\n\n        // 安全地等待 MVU 初始化\n        const mvuReady = await waitForMvu();\n        if (mvuReady) {\n            console.info('[动态世界书] MVU 框架已初始化');\n\n            // 延迟初始检查,确保所有数据都已就绪\n            await new Promise(resolve => setTimeout(resolve, 1500));\n            await updateWorldbookEntries('enable');\n            console.info('[动态世界书] 初始化检查完成');\n        } else {\n            console.warn('[动态世界书] MVU 初始化超时,将在后续事件中尝试');\n        }\n\n        // ========================================================================\n        // 核心逻辑：用户输入前启用，AI回复后禁用\n        // ========================================================================\n\n        // 监听用户发送消息 - 在用户输入后、AI 回复前启用相关条目\n        eventOn(tavern_events.MESSAGE_SENT, async () => {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 🟢 用户发送消息，启用相关世界书条目');\n            }\n            await updateWorldbookEntries('enable');\n        });\n\n        // 监听重roll（切换swipe）- 相当于重新生成，需要启用相关条目\n        eventOn(tavern_events.MESSAGE_SWIPED, async (message_id: number) => {\n            if (CONFIG.DEBUG) {\n                console.log(`[动态世界书] 🔄 消息 #${message_id} 重roll，启用相关世界书条目`);\n            }\n            // 【修复】延迟等待消息内容完全更新后再处理\n            // MESSAGE_SWIPED 事件会在消息切换时立即触发，但消息内容可能还没更新完成\n            await new Promise(resolve => setTimeout(resolve, 300));\n            await updateWorldbookEntries('enable');\n        });\n\n        // 监听 AI 消息接收完成 - AI 回复后禁用非核心条目以节省 token\n        eventOn(tavern_events.MESSAGE_RECEIVED, async () => {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 🔴 AI 回复完成，禁用非核心世界书条目');\n            }\n            // 延迟一小段时间，确保消息完全接收\n            await new Promise(resolve => setTimeout(resolve, 200));\n            await updateWorldbookEntries('disable');\n        });\n\n        // ========================================================================\n        // 辅助逻辑：聊天切换、变量更新等场景\n        // ========================================================================\n\n        // 监听聊天切换事件（新开聊天或切换聊天时触发）\n        eventOn(tavern_events.CHAT_CHANGED, async () => {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 触发事件: CHAT_CHANGED');\n            }\n            // 延迟时间增加到2秒,确保聊天和MVU完全加载\n            await new Promise(resolve => setTimeout(resolve, 2000));\n            await updateWorldbookEntries('enable');\n        });\n\n        // 监听新建聊天事件\n        eventOn(tavern_events.CHAT_CREATED, async () => {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 触发事件: CHAT_CREATED');\n            }\n            // 延迟时间增加到2秒,确保聊天和MVU完全初始化\n            await new Promise(resolve => setTimeout(resolve, 2000));\n            await updateWorldbookEntries('enable');\n        });\n\n        // 监听角色页面加载完成事件（切换角色时触发）\n        eventOn(tavern_events.CHARACTER_PAGE_LOADED, async () => {\n            if (CONFIG.DEBUG) {\n                console.log('[动态世界书] 触发事件: CHARACTER_PAGE_LOADED');\n            }\n            // 延迟时间增加到2秒,确保角色和MVU完全加载\n            await new Promise(resolve => setTimeout(resolve, 2000));\n            await updateWorldbookEntries('enable');\n        });\n\n        // 监听 MVU 变量更新 - 变量更新后重新评估需要启用的条目\n        // 注意: 这个事件会频繁触发,因此使用防抖机制\n        // 只有在 MVU 初始化成功时才注册此监听器\n        if (mvuReady) {\n            eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, async () => {\n                if (CONFIG.DEBUG) {\n                    console.log('[动态世界书] 触发事件: VARIABLE_UPDATE_ENDED');\n                }\n                // 延迟100ms,避免在变量更新期间触发\n                await new Promise(resolve => setTimeout(resolve, 100));\n                await updateWorldbookEntries('enable');\n            });\n        }\n\n        const strategyText =\n            CONFIG.STRATEGY === 'aggressive' ? '激进模式（最省token）' :\n                CONFIG.STRATEGY === 'balanced' ? '平衡模式（推荐）' :\n                    '保守模式（最安全）';\n\n        console.info(`[动态世界书] 监听器已设置，策略：${strategyText}`);\n        if (mvuReady) {\n            toastr.success(`动态世界书已启用 - ${strategyText}`, '灯火阑珊');\n        } else {\n            toastr.info(`动态世界书已加载，等待MVU初始化...`, '灯火阑珊');\n        }\n    })();\n});"],"names":["z","REALM_THRESHOLDS","REALM_LIFESPANS","ItemSchema","object","string","prefault","coerce","number","transform","v","Math","max","SkillSchema","enum","catch","Date","now","optional","skill","InventorySchema","record","describe","data","_","pickBy","computeRealmInfo","includesCombatPower","level","majorIdx","floor","base","toFixed","minorIdx","pow","round","calculateBaseCombatPower","Object","values","length","map","s","includes","CharacterLibEntrySchema","clamp","array","CompanionSchema","boolean","realmInfo","NpcSchema","CombatStatusSchema","EnemySchema","TribulationSchema","LocationTrackSchema","IdentitySchema","ProtagonistSchema","QuestSchema","union","ReputationEntrySchema","ReputationSystemSchema","factions","mapValues","faction","value","OpportunitySchema","FactionSchema","TechniqueSchema","TreasureSchema","LocationSchema","SpiritRootSchema","PhysiqueSchema","Schema","layer","danger","desc","connections","WORLDBOOK_NAME","DEBUG","CONTEXT_WINDOW","STRATEGY","MVU_INIT_TIMEOUT","DEBOUNCE_DELAY","CHARACTER_ALIASES","KEEP_ENABLED_AFTER_REPLY","REGION_TO_MAP","LAYER_TO_DEFAULT_MAP","DOMAIN_TO_MAP","lastSuccessfulMaps","REGION_SUFFIXES","normalizeRegionName","name","result","trim","replace","sortedSuffixes","sort","a","b","suffix","endsWith","slice","fuzzyMatchRegionToMaps","input","debugPrefix","results","Set","normalized","candidate","forEach","m","add","console","log","join","segments","split","trimmed","norm","seg","before","size","regionKey","maps","entries","KEYWORD_TO_MAP","RULES","entryPattern","shouldEnable","priority","ctx","entryName","match","mapName","shouldEnableMaps","currentRegion","currentLayer","mvuData","locationData","domainMaps","locName","locData","keyword","recentMessages","some","msg","isMatch","has","characterName","stageName","hongyanData","allNames","push","isMentioned","escaped","nameRegex","RegExp","test","range","favor","isInRange","mainCharacterName","isAliasEntry","mainName","aliases","isInHongyan","undefined","checkNames","mentionCount","mentionDetails","count","filter","typeInfo","aliasInfo","detailInfo","realmName","category","itemName","itemRegex","isProcessing","lastProcessTime","async","waitForMvu","timeoutPromise","Promise","resolve","setTimeout","initPromise","waitGlobalInitialized","race","e","warn","updateWorldbookEntries","mode","context","lastMessageId","getLastMessageId","allMessages","getChatMessages","content","message","variables","getVariables","type","message_id","statData","get","parse","getContext","worldbookName","charWorldbooks","getCharWorldbookNames","primary","enabledCount","disabledCount","totalProcessed","sortedRules","updateWorldbookWith","worldbook","entry","enabled","matchedRule","rule","currentType","strategy","shouldBeConstant","error","isAlwaysOn","shouldKeepEnabled","pattern","info","toastr","Error","$","errorCatched","mvuReady","eventOn","tavern_events","MESSAGE_SENT","MESSAGE_SWIPED","MESSAGE_RECEIVED","CHAT_CHANGED","CHAT_CREATED","CHARACTER_PAGE_LOADED","Mvu","events","VARIABLE_UPDATE_ENDED","strategyText","success"],"ignoreList":[],"sourceRoot":""}