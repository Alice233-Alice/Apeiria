const e=z,t=[100,100,100,100,200,200,200,200,400,400,400,400,800,800,800,800,1600,1600,1600,1600,3200,3200,3200,3200,6400,6400,6400,6400,12800,12800,12800,12800,25600,25600,25600,25600],r=[100,100,100,100,200,200,200,200,500,500,500,500,1e3,1e3,1e3,1e3,2e3,2e3,2e3,2e3,5e3,5e3,5e3,5e3,1e4,1e4,1e4,1e4,5e4,5e4,5e4,5e4,1e5,1e5,1e5,1e5],n=['练气','筑基','金丹','元婴','化神','炼虚','合体','大乘','渡劫'],a=['初期','中期','后期','大圆满'],o=e.z.object({名称:e.z.string(),描述:e.z.string(),品阶:e.z.string(),数量:e.z.coerce.number()}),s={等级:e.z.coerce.number().transform(e=>_.clamp(e,1,36)),修为:e.z.coerce.number().transform(e=>Math.max(0,e)),灵根:e.z.string().prefault('五行杂灵根'),体质:e.z.string().prefault('凡体'),功法:e.z.string().prefault('无'),本命兵器:e.z.string().prefault('无'),神通列表:e.z.record(e.z.string().describe('神通名'),e.z.string().describe('神通描述')).prefault({}),灵石:e.z.coerce.number().transform(e=>Math.max(0,e)),已活岁月:e.z.coerce.number().transform(e=>Math.max(0,e)),尝试突破:e.z.boolean().prefault(!1)};function i(e){const o=e.等级,s=t[o-1]||100,i=r[o-1]||100,c=Math.floor((o-1)/4),l=`${n[c]||'练气'}${a[(o-1)%4]}`,u=`${e.已活岁月}/${i}`,p=e.尝试突破?'突破中':e.修为>=s?'瓶颈期':'修炼中',f=`${(e.修为/s*100).toFixed(1)}%`;return{...e,突破阈值:s,寿元上限:i,境界描述:l,寿元状态:u,状态:p,进度:f}}const c=e.z.object({世界时钟:e.z.object({纪元:e.z.string().prefault('末法时代'),年份:e.z.coerce.number().prefault(1)}).prefault({}),世界地图:e.z.record(e.z.string().describe('区域名'),e.z.object({layer:e.z.enum(['天层','地层','下层']).prefault('地层'),danger:e.z.coerce.number().transform(e=>_.clamp(e,0,100)),desc:e.z.string().prefault(''),connections:e.z.array(e.z.string()).prefault([])})).prefault({}),世界图志:e.z.record(e.z.string().describe('事件名'),e.z.object({状态:e.z.string().prefault(''),事件:e.z.string().prefault('')})).prefault({}),本尊:e.z.object({...s,行踪:e.z.object({当前区域:e.z.string().prefault('未知之地'),所属层级:e.z.string().optional(),环境描述:e.z.string().optional(),危险度:e.z.coerce.number().optional(),可用通道:e.z.array(e.z.string()).optional(),导航信息:e.z.string().optional()}).prefault({}),身份:e.z.object({姓名:e.z.string().prefault('无名氏'),宗门:e.z.string().prefault('散修'),出身:e.z.string().prefault('凡人')}).prefault({}),背包:e.z.record(e.z.string().describe('物品名'),o).transform(e=>_.pickBy(e,({数量:e})=>e>0)).prefault({}),法宝:e.z.record(e.z.string().describe('法宝名'),o).transform(e=>_.pickBy(e,({数量:e})=>e>0)).prefault({}),杂物袋:e.z.record(e.z.string().describe('杂物名'),o).transform(e=>_.pickBy(e,({数量:e})=>e>0)).prefault({})}).transform(i).prefault({等级:1,修为:0,灵根:'五行杂灵根',体质:'凡体',功法:'无',本命兵器:'无',灵石:0,已活岁月:16,尝试突破:!1}),红颜:e.z.record(e.z.string().describe('红颜名'),e.z.object({...s,好感度:e.z.coerce.number().transform(e=>_.clamp(e,-100,100)),关系:e.z.string().prefault('陌生人'),重要性:e.z.string().prefault('路人')}).transform(i)).prefault({}),NPC图鉴:e.z.record(e.z.string().describe('NPC名'),e.z.object({...s,所在宗门:e.z.string().prefault('散修')}).transform(i)).prefault({})});const l='current',u=!0,p=5,f=[{entryPattern:/^\[系统\]/,shouldEnable:()=>!0,priority:100},{entryPattern:/^\[mvu_update\]/,shouldEnable:()=>!0,priority:100},{entryPattern:/^变量列表$/,shouldEnable:()=>!0,priority:100},{entryPattern:/^变量更新规则$/,shouldEnable:()=>!0,priority:100},{entryPattern:/^变量输出格式$/,shouldEnable:()=>!0,priority:100},{entryPattern:/^\[地图\]\s*神州/,shouldEnable:e=>'神州'===e.currentRegion,priority:10},{entryPattern:/^\[地图\]\s*魔域/,shouldEnable:e=>'魔域'===e.currentRegion,priority:10},{entryPattern:/^\[地图\]\s*东海/,shouldEnable:e=>'东海'===e.currentRegion,priority:10},{entryPattern:/^\[角色\]\s*掌门/,shouldEnable:e=>'万法宗'===e.mvuData?.本尊?.行踪?.当前区域&&e.recentMessages.some(e=>e.includes('掌门')),priority:5},{entryPattern:/^\[角色\]\s*孟十七/,shouldEnable:e=>void 0!==e.mvuData?.红颜?.['孟十七']||e.recentMessages.some(e=>e.includes('孟十七')),priority:8},{entryPattern:/^\[境界\]\s*练气/,shouldEnable:e=>{const t=e.mvuData?.本尊?.等级??1;return t>=1&&t<=4},priority:7},{entryPattern:/^\[境界\]\s*筑基/,shouldEnable:e=>{const t=e.mvuData?.本尊?.等级??1;return t>=5&&t<=8},priority:7},{entryPattern:/^\[境界\]\s*金丹/,shouldEnable:e=>{const t=e.mvuData?.本尊?.等级??1;return t>=9&&t<=12},priority:7},{entryPattern:/^\[事件\]/,shouldEnable:e=>e.recentMessages.join(' ').length>0,priority:3}];let y=!1;async function g(){if(!y){y=!0;try{const e=await async function(){await waitGlobalInitialized('Mvu');const e=getChatMessages(-p).map(e=>e.message||'');let t=null;try{const e=getVariables({type:'message',message_id:-1}),r=_.get(e,'stat_data',null);r&&(t=c.parse(r))}catch(e){u&&console.warn('[动态世界书] 无法获取 MVU 数据',e)}return{currentRegion:t?.本尊?.行踪?.当前区域??'未知',recentMessages:e,mvuData:t,chatId:SillyTavern.getCurrentChatId()}}();let t=l;if('current'===t){if(t=getCharWorldbookNames('current').primary||'',!t)return void(u&&console.warn('[动态世界书] 当前角色卡没有绑定主世界书'))}let r=0,n=0;const a=[...f].sort((e,t)=>(t.priority??0)-(e.priority??0));await updateWorldbookWith(t,t=>{for(const o of t){if(!o.enabled)continue;const t=o.name||'';let s=!1;for(const r of a){if('string'==typeof r.entryPattern?t.includes(r.entryPattern):r.entryPattern.test(t)){s=r.shouldEnable(e);break}}const i='constant'===o.strategy.type;s&&!i?(o.strategy.type='constant',r++,u&&console.log(`[动态世界书] ✅ 启用（蓝灯）: ${t}`)):!s&&i&&(o.strategy.type='selective',n++,u&&console.log(`[动态世界书] ❌ 改为绿灯: ${t}`))}return t}),u&&(r>0||n>0)&&console.info(`[动态世界书] 更新完成: 启用蓝灯 ${r} 个, 改为绿灯 ${n} 个`)}catch(e){console.error('[动态世界书] 更新失败',e)}finally{y=!1}}}$(()=>{errorCatched(async()=>{console.info('[动态世界书] 脚本已加载'),await waitGlobalInitialized('Mvu'),await g(),eventOn(tavern_events.MESSAGE_RECEIVED,async()=>{await g()}),eventOn(tavern_events.MESSAGE_SENT,async()=>{await g()}),eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,async()=>{await g()}),console.info('[动态世界书] 监听器已设置，将自动管理世界书条目')})()});
//# sourceMappingURL=index.js.map