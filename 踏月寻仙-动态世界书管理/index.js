const r=z,e=[100,100,100,100,200,200,200,200,400,400,400,400,800,800,800,800,1600,1600,1600,1600,3200,3200,3200,3200,6400,6400,6400,6400,12800,12800,12800,12800,25600,25600,25600,25600],t=[100,100,100,100,200,200,200,200,500,500,500,500,1e3,1e3,1e3,1e3,2e3,2e3,2e3,2e3,5e3,5e3,5e3,5e3,1e4,1e4,1e4,1e4,5e4,5e4,5e4,5e4,1e5,1e5,1e5,1e5],n=['练气','筑基','金丹','元婴','化神','炼虚','合体','大乘','渡劫'],s=['初期','中期','后期','大圆满'],a=r.z.object({名称:r.z.string(),描述:r.z.string(),品阶:r.z.string(),数量:r.z.coerce.number()}),o=r.z.object({所在地:r.z.string(),核心特点:r.z.string(),最高战力:r.z.string(),阵营:r.z.enum(['正道','魔道','中立']),规模:r.z.enum(['超大宗门','大宗门','小宗门','微型宗门','特殊势力']),备注:r.z.string().optional()}),i=r.z.object({品阶:r.z.enum(['凡阶','黄阶','玄阶','地阶','天阶','仙阶','圣阶']),属性:r.z.string().describe('如:金系、木系、火系等'),效果描述:r.z.string(),修炼要求:r.z.string().optional()}),c=r.z.object({品阶:r.z.enum(['凡器','法器','灵器','法宝','灵宝','仙器','圣器','道器']),类型:r.z.string().describe('如:剑、刀、枪、防御、飞行、储物等'),特性:r.z.string(),当前持有者:r.z.string().optional()}),u=r.z.object({所属区域:r.z.enum(['天层','神州','东苍','南炎','西庚','北冥','下层','四海']),类型:r.z.enum(['秘境','城镇','宗门','禁地','遗迹','自然地形']),危险度:r.z.coerce.number().transform(r=>_.clamp(r,0,100)),特点:r.z.string(),可获得资源:r.z.array(r.z.string()).prefault([])}),l=r.z.object({世界时钟:r.z.object({纪元:r.z.string().prefault('末法时代'),年份:r.z.coerce.number().prefault(1),月份:r.z.coerce.number().transform(r=>_.clamp(r,1,12)).prefault(1),日期:r.z.coerce.number().transform(r=>_.clamp(r,1,30)).prefault(1),时辰:r.z.string().prefault('子时')}),世界地图:r.z.record(r.z.string().describe('区域名'),r.z.object({layer:r.z.enum(['天层','地层','下层']).prefault('地层'),danger:r.z.coerce.number().transform(r=>_.clamp(r,0,100)),desc:r.z.string().prefault(''),connections:r.z.array(r.z.string()).prefault([])})).prefault({}),世界图志:r.z.record(r.z.string().describe('事件名'),r.z.object({状态:r.z.string().prefault(''),事件:r.z.string().prefault('')})).prefault({}),宗门势力库:r.z.record(r.z.string().describe('宗门名'),o).prefault({剑阁:{所在地:'神州·剑门关',核心特点:'剑修圣地，天下剑道源头',最高战力:'剑仙·南宫秋水（渡劫后期）',阵营:'正道',规模:'超大宗门',备注:'宗门悬空于万仞天堑之上，非剑心通明者不可登门，与魔道抗衡千年'},万法宗:{所在地:'神州·问道峰',核心特点:'包容并蓄，研究万法本源',最高战力:'道主·尘微散人（渡劫初期）',阵营:'正道',规模:'超大宗门',备注:'坐拥天下第一藏经阁，不论出身皆可入内求法，号称万流归宗，是修仙界理论与知识的最高殿堂，与剑宗交好'},金刚寺:{所在地:'神州·西天佛山',核心特点:'佛修圣地，炼体神通',最高战力:'方丈·玄悲（大乘中期）',阵营:'正道',规模:'大宗门',备注:'佛门魁首，镇压魔道'},药王谷:{所在地:'神农架',核心特点:'医修圣地，炼丹术独步天下',最高战力:'药王·孙思邈（大乘初期）',阵营:'正道',规模:'大宗门',备注:'人脉极广，正魔皆求其丹药'},儒门:{所在地:'神州·文圣山',核心特点:'修浩然正气，以文入道',最高战力:'文圣·孔夫子（大乘中期）',阵营:'正道',规模:'大宗门',备注:'影响力巨大，掌控世俗文脉'},青龙殿:{所在地:'东苍·青龙山脉',核心特点:'守护青龙遗脉，镇守青帝陵',最高战力:'青龙使·敖广（大乘初期）',阵营:'正道',规模:'大宗门',备注:'半人半妖，与妖族关系微妙'},玄武宗:{所在地:'北冥·玄冰山',核心特点:'镇守北冥，守护玄武圣兽',最高战力:'宗主·玄冥子（大乘后期）',阵营:'正道',规模:'大宗门',备注:'常年镇守归墟，极少外出'},建木宗:{所在地:'东苍·建木神树',核心特点:'崇拜建木，擅木系道法',最高战力:'木长老（合体中期）',阵营:'正道',规模:'小宗门',备注:'东苍实际管理者之一'},百花谷:{所在地:'百花秘境',核心特点:'全为女修，以花入道',最高战力:'花主·牡丹（合体后期）',阵营:'正道',规模:'小宗门',备注:'与各大宗门联姻众多'},血神教:{所在地:'血魔渊',核心特点:'修炼血道，以血炼法',最高战力:'血神老祖（渡劫中期）',阵营:'魔道',规模:'超大宗门',备注:'与剑阁对峙千年，死敌'},天魔宗:{所在地:'天魔山',核心特点:'正统魔修，修炼天魔大道',最高战力:'天魔宗主（大乘中期）',阵营:'魔道',规模:'大宗门',备注:'魔道中相对守规矩的一派'},妖盟:{所在地:'万妖森林',核心特点:'妖族联盟，与人类和平共处',最高战力:'妖王·白泽（渡劫中期）',阵营:'中立',规模:'超大宗门',备注:'维护妖族利益，不参与人族内斗'},大夏王朝:{所在地:'神州·中州皇城',核心特点:'世俗统治，皇室修仙',最高战力:'夏皇（大乘初期）',阵营:'中立',规模:'大宗门',备注:'名义上统御神州，实际受宗门制约'},九州商会:{所在地:'神州九大主城',核心特点:'商业联盟，掌控经济命脉',最高战力:'财神爷（大乘初期）',阵营:'中立',规模:'大宗门',备注:'只做生意，不问正魔'},离火宫:{所在地:'南炎·不灭火山',核心特点:'供奉朱雀圣兽，亦正亦邪',最高战力:'宫主·离天火（合体大圆满）',阵营:'中立',规模:'小宗门',备注:'态度摇摆，谁给好处帮谁'},铸剑山庄:{所在地:'南炎·地火熔炉',核心特点:'天下第一炼器宗门',最高战力:'庄主·欧冶子（合体后期）',阵营:'中立',规模:'小宗门',备注:'只认材料不认人，正魔客户都接'}}),功法库:r.z.record(r.z.string().describe('功法名'),i).prefault({引气诀:{品阶:'凡阶',属性:'通用',效果描述:'基础引气，各宗门入门功法'},五行诀:{品阶:'黄阶',属性:'五行',效果描述:'平衡五行，稳扎稳打'},筑基真解:{品阶:'玄阶',属性:'通用',效果描述:'完美筑基之法'},金丹大道:{品阶:'地阶',属性:'通用',效果描述:'凝结金丹的秘法'},万剑归宗诀:{品阶:'天阶',属性:'金系·剑道',效果描述:'剑阁镇宗功法，御万剑',修炼要求:'剑心通明'},庚金神雷:{品阶:'天阶',属性:'金系·雷系',效果描述:'金雷双修，威力巨大'},百花真经:{品阶:'地阶',属性:'木系',效果描述:'百花谷核心，以花入道'},建木通天诀:{品阶:'天阶',属性:'木系',效果描述:'建木宗镇宗，直达天听'},万木朝宗:{品阶:'仙阶',属性:'木系',效果描述:'青帝遗留，掌控万木',修炼要求:'残卷，需特殊传承'},玄冰诀:{品阶:'地阶',属性:'水系·冰系',效果描述:'万法宗冰系基础功法，心如冰清'},北冥真经:{品阶:'天阶',属性:'水系',效果描述:'玄武宗镇宗，吞噬转化'},海纳百川:{品阶:'仙阶',属性:'水系',效果描述:'归墟感悟，容纳万物',修炼要求:'残卷'},朱雀涅槃经:{品阶:'天阶',属性:'火系',效果描述:'离火宫镇宫，涅槃重生'},太阳真火:{品阶:'天阶',属性:'火系',效果描述:'极致阳火，焚尽万物'},祝融神火:{品阶:'仙阶',属性:'火系',效果描述:'火神遗留，威力无穷',修炼要求:'残卷'},不动明王身:{品阶:'天阶',属性:'土系·佛门',效果描述:'金刚寺镇寺，防御无敌'},九天雷神诀:{品阶:'天阶',属性:'雷系',效果描述:'雷系顶级，代天行罚'},虚空经:{品阶:'天阶',属性:'空间',效果描述:'空间属性，罕见难修'},轮回经:{品阶:'仙阶',属性:'轮回',效果描述:'涉及轮回，因果重大',修炼要求:'残卷，{{user}}专属'},万法归宗:{品阶:'天阶',属性:'通用',效果描述:'万法宗镇宗，模拟万法'},医仙宝典:{品阶:'天阶',属性:'医道',效果描述:'药王谷镇谷，活死人肉白骨'},天魔策:{品阶:'天阶',属性:'魔道',效果描述:'魔道至高，速成但隐患大'},斩轮回剑典:{品阶:'仙阶',属性:'剑道·轮回',效果描述:'{{user}}前世所创，斩断因果',修炼要求:'残卷，{{user}}专属'},剑意通神:{品阶:'仙阶',属性:'剑道',效果描述:'剑道至高，意即为剑',修炼要求:'剑道顿悟'}}),法宝库:r.z.record(r.z.string().describe('法宝名'),c).prefault({青锋剑:{品阶:'法器',类型:'剑',特性:'制式长剑，锋利耐用',当前持有者:'各宗门弟子标配'},秋水剑:{品阶:'灵器',类型:'剑',特性:'剑身如水，适合水系剑修',当前持有者:'玄武宗内门弟子'},离火剑:{品阶:'法宝',类型:'剑',特性:'蕴含离火，挥出火焰剑气',当前持有者:'离火宫真传弟子'},寒镜剑:{品阶:'法宝',类型:'剑',特性:'心镜能力，可映照人心',当前持有者:'凌寒镜'},红绡枪:{品阶:'法宝',类型:'枪',特性:'红绡舞天，破军杀阵',当前持有者:'战红绡'},青龙剑:{品阶:'灵宝',类型:'剑',特性:'蕴含青龙之魂，木属性',当前持有者:'青龙殿镇殿之宝'},白虎剑:{品阶:'灵宝',类型:'剑',特性:'杀伐之气冲天，金属性',当前持有者:'白虎圣殿镇殿'},朱雀剑:{品阶:'灵宝',类型:'剑',特性:'火焰化形，火属性',当前持有者:'离火宫镇宫之宝'},玄武剑:{品阶:'灵宝',类型:'剑',特性:'厚重防御，水属性',当前持有者:'玄武宗镇宗之宝'},斩轮回:{品阶:'仙器',类型:'剑',特性:'可斩因果（残破）',当前持有者:'{{user}}（需重铸）'},镇渊剑:{品阶:'仙器',类型:'剑',特性:'{{user}}本命剑，可随修为成长（未完成）',当前持有者:'{{user}}需自行炼制'},绯月神弓:{品阶:'法宝',类型:'弓',特性:'朱雀之力，远程攻击极强',当前持有者:'焰绯月'},碧玉瑶琴:{品阶:'法宝',类型:'琴',特性:'天籁之音，可治愈心魔',当前持有者:'叶挽歌'},千丝罗网:{品阶:'灵宝',类型:'法器',特性:'织梦控心，幻术神器',当前持有者:'幻千丝'},雪魄琉璃炉:{品阶:'灵宝',类型:'丹炉',特性:'冰雪之力加持，炼丹神器',当前持有者:'苏雪魄'},龙鳞护甲:{品阶:'灵宝',类型:'防御',特性:'真龙鳞片，防御极强',当前持有者:'敖清霜'},储物袋:{品阶:'法器',类型:'储物',特性:'基础储物，空间较小'},储物戒指:{品阶:'灵器',类型:'储物',特性:'空间较大，便于携带'},乾坤袋:{品阶:'法宝',类型:'储物',特性:'空间巨大，可装活物'},洞天法宝:{品阶:'灵宝',类型:'储物',特性:'内含小世界，可居住修炼'}}),地点库:r.z.record(r.z.string().describe('地点名'),u).prefault({天渊:{所属区域:'天层',类型:'禁地',危险度:95,特点:'悬浮裂隙，星辰坠落，连接域外',可获得资源:['星辰碎片','域外陨铁']},九天罡风带:{所属区域:'天层',类型:'禁地',危险度:90,特点:'狂暴罡风，元婴以下无法穿越',可获得资源:['罡风精华']},问道峰:{所属区域:'神州',类型:'宗门',危险度:10,特点:'万法宗所在，天下问道大会举办地，高九千丈',可获得资源:['功法典籍','灵药']},剑门关:{所属区域:'神州',类型:'宗门',危险度:15,特点:'剑阁山门，悬空于万仞天堑之上',可获得资源:['剑意感悟','飞剑']},藏书阁:{所属区域:'神州',类型:'宗门',危险度:5,特点:'万法宗九层古籍收藏，每层有守护灵',可获得资源:['功法','典籍','秘术']},酆都城:{所属区域:'神州',类型:'城镇',危险度:30,特点:'引魂司总部，阴阳交汇，白日人市夜晚鬼市',可获得资源:['幽冥材料','鬼修功法']},龙门瀑布:{所属区域:'神州',类型:'秘境',危险度:40,特点:'鲤鱼跃龙门之地，蕴含造化',可获得资源:['龙气','化龙机缘']},建木森林:{所属区域:'东苍',类型:'自然地形',危险度:50,特点:'无边原始森林，古树成精',可获得资源:['灵木','木系材料','妖兽内丹']},青帝陵:{所属区域:'东苍',类型:'遗迹',危险度:85,特点:'青帝遗迹，内有传承考验',可获得资源:['青帝传承','木系至宝']},百花秘境:{所属区域:'东苍',类型:'秘境',危险度:20,特点:'百花谷所在，四季花开',可获得资源:['灵花','花粉','花系功法']},不灭火山:{所属区域:'南炎',类型:'自然地形',危险度:80,特点:'中央火山，朱雀涅槃处',可获得资源:['朱雀真火','火系至宝']},地火窟:{所属区域:'南炎',类型:'自然地形',危险度:60,特点:'地火喷涌，适合炼器',可获得资源:['地心火','炼器材料']},涅槃台:{所属区域:'南炎',类型:'遗迹',危险度:70,特点:'朱雀涅槃留下的石台，蕴含涅槃真意',可获得资源:['涅槃感悟','不死鸟羽毛']},万剑冢:{所属区域:'西庚',类型:'禁地',危险度:85,特点:'上古战场遗址，剑意千年不散',可获得资源:['剑意感悟','古剑','剑修传承']},庚金矿脉:{所属区域:'西庚',类型:'自然地形',危险度:40,特点:'盛产庚金之精，炼制飞剑最佳',可获得资源:['庚金','金属矿石']},玄冰山:{所属区域:'北冥',类型:'宗门',危险度:50,特点:'玄武宗所在，黑色冰山永不融化',可获得资源:['玄冰','寒冰材料']},归墟海眼:{所属区域:'北冥',类型:'禁地',危险度:99,特点:'吞噬一切的漩涡，万物终结',可获得资源:['归墟感悟','混沌之力']},黄泉古迹:{所属区域:'下层',类型:'遗迹',危险度:90,特点:'九曲天河源头，通往幽冥',可获得资源:['黄泉水','幽冥宝物']},无尽炎渊:{所属区域:'下层',类型:'禁地',危险度:95,特点:'南炎地心火狱，火焰分层',可获得资源:['地心火','炎魔材料']}}),本尊:r.z.object({等级:r.z.coerce.number().transform(r=>_.clamp(r,1,36)),修为:r.z.coerce.number().transform(r=>Math.max(0,r)),灵根:r.z.string().prefault('五行杂灵根'),体质:r.z.string().prefault('凡体'),功法:r.z.string().prefault('无'),本命兵器:r.z.string().prefault('无'),神通列表:r.z.record(r.z.string().describe('神通名'),r.z.string().describe('神通描述')).prefault({}),灵石:r.z.coerce.number().transform(r=>Math.max(0,r)),已活岁月:r.z.coerce.number().transform(r=>Math.max(0,r)),尝试突破:r.z.boolean().prefault(!1),行踪:r.z.object({当前区域:r.z.string().prefault('未知之地'),所属层级:r.z.string().optional(),环境描述:r.z.string().optional(),危险度:r.z.coerce.number().optional(),可用通道:r.z.array(r.z.string()).optional(),导航信息:r.z.string().optional()}),身份:r.z.object({姓名:r.z.string().prefault('无名氏'),宗门:r.z.string().prefault('散修'),出身:r.z.string().prefault('凡人')}),背包:r.z.record(r.z.string().describe('物品名'),a).prefault({}).transform(r=>_.pickBy(r,({数量:r})=>r>0)),法宝:r.z.record(r.z.string().describe('法宝名'),a).prefault({}).transform(r=>_.pickBy(r,({数量:r})=>r>0)),杂物袋:r.z.record(r.z.string().describe('杂物名'),a).prefault({}).transform(r=>_.pickBy(r,({数量:r})=>r>0))}).transform(r=>{const a=r.等级,o=e[a-1]||100,i=t[a-1]||100,c=Math.floor((a-1)/4),u=`${n[c]||'练气'}${s[(a-1)%4]}`,l=`${r.已活岁月}/${i}`,g=r.尝试突破?'突破中':r.修为>=o?'瓶颈期':'修炼中',p=`${(r.修为/o*100).toFixed(1)}%`;return{...r,突破阈值:o,寿元上限:i,境界描述:u,寿元状态:l,状态:g,进度:p}}),红颜角色库:r.z.record(r.z.string().describe('角色名'),r.z.object({等级:r.z.coerce.number().transform(r=>_.clamp(r,1,36)),灵根:r.z.string(),体质:r.z.string(),年龄:r.z.string().describe('如: 24岁 或 外表26岁,实际218岁'),所属:r.z.string(),功法:r.z.string(),本命兵器:r.z.string(),神通:r.z.array(r.z.string()).prefault([]),性格:r.z.string(),背景:r.z.string(),特殊设定:r.z.string().optional(),关系定位:r.z.string().describe('如: 同门师姐、忘年交、剑道知己等'),角色类型:r.z.enum(['核心红颜','重要红颜','次要红颜'])})).prefault({凌寒镜:{等级:11,灵根:'变异冰灵根(极品)',体质:'玄冰灵体',年龄:'24岁',所属:'万法宗·问道峰真传弟子',功法:'《玄冰诀》(地阶上品)、《心镜明悟诀》(天阶下品)',本命兵器:'寒镜剑(法宝中品)',神通:['冰镜映心','千里冰封','心如明镜'],性格:'清冷孤绝 | 心如明镜 | 不染尘埃 | 内心细腻 | 重情重义',背景:'玄冰门世家覆灭后投奔万法宗,天生心镜能力可看穿人心虚伪,二十岁突破金丹成为问道峰百年来最年轻真传',特殊设定:'心镜能力让她看透太多人心险恶导致内心孤独,心镜若被情绪波动影响会失效',关系定位:'同门师姐',角色类型:'核心红颜'},苏雪魄:{等级:16,灵根:'变异冰丹双灵根(极品)',体质:'雪魂之体',年龄:'外表26岁,实际218岁',所属:'散修·药王谷客卿长老',功法:'《雪魄丹经》(天阶中品)、《冰魄神功》(天阶下品)',本命兵器:'雪魄琉璃炉(灵宝上品)',神通:['雪魄炼丹','魂归雪域','冰魄护体'],性格:'清冷孤绝 | 深藏不露 | 温柔内敛 | 看淡生死 | 珍惜缘分',背景:'上古雪域神兽转世,带有前世部分记忆,五十岁已是元婴但因前世道伤修为停滞,行走世间两百年寻找前世因果',特殊设定:'雪域守护兽转世,前世记忆逐渐觉醒,前世道伤未愈无法突破化神且寿元将尽',关系定位:'忘年交·神秘导师',角色类型:'核心红颜'},叶挽歌:{等级:9,灵根:'木灵根(上品)',体质:'天籁之体',年龄:'22岁',所属:'药王谷·真传弟子',功法:'《百草医经》(地阶上品)、《天籁心音》(地阶中品)',本命兵器:'碧玉瑶琴(法宝下品)',神通:['歌声愈伤','草木皆医','生机涌动'],性格:'温柔治愈 | 善解人意 | 坚韧不拔 | 内心强大 | 重视承诺',背景:'药王谷真传弟子,天籁之体拥有者,十八岁时师父遭魔修暗算,{{user}}在她最绝望时相救并帮她报仇,从此视{{user}}为最重要的人',特殊设定:'天籁之体可治愈心魔但每次使用都会承受痛苦,战斗力较弱但医术精湛',关系定位:'知己·依赖',角色类型:'核心红颜'},焰绯月:{等级:12,灵根:'变异离火灵根(极品)',体质:'朱雀血脉',年龄:'25岁',所属:'南炎离火宫·圣女',功法:'《朱雀涅槃经》(天阶上品)',本命兵器:'绯月神弓(法宝上品)',神通:['离火焚天','朱雀真身','凤凰涅槃'],性格:'骄傲自信 | 热情如火 | 直来直去 | 好胜心强 | 重视荣誉',背景:'南炎离火宫圣女,朱雀血脉觉醒者,天生骄傲自视甚高,初遇{{user}}时看不起他但在比试中被击败,从此视为最大对手',特殊设定:'火系法术威力极强远程攻击冠绝同辈,但过于骄傲容易轻敌且防御相对较弱',关系定位:'竞争对手→欣赏',角色类型:'重要红颜'},战红绡:{等级:10,灵根:'金灵根(极品)',体质:'先天战体',年龄:'23岁',所属:'剑阁·真传弟子',功法:'《破军战诀》(天阶下品)',本命兵器:'红绡枪(法宝中品)',神通:['破军杀阵','银枪如龙','红绡舞天'],性格:'飒爽英气 | 锐不可当 | 正直坦荡 | 重情重义 | 战痴',背景:'剑阁真传弟子,先天战体枪道天才,性格如枪直来直去,与{{user}}在战斗中惺惺相惜互相切磋共同进步',特殊设定:'枪法天赋极高枪意凌厉攻击力强擅长冲锋陷阵,但性格直率不会转弯容易被感情影响战心',关系定位:'战场知己→暗生情愫',角色类型:'重要红颜'},幻千丝:{等级:13,灵根:'暗幻双灵根',体质:'梦魇之体',年龄:'外表20岁,实际未知',所属:'散修·幽冥修士',功法:'《织梦天罗》(天阶中品)',本命兵器:'千丝罗网(灵宝下品)',神通:['织梦为笼','心魔幻境','千丝束缚'],性格:'神秘莫测 | 亦正亦邪 | 难以捉摸 | 玩世不恭 | 好奇心强',背景:'身份神秘的幽冥修士,擅长幻术和梦境操控,初遇{{user}}是为试探发现{{user}}心神坚定幻术难以影响而产生兴趣',特殊设定:'擅长幻术心理战情报收集暗杀和潜入,但正面战斗力一般且怕光明属性克制',关系定位:'神秘接触→产生兴趣',角色类型:'重要红颜'},花想容:{等级:8,灵根:'木灵根',体质:'花妖之体',年龄:'外表18岁',所属:'建木宗·弟子',功法:'《百花真经》(地阶下品)',本命兵器:'牡丹花瓣(法器)',神通:['花海领域','治愈花粉','魅惑之香'],性格:'天真烂漫 | 容色倾城 | 单纯可爱 | 好奇心强 | 依赖性强',背景:'千年牡丹花妖化形因缘际会拜入建木宗,天性单纯不知人心险恶,一次外出历练被邪修抓住{{user}}相救从此死心塌地跟随',特殊设定:'控制花草治愈能力容貌倾城天生魅惑,但战斗经验不足过于单纯容易被骗离开灵气充沛之地会虚弱',关系定位:'被救者·跟随',角色类型:'次要红颜'},敖清霜:{等级:14,灵根:'水龙双灵根',体质:'真龙血脉',年龄:'150岁(外表20岁)',所属:'北冥龙宫·三公主',功法:'《沧海龙吟》(天阶上品)',本命兵器:'龙鳞护甲(灵宝中品)',神通:['龙族变化','呼风唤雨','龙威震慑'],性格:'高贵优雅 | 腹黑狡黠 | 好奇心强 | 向往自由 | 喜欢冒险',背景:'北冥龙宫三公主真龙血脉,厌倦宫廷生活化名敖灵儿混入人间历练,偶然遇到{{user}}被其特殊气息吸引化身普通修士跟随观察',特殊设定:'龙族神通水系法术身体素质远超人类寿元极长,但害怕身份暴露且不擅长隐藏情绪容易露馅',关系定位:'隐藏身份·偷偷观察',角色类型:'次要红颜'}}),红颜:r.z.record(r.z.string().describe('红颜名'),r.z.object({等级:r.z.coerce.number().transform(r=>_.clamp(r,1,36)),修为:r.z.coerce.number().transform(r=>Math.max(0,r)),灵根:r.z.string().prefault('五行杂灵根'),体质:r.z.string().prefault('凡体'),功法:r.z.string().prefault('无'),本命兵器:r.z.string().prefault('无'),神通列表:r.z.record(r.z.string().describe('神通名'),r.z.string().describe('神通描述')).prefault({}),灵石:r.z.coerce.number().transform(r=>Math.max(0,r)),已活岁月:r.z.coerce.number().transform(r=>Math.max(0,r)),尝试突破:r.z.boolean().prefault(!1),好感度:r.z.coerce.number().transform(r=>_.clamp(r,-100,100)),关系:r.z.string().prefault('陌生人'),重要性:r.z.string().prefault('路人')}).transform(r=>{const a=r.等级,o=e[a-1]||100,i=t[a-1]||100,c=Math.floor((a-1)/4),u=`${n[c]||'练气'}${s[(a-1)%4]}`,l=`${r.已活岁月}/${i}`,g=r.尝试突破?'突破中':r.修为>=o?'瓶颈期':'修炼中',p=`${(r.修为/o*100).toFixed(1)}%`;return{...r,突破阈值:o,寿元上限:i,境界描述:u,寿元状态:l,状态:g,进度:p}})).prefault({}),NPC图鉴:r.z.record(r.z.string().describe('NPC名'),r.z.object({等级:r.z.coerce.number().transform(r=>_.clamp(r,1,36)),修为:r.z.coerce.number().transform(r=>Math.max(0,r)),灵根:r.z.string().prefault('五行杂灵根'),体质:r.z.string().prefault('凡体'),功法:r.z.string().prefault('无'),本命兵器:r.z.string().prefault('无'),神通列表:r.z.record(r.z.string().describe('神通名'),r.z.string().describe('神通描述')).prefault({}),灵石:r.z.coerce.number().transform(r=>Math.max(0,r)),已活岁月:r.z.coerce.number().transform(r=>Math.max(0,r)),尝试突破:r.z.boolean().prefault(!1),所在宗门:r.z.string().prefault('散修')})).prefault({}),任务列表:r.z.record(r.z.string().describe('任务名'),r.z.object({类型:r.z.enum(['主线','支线','每日','临危受命']),说明:r.z.string().describe('面向{{user}}的任务背景或细则'),目标:r.z.string().describe('明确可执行的目标描述'),奖励:r.z.string(),惩罚:r.z.string().describe('失败后触发的负面效果'),状态:r.z.enum(['进行中','已完成','已失败']).prefault('进行中')})).prefault({}),声望系统:r.z.record(r.z.string().describe('势力名'),r.z.object({声望值:r.z.coerce.number().transform(r=>_.clamp(r,-100,100)),称号:r.z.string().optional(),关系描述:r.z.string()})).prefault({})});const g='current',p=!0,f=5,b=[{entryPattern:/^\[系统\]/,shouldEnable:()=>!0,priority:100},{entryPattern:/^\[mvu_update\]/,shouldEnable:()=>!0,priority:100},{entryPattern:/^变量列表$/,shouldEnable:()=>!0,priority:100},{entryPattern:/^变量更新规则$/,shouldEnable:()=>!0,priority:100},{entryPattern:/^变量输出格式$/,shouldEnable:()=>!0,priority:100},{entryPattern:/^\[地图\]\s*神州/,shouldEnable:r=>'神州'===r.currentRegion,priority:10},{entryPattern:/^\[地图\]\s*魔域/,shouldEnable:r=>'魔域'===r.currentRegion,priority:10},{entryPattern:/^\[地图\]\s*东海/,shouldEnable:r=>'东海'===r.currentRegion,priority:10},{entryPattern:/^\[角色\]\s*掌门/,shouldEnable:r=>'万法宗'===r.mvuData?.本尊?.行踪?.当前区域&&r.recentMessages.some(r=>r.includes('掌门')),priority:5},{entryPattern:/^\[角色\]\s*孟十七/,shouldEnable:r=>void 0!==r.mvuData?.红颜?.['孟十七']||r.recentMessages.some(r=>r.includes('孟十七')),priority:8},{entryPattern:/^\[境界\]\s*练气/,shouldEnable:r=>{const e=r.mvuData?.本尊?.等级??1;return e>=1&&e<=4},priority:7},{entryPattern:/^\[境界\]\s*筑基/,shouldEnable:r=>{const e=r.mvuData?.本尊?.等级??1;return e>=5&&e<=8},priority:7},{entryPattern:/^\[境界\]\s*金丹/,shouldEnable:r=>{const e=r.mvuData?.本尊?.等级??1;return e>=9&&e<=12},priority:7},{entryPattern:/^\[事件\]/,shouldEnable:r=>r.recentMessages.join(' ').length>0,priority:3}];let m=!1;async function d(){if(!m){m=!0;try{const r=await async function(){await waitGlobalInitialized('Mvu');const r=getChatMessages(-f).map(r=>r.message||'');let e=null;try{const r=getVariables({type:'message',message_id:-1}),t=_.get(r,'stat_data',null);t&&(e=l.parse(t))}catch(r){p&&console.warn('[动态世界书] 无法获取 MVU 数据',r)}return{currentRegion:e?.本尊?.行踪?.当前区域??'未知',recentMessages:r,mvuData:e,chatId:SillyTavern.getCurrentChatId()}}();let e=g;if('current'===e){if(e=getCharWorldbookNames('current').primary||'',!e)return void(p&&console.warn('[动态世界书] 当前角色卡没有绑定主世界书'))}let t=0,n=0;const s=[...b].sort((r,e)=>(e.priority??0)-(r.priority??0));await updateWorldbookWith(e,e=>{for(const a of e){if(!a.enabled)continue;const e=a.name||'';let o=!1;for(const t of s){if('string'==typeof t.entryPattern?e.includes(t.entryPattern):t.entryPattern.test(e)){o=t.shouldEnable(r);break}}const i='constant'===a.strategy.type;o&&!i?(a.strategy.type='constant',t++,p&&console.log(`[动态世界书] ✅ 启用（蓝灯）: ${e}`)):!o&&i&&(a.strategy.type='selective',n++,p&&console.log(`[动态世界书] ❌ 改为绿灯: ${e}`))}return e}),p&&(t>0||n>0)&&console.info(`[动态世界书] 更新完成: 启用蓝灯 ${t} 个, 改为绿灯 ${n} 个`)}catch(r){console.error('[动态世界书] 更新失败',r)}finally{m=!1}}}$(()=>{errorCatched(async()=>{console.info('[动态世界书] 脚本已加载'),await waitGlobalInitialized('Mvu'),await d(),eventOn(tavern_events.MESSAGE_RECEIVED,async()=>{await d()}),eventOn(tavern_events.MESSAGE_SENT,async()=>{await d()}),eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,async()=>{await d()}),console.info('[动态世界书] 监听器已设置，将自动管理世界书条目'),toastr.success('动态世界书管理已启用，将自动优化 Token','踏月寻仙')})()});
//# sourceMappingURL=index.js.map