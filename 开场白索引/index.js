const t='开场白索引';function n(t){return t.replace(/\s+/g,' ').trim()}function e(){const t=getCharData('current');if(!t)return[];const e=t.data,r=e?.alternate_greetings;return(Array.isArray(r)?r.map(t=>String(t??'')):[]).map((t,e)=>{const r=t.split('\n').map(t=>t.trim()).filter(Boolean)[0]??'',i=r.match(/^\[(.+?)\]/)?.[1]?.trim(),s=n(r).slice(0,24);return{index:e+1,title:i||s||`开场白 #${e+1}`,content:t}})}function r(t){return n(t).replace(/[\u200B-\u200D\uFEFF]/g,'')}function i(t){const n=t.split('\n').map(t=>t.trim()).find(Boolean)??'';return n.match(/^\[(.+?)\]/)?.[1]?.trim()??''}async function s(t){const n=e();if(0===n.length)return void toastr.error('未读取到额外问候语数据。');if(t<1||t>n.length)return void toastr.error(`索引越界: ${t} (有效范围 1-${n.length})`);const s=function(){const t=getChatMessages('0-{{lastMessageId}}',{include_swipes:!0});return 0===t.length?null:t.find(t=>Array.isArray(t.swipes)&&t.swipes.length>1)??null}();if(!s)return void toastr.error('未找到可切换的开场白楼层（swipes）。请先进入角色聊天并确保开场白已生成。');const o=s.swipes.length;if(t>o)return void toastr.error(`当前聊天仅有 ${o} 条可切换开场白。`);const a=function(t,n,e){const s=r(t.content);let o=n.findIndex(t=>r(t)===s);if(o>=0)return o;const a=i(t.content);if(a&&(o=n.findIndex(t=>i(t)===a),o>=0))return o;const l=s.slice(0,120);return o=n.findIndex(t=>{const n=r(t);return n.includes(l)||l.includes(n.slice(0,120))}),o>=0?o:n.length===e+1?t.index:n.length===e?t.index-1:null}(n[t-1],s.swipes,n.length);null!==a?(await setChatMessages([{message_id:s.message_id,swipe_id:a}],{refresh:'all'}),toastr.success(`已切换到开场白 #${t}`)):toastr.error('未能定位对应开场白，建议先在“其他开场”里手动切一次后重试。')}async function o(){const t=e();if(0===t.length)return void toastr.error('当前角色没有可用开场白。');const r=function(t){const e=$('<div>').css({display:'grid',gap:'8px',maxHeight:'65vh',overflowY:'auto',paddingRight:'4px'});return t.forEach(t=>{const r=$('<button>').attr('type','button').addClass('menu_button').css({textAlign:'left',width:'100%'}).text(`#${t.index} ${t.title}`).on('click',()=>{errorCatched(async()=>{await s(t.index)})()}),i=n(t.content).slice(0,100),o=$('<div>').css({opacity:'0.75',fontSize:'12px',marginTop:'-4px'}).text(i),a=$('<div>').css({border:'1px solid var(--SmartThemeBorderColor)',borderRadius:'8px',padding:'8px'});a.append(r,o),e.append(a)}),e}(t);await SillyTavern.callGenericPopup(r,SillyTavern.POPUP_TYPE.DISPLAY,'',{okButton:'关闭',leftAlign:!0,wide:!0,allowHorizontalScrolling:!1,allowVerticalScrolling:!0})}$(()=>{replaceScriptButtons([{name:t,visible:!0}]),eventOn(getButtonEvent(t),()=>{errorCatched(o)()}),console.info('[开场白索引] 已加载，可在脚本按钮中点击“开场白索引”直接跳转。')});
//# sourceMappingURL=index.js.map