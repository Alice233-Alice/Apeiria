{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/开场白索引/index.ts"],"sourcesContent":["const SCRIPT_BUTTON_NAME = '开场白索引';\nconst STEP_DELAY_MS = 55;\n\ntype GreetingItem = {\n  index: number;\n  title: string;\n  content: string;\n};\n\nfunction normalizeSpace(text: string): string {\n  return text.replace(/\\s+/g, ' ').trim();\n}\n\nfunction getGreetingItems(): GreetingItem[] {\n  const data = getCharData('current');\n  if (!data) {\n    return [];\n  }\n\n  // 只读取“额外问候语”，不包含第一条消息 first_mes。\n  const v2 = data.data as Partial<SillyTavern.v2CharData> | undefined;\n  const alternateRaw = v2?.alternate_greetings;\n  const alternates = Array.isArray(alternateRaw) ? alternateRaw.map(item => String(item ?? '')) : [];\n  return alternates.map((content, idx) => {\n    const lines = content\n      .split('\\n')\n      .map(line => line.trim())\n      .filter(Boolean);\n\n    const firstLine = lines[0] ?? '';\n    const bracketTitle = firstLine.match(/^\\[(.+?)\\]/)?.[1]?.trim();\n    const plainTitle = normalizeSpace(firstLine).slice(0, 24);\n\n    return {\n      index: idx + 1,\n      title: bracketTitle || plainTitle || `开场白 #${idx + 1}`,\n      content,\n    };\n  });\n}\n\nfunction findGreetingSwipeMessage(): ChatMessageSwiped | null {\n  const messages = getChatMessages('0-{{lastMessageId}}', { include_swipes: true });\n  if (messages.length === 0) {\n    return null;\n  }\n\n  const candidate = messages.find(message => Array.isArray(message.swipes) && message.swipes.length > 1);\n  return candidate ?? null;\n}\n\nfunction normalizeForMatch(text: string): string {\n  return normalizeSpace(text).replace(/[\\u200B-\\u200D\\uFEFF]/g, '');\n}\n\nfunction extractBracketTitle(text: string): string {\n  const firstLine = text.split('\\n').map(line => line.trim()).find(Boolean) ?? '';\n  return firstLine.match(/^\\[(.+?)\\]/)?.[1]?.trim() ?? '';\n}\n\nfunction resolveSwipeId(target: GreetingItem, swipes: string[], greetingCount: number): number | null {\n  const normalizedTarget = normalizeForMatch(target.content);\n\n  // 1) 优先全文归一化精确匹配\n  let idx = swipes.findIndex(swipe => normalizeForMatch(swipe) === normalizedTarget);\n  if (idx >= 0) {\n    return idx;\n  }\n\n  // 2) 再按 [标题] 匹配\n  const targetTitle = extractBracketTitle(target.content);\n  if (targetTitle) {\n    idx = swipes.findIndex(swipe => extractBracketTitle(swipe) === targetTitle);\n    if (idx >= 0) {\n      return idx;\n    }\n  }\n\n  // 3) 最后用前缀模糊匹配\n  const targetPrefix = normalizedTarget.slice(0, 120);\n  idx = swipes.findIndex(swipe => {\n    const normalizedSwipe = normalizeForMatch(swipe);\n    return normalizedSwipe.includes(targetPrefix) || targetPrefix.includes(normalizedSwipe.slice(0, 120));\n  });\n  if (idx >= 0) {\n    return idx;\n  }\n\n  // 4) 兜底：常见情况是 swipes 多了 first_mes 在第 0 位\n  if (swipes.length === greetingCount + 1) {\n    return target.index;\n  }\n  if (swipes.length === greetingCount) {\n    return target.index - 1;\n  }\n\n  return null;\n}\n\nasync function jumpToGreeting(targetIndex: number): Promise<void> {\n  const items = getGreetingItems();\n  if (items.length === 0) {\n    toastr.error('未读取到额外问候语数据。');\n    return;\n  }\n\n  if (targetIndex < 1 || targetIndex > items.length) {\n    toastr.error(`索引越界: ${targetIndex} (有效范围 1-${items.length})`);\n    return;\n  }\n\n  const greetingMessage = findGreetingSwipeMessage();\n  if (!greetingMessage) {\n    toastr.error('未找到可切换的开场白楼层（swipes）。请先进入角色聊天并确保开场白已生成。');\n    return;\n  }\n\n  const swipeCount = greetingMessage.swipes.length;\n  if (targetIndex > swipeCount) {\n    toastr.error(`当前聊天仅有 ${swipeCount} 条可切换开场白。`);\n    return;\n  }\n\n  const target = items[targetIndex - 1];\n  const swipeId = resolveSwipeId(target, greetingMessage.swipes, items.length);\n  if (swipeId === null) {\n    toastr.error('未能定位对应开场白，建议先在“其他开场”里手动切一次后重试。');\n    return;\n  }\n\n  await setChatMessages([{ message_id: greetingMessage.message_id, swipe_id: swipeId }], { refresh: 'all' });\n\n  toastr.success(`已切换到开场白 #${targetIndex}`);\n}\n\nfunction buildPopupContent(items: GreetingItem[]): JQuery<HTMLElement> {\n  const $root = $('<div>').css({\n    display: 'grid',\n    gap: '8px',\n    maxHeight: '65vh',\n    overflowY: 'auto',\n    paddingRight: '4px',\n  });\n\n  items.forEach(item => {\n    const $button = $('<button>')\n      .attr('type', 'button')\n      .addClass('menu_button')\n      .css({ textAlign: 'left', width: '100%' })\n      .text(`#${item.index} ${item.title}`)\n      .on('click', () => {\n        errorCatched(async () => {\n          await jumpToGreeting(item.index);\n        })();\n      });\n\n    const preview = normalizeSpace(item.content).slice(0, 100);\n    const $preview = $('<div>').css({ opacity: '0.75', fontSize: '12px', marginTop: '-4px' }).text(preview);\n\n    const $card = $('<div>').css({ border: '1px solid var(--SmartThemeBorderColor)', borderRadius: '8px', padding: '8px' });\n    $card.append($button, $preview);\n    $root.append($card);\n  });\n\n  return $root as JQuery<HTMLElement>;\n}\n\nasync function openGreetingIndexPopup(): Promise<void> {\n  const items = getGreetingItems();\n  if (items.length === 0) {\n    toastr.error('当前角色没有可用开场白。');\n    return;\n  }\n\n  const content = buildPopupContent(items);\n  await SillyTavern.callGenericPopup(content, SillyTavern.POPUP_TYPE.DISPLAY, '', {\n    okButton: '关闭',\n    leftAlign: true,\n    wide: true,\n    allowHorizontalScrolling: false,\n    allowVerticalScrolling: true,\n  });\n}\n\n$(() => {\n  replaceScriptButtons([{ name: SCRIPT_BUTTON_NAME, visible: true }]);\n\n  eventOn(getButtonEvent(SCRIPT_BUTTON_NAME), () => {\n    errorCatched(openGreetingIndexPopup)();\n  });\n\n  console.info('[开场白索引] 已加载，可在脚本按钮中点击“开场白索引”直接跳转。');\n});\r\n"],"names":["SCRIPT_BUTTON_NAME","normalizeSpace","text","replace","trim","getGreetingItems","data","getCharData","v2","alternateRaw","alternate_greetings","Array","isArray","map","item","String","content","idx","firstLine","split","line","filter","Boolean","bracketTitle","match","plainTitle","slice","index","title","normalizeForMatch","extractBracketTitle","find","async","jumpToGreeting","targetIndex","items","length","toastr","error","greetingMessage","messages","getChatMessages","include_swipes","message","swipes","findGreetingSwipeMessage","swipeCount","swipeId","target","greetingCount","normalizedTarget","findIndex","swipe","targetTitle","targetPrefix","normalizedSwipe","includes","resolveSwipeId","setChatMessages","message_id","swipe_id","refresh","success","openGreetingIndexPopup","$root","$","css","display","gap","maxHeight","overflowY","paddingRight","forEach","$button","attr","addClass","textAlign","width","on","errorCatched","preview","$preview","opacity","fontSize","marginTop","$card","border","borderRadius","padding","append","buildPopupContent","SillyTavern","callGenericPopup","POPUP_TYPE","DISPLAY","okButton","leftAlign","wide","allowHorizontalScrolling","allowVerticalScrolling","replaceScriptButtons","name","visible","eventOn","getButtonEvent","console","info"],"ignoreList":[],"sourceRoot":""}