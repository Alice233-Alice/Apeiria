function e(e){let t=0;t+=100*e.ç­‰çº§+e.ä¿®ä¸º,e.çµæ ¹&&(e.çµæ ¹.includes('å¤©æ ¹')||e.çµæ ¹.includes('å¼‚')?t*=1.5:e.çµæ ¹.includes('æ')?t*=1.3:e.çµæ ¹.includes('ä¸Š')?t*=1.2:e.çµæ ¹.includes('åŒæ ¹')&&(t*=1.15)),e.ä½“è´¨&&(e.ä½“è´¨.includes('ç¥')?t*=2:e.ä½“è´¨.includes('åœ£')?t*=1.8:e.ä½“è´¨.includes('é“')?t*=1.5:e.ä½“è´¨.includes('çµ')&&(t*=1.3)),e.åŠŸæ³•&&'æ— '!==e.åŠŸæ³•&&(e.åŠŸæ³•.includes('ä»™')?t*=1.6:e.åŠŸæ³•.includes('å¤©')?t*=1.4:e.åŠŸæ³•.includes('åœ°')?t*=1.2:e.åŠŸæ³•.includes('ç„')&&(t*=1.1)),e.æœ¬å‘½å…µå™¨&&'æ— '!==e.æœ¬å‘½å…µå™¨&&(t*=1.2);return t*=1+.1*Object.keys(e.ç¥é€šåˆ—è¡¨||{}).length,Math.floor(t)}async function t(t,s,n=!0){await waitGlobalInitialized('Mvu');const a=getCurrentMessageId(),r=Mvu.getMvuData({type:'message',message_id:a}),o=_.get(r,'stat_data',{});let c,i;if(n)c=_.get(o,'æœ¬å°Š');else if(_.get(o,`çº¢é¢œ.${t}`))c=_.get(o,`çº¢é¢œ.${t}`);else{if(!_.get(o,`NPCå›¾é‰´.${t}`))throw new Error(`æ‰¾ä¸åˆ°æ”»å‡»æ–¹: ${t}`);c=_.get(o,`NPCå›¾é‰´.${t}`)}if(_.get(o,`çº¢é¢œ.${s}`))i=_.get(o,`çº¢é¢œ.${s}`);else{if(!_.get(o,`NPCå›¾é‰´.${s}`))throw new Error(`æ‰¾ä¸åˆ°é˜²å¾¡æ–¹: ${s}`);i=_.get(o,`NPCå›¾é‰´.${s}`)}const l=e(c),u=e(i);console.info('[æˆ˜æ–—åˆ¤å®š]',{æ”»å‡»æ–¹:t,æ”»å‡»æ–¹æˆ˜åŠ›:l,é˜²å¾¡æ–¹:s,é˜²å¾¡æ–¹æˆ˜åŠ›:u});const h=l/(u||1)*(.8+.4*Math.random()),m=h>1,g=m?t:s,d=m?s:t,f=function(e,t){const s=[],n=e.power-t.power,a=e.level-t.level;s.push(`${e.name}ä¸${t.name}å¯¹å³™ï¼ŒçµåŠ›æ¿€è¡ï¼Œæˆ˜æ„å†²å¤©ï¼`),Math.abs(n)<1e3?s.push(`åŒæ–¹å®åŠ›ç›¸è¿‘ï¼Œ${e.name}ç‡å…ˆå‡ºæ‰‹è¯•æ¢ï¼Œ${t.name}æ²‰ç¨³åº”å¯¹ã€‚`):n>0?s.push(`${e.name}å®åŠ›æ˜æ˜¾å ä¼˜ï¼Œ${t.name}å…¨åŠ›é˜²å®ˆï¼Œå¯»æ‰¾ç ´ç»½ã€‚`):s.push(`${t.name}å®åŠ›æ›´èƒœä¸€ç­¹ï¼Œ${e.name}ä¸æ•¢å¤§æ„ï¼Œè°¨æ…è¿›æ”»ã€‚`),a>=4?s.push(`å¢ƒç•Œå‹åˆ¶æ˜¾ç°ï¼${e.name}å‡­å€Ÿå¢ƒç•Œä¼˜åŠ¿ï¼Œæ³•åˆ™ä¹‹åŠ›ç¢¾å‹è€Œä¸‹ï¼`):(e.çµæ ¹?.includes('å¼‚')||e.çµæ ¹?.includes('å¤©'))&&s.push(`${e.name}çš„ç‰¹æ®Šçµæ ¹å‘å¨ï¼Œå±æ€§å…‹åˆ¶è®©å¯¹æ‰‹éš¾ä»¥æ‹›æ¶ï¼`);const r=Math.random();return r<.3?s.push('æˆ˜æ–—è¿›å…¥ç™½çƒ­åŒ–ï¼ŒåŒæ–¹éƒ½æ–½å±•å‡ºäº†å‹ç®±åº•çš„ç¥é€šï¼'):r<.6?s.push('çµåŠ›ç¢°æ’ï¼Œæ–¹åœ†æ•°é‡Œçš„å¤©åœ°çµæ°”éƒ½è¢«å·å…¥æˆ˜åœºï¼'):s.push('æ³•å®å¯¹è½°ï¼Œç©ºé—´éœ‡è¡ï¼Œé™„è¿‘çš„ä¿®å£«çº·çº·é€€é¿ä¸‰èˆï¼'),s}({name:t,power:l,level:c.ç­‰çº§,çµæ ¹:c.çµæ ¹},{name:s,power:u,level:i.ç­‰çº§,çµæ ¹:i.çµæ ¹});Math.abs(h-1)<.1?f.push(`åŠ¿å‡åŠ›æ•Œçš„ä¸€æˆ˜ï¼æœ€ç»ˆ${g}é™©èƒœï¼Œ${d}è™½è´¥çŠ¹è£ï¼`):h>1.5||h<.67?f.push(`å®åŠ›å·®è·æ‚¬æ®Šï¼${g}ç¢¾å‹æ€§è·èƒœï¼Œ${d}æ¯«æ— è¿˜æ‰‹ä¹‹åŠ›ï¼`):f.push(`ç»è¿‡æ¿€çƒˆäº¤é”‹ï¼Œ${g}ç•¥èƒœä¸€ç­¹ï¼Œ${d}åŠ›ç«­è´¥åŒ—ï¼`);const p=Math.abs(1-h);let w,M;p<.1?(w='é‡ä¼¤',M='æ¿’æ­»'):p<.3?(w='ä¸­ä¼¤',M='é‡ä¼¤'):p<.5?(w='è½»ä¼¤',M='é‡ä¼¤'):(w='æ— ä¼¤',M='ä¸­ä¼¤');const v=[];if(m&&i.çµçŸ³>0){const e=Math.floor(i.çµçŸ³*(.3+.4*Math.random()));v.push(`çµçŸ³ x${e}`)}return i.æœ¬å‘½å…µå™¨&&'æ— '!==i.æœ¬å‘½å…µå™¨&&Math.random()<.3&&v.push(i.æœ¬å‘½å…µå™¨),{èƒœè€…:g,è´¥è€…:d,æˆ˜æ–—è¿‡ç¨‹:f,ä¼¤å®³æƒ…å†µ:{èƒœè€…å—ä¼¤:w,è´¥è€…å—ä¼¤:M},æˆ˜åˆ©å“:v}}function s(e){let t='## ğŸ—¡ï¸ æˆ˜æ–—åˆ¤å®šç»“æœ\n\n';return t+='### æˆ˜æ–—è¿‡ç¨‹\n',e.æˆ˜æ–—è¿‡ç¨‹.forEach((e,s)=>{t+=`${s+1}. ${e}\n`}),t+='\n### æˆ˜æ–—ç»“æœ\n',t+=`- **èƒœè€…**: ${e.èƒœè€…} (${e.ä¼¤å®³æƒ…å†µ.èƒœè€…å—ä¼¤})\n`,t+=`- **è´¥è€…**: ${e.è´¥è€…} (${e.ä¼¤å®³æƒ…å†µ.è´¥è€…å—ä¼¤})\n`,e.æˆ˜åˆ©å“.length>0&&(t+='\n### æˆ˜åˆ©å“\n',e.æˆ˜åˆ©å“.forEach(e=>{t+=`- ${e}\n`})),t}window.TavernBattle={judgeBattle:t,formatBattleResult:s,calculatePower:e};let n=!0;window.TavernBattle.setAutoDetect=e=>{n=e,console.info('[æˆ˜æ–—åˆ¤å®š] è‡ªåŠ¨æ£€æµ‹å·²',e?'å¯ç”¨':'ç¦ç”¨'),toastr.info('æˆ˜æ–—è‡ªåŠ¨æ£€æµ‹å·²'+(e?'å¯ç”¨':'ç¦ç”¨'),'æˆ˜æ–—ç³»ç»Ÿ')},$(()=>{console.info('[æˆ˜æ–—åˆ¤å®š] è„šæœ¬å·²åŠ è½½'),toastr.info('æˆ˜æ–—åˆ¤å®šç³»ç»Ÿå·²å°±ç»ª\nâ€¢ æ‰‹åŠ¨ï¼š/battle æ”»å‡»æ–¹|é˜²å¾¡æ–¹\nâ€¢ è‡ªåŠ¨ï¼šAI æåŠæˆ˜æ–—æ—¶è‡ªåŠ¨è§¦å‘','æˆ˜æ–—ç³»ç»Ÿ')}),eventOn(tavern_events.MESSAGE_SENT,async e=>{const n='string'==typeof e?parseInt(e):e,a=getChatMessages(n);if(0===a.length)return;const r=(a[0].message||'').match(/^\/battle\s+(.+?)\|(.+?)$/);if(!r)return;const o=r[1].trim(),c=r[2].trim();try{console.info('[æˆ˜æ–—åˆ¤å®š] æ£€æµ‹åˆ°æˆ˜æ–—å‘½ä»¤',{attackerName:o,defenderName:c});const e=s(await t(o,c,'{{user}}'===o||o.includes('user')||o.includes('ä¸»è§’')));await deleteChatMessages([n]),await createChatMessages([{name:'æˆ˜æ–—ç³»ç»Ÿ',role:'system',message:e}]),toastr.success('æˆ˜æ–—åˆ¤å®šå®Œæˆï¼','æˆ˜æ–—ç³»ç»Ÿ')}catch(e){console.error('[æˆ˜æ–—åˆ¤å®š] æ‰§è¡Œå¤±è´¥',e);const t=e instanceof Error?e.message:String(e);toastr.error(`æˆ˜æ–—åˆ¤å®šå¤±è´¥: ${t}`,'æˆ˜æ–—ç³»ç»Ÿ')}}),eventOn(tavern_events.MESSAGE_RECEIVED,async e=>{if(!n)return;const a='string'==typeof e?parseInt(e):e,r=getChatMessages(a);if(0===r.length)return;const o=(r[0].message||'').match(/ã€æˆ˜æ–—[ï¼š:]\s*(.+?)\s+vs\s+(.+?)ã€‘/);if(!o)return;const c=o[1].trim(),i=o[2].trim();try{console.info('[æˆ˜æ–—åˆ¤å®š] è‡ªåŠ¨æ£€æµ‹åˆ°æˆ˜æ–—',{attackerName:c,defenderName:i});const e=s(await t(c,i,'{{user}}'===c||c.includes('user')||c.includes('ä¸»è§’')));await createChatMessages([{name:'æˆ˜æ–—ç³»ç»Ÿ',role:'system',message:e}]),toastr.success('è‡ªåŠ¨æˆ˜æ–—åˆ¤å®šå®Œæˆï¼','æˆ˜æ–—ç³»ç»Ÿ')}catch(e){console.error('[æˆ˜æ–—åˆ¤å®š] è‡ªåŠ¨æ£€æµ‹æ‰§è¡Œå¤±è´¥',e);const t=e instanceof Error?e.message:String(e);console.warn(`[æˆ˜æ–—åˆ¤å®š] ${t}`)}});
//# sourceMappingURL=index.js.map