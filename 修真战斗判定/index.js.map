{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/ä¿®çœŸæˆ˜æ–—åˆ¤å®š/index.ts"],"sourcesContent":["// ============================================================================\r\n// æˆ˜æ–—åˆ¤å®šè„šæœ¬\r\n// åŠŸèƒ½: æä¾›ä¿®çœŸä¸–ç•Œçš„æˆ˜æ–—åˆ¤å®šç³»ç»Ÿï¼Œæ”¯æŒå¢ƒç•Œã€çµæ ¹ã€ä½“è´¨ã€åŠŸæ³•ç­‰å› ç´ ç»¼åˆè®¡ç®—\r\n// ============================================================================\r\n\r\n// æˆ˜æ–—ç»“æœç±»å‹\r\ninterface BattleResult {\r\n    èƒœè€…: string;\r\n    è´¥è€…: string;\r\n    æˆ˜æ–—è¿‡ç¨‹: string[];\r\n    ä¼¤å®³æƒ…å†µ: {\r\n        èƒœè€…å—ä¼¤: string;\r\n        è´¥è€…å—ä¼¤: string;\r\n    };\r\n    æˆ˜åˆ©å“: string[];\r\n}\r\n\r\n// æˆ˜æ–—åŠ›è®¡ç®—\r\nfunction calculatePower(data: {\r\n    ç­‰çº§: number;\r\n    ä¿®ä¸º: number;\r\n    çµæ ¹?: string;\r\n    ä½“è´¨?: string;\r\n    åŠŸæ³•?: string;\r\n    æœ¬å‘½å…µå™¨?: string;\r\n    ç¥é€šåˆ—è¡¨?: Record<string, string>;\r\n}): number {\r\n    let power = 0;\r\n\r\n    // åŸºç¡€æˆ˜åŠ› = ç­‰çº§ Ã— 100 + ä¿®ä¸º\r\n    power += data.ç­‰çº§ * 100 + data.ä¿®ä¸º;\r\n\r\n    // çµæ ¹åŠ æˆ\r\n    if (data.çµæ ¹) {\r\n        if (data.çµæ ¹.includes('å¤©æ ¹') || data.çµæ ¹.includes('å¼‚')) power *= 1.5;\r\n        else if (data.çµæ ¹.includes('æ')) power *= 1.3;\r\n        else if (data.çµæ ¹.includes('ä¸Š')) power *= 1.2;\r\n        else if (data.çµæ ¹.includes('åŒæ ¹')) power *= 1.15;\r\n    }\r\n\r\n    // ä½“è´¨åŠ æˆ\r\n    if (data.ä½“è´¨) {\r\n        if (data.ä½“è´¨.includes('ç¥')) power *= 2.0;\r\n        else if (data.ä½“è´¨.includes('åœ£')) power *= 1.8;\r\n        else if (data.ä½“è´¨.includes('é“')) power *= 1.5;\r\n        else if (data.ä½“è´¨.includes('çµ')) power *= 1.3;\r\n    }\r\n\r\n    // åŠŸæ³•åŠ æˆ\r\n    if (data.åŠŸæ³• && data.åŠŸæ³• !== 'æ— ') {\r\n        if (data.åŠŸæ³•.includes('ä»™')) power *= 1.6;\r\n        else if (data.åŠŸæ³•.includes('å¤©')) power *= 1.4;\r\n        else if (data.åŠŸæ³•.includes('åœ°')) power *= 1.2;\r\n        else if (data.åŠŸæ³•.includes('ç„')) power *= 1.1;\r\n    }\r\n\r\n    // æœ¬å‘½å…µå™¨åŠ æˆ\r\n    if (data.æœ¬å‘½å…µå™¨ && data.æœ¬å‘½å…µå™¨ !== 'æ— ') {\r\n        power *= 1.2;\r\n    }\r\n\r\n    // ç¥é€šåŠ æˆ\r\n    const ç¥é€šæ•°é‡ = Object.keys(data.ç¥é€šåˆ—è¡¨ || {}).length;\r\n    power *= 1 + ç¥é€šæ•°é‡ * 0.1;\r\n\r\n    return Math.floor(power);\r\n}\r\n\r\n// ç”Ÿæˆæˆ˜æ–—è¿‡ç¨‹æè¿°\r\nfunction generateBattleProcess(\r\n    attacker: { name: string; power: number; level: number; çµæ ¹?: string },\r\n    defender: { name: string; power: number; level: number; çµæ ¹?: string },\r\n): string[] {\r\n    const process: string[] = [];\r\n    const powerDiff = attacker.power - defender.power;\r\n    const levelDiff = attacker.level - defender.level;\r\n\r\n    // å¼€åœº\r\n    process.push(`${attacker.name}ä¸${defender.name}å¯¹å³™ï¼ŒçµåŠ›æ¿€è¡ï¼Œæˆ˜æ„å†²å¤©ï¼`);\r\n\r\n    // è¯•æ¢\r\n    if (Math.abs(powerDiff) < 1000) {\r\n        process.push(`åŒæ–¹å®åŠ›ç›¸è¿‘ï¼Œ${attacker.name}ç‡å…ˆå‡ºæ‰‹è¯•æ¢ï¼Œ${defender.name}æ²‰ç¨³åº”å¯¹ã€‚`);\r\n    } else if (powerDiff > 0) {\r\n        process.push(`${attacker.name}å®åŠ›æ˜æ˜¾å ä¼˜ï¼Œ${defender.name}å…¨åŠ›é˜²å®ˆï¼Œå¯»æ‰¾ç ´ç»½ã€‚`);\r\n    } else {\r\n        process.push(`${defender.name}å®åŠ›æ›´èƒœä¸€ç­¹ï¼Œ${attacker.name}ä¸æ•¢å¤§æ„ï¼Œè°¨æ…è¿›æ”»ã€‚`);\r\n    }\r\n\r\n    // ä¸­åœº\r\n    if (levelDiff >= 4) {\r\n        process.push(`å¢ƒç•Œå‹åˆ¶æ˜¾ç°ï¼${attacker.name}å‡­å€Ÿå¢ƒç•Œä¼˜åŠ¿ï¼Œæ³•åˆ™ä¹‹åŠ›ç¢¾å‹è€Œä¸‹ï¼`);\r\n    } else if (attacker.çµæ ¹?.includes('å¼‚') || attacker.çµæ ¹?.includes('å¤©')) {\r\n        process.push(`${attacker.name}çš„ç‰¹æ®Šçµæ ¹å‘å¨ï¼Œå±æ€§å…‹åˆ¶è®©å¯¹æ‰‹éš¾ä»¥æ‹›æ¶ï¼`);\r\n    }\r\n\r\n    const random = Math.random();\r\n    if (random < 0.3) {\r\n        process.push(`æˆ˜æ–—è¿›å…¥ç™½çƒ­åŒ–ï¼ŒåŒæ–¹éƒ½æ–½å±•å‡ºäº†å‹ç®±åº•çš„ç¥é€šï¼`);\r\n    } else if (random < 0.6) {\r\n        process.push(`çµåŠ›ç¢°æ’ï¼Œæ–¹åœ†æ•°é‡Œçš„å¤©åœ°çµæ°”éƒ½è¢«å·å…¥æˆ˜åœºï¼`);\r\n    } else {\r\n        process.push(`æ³•å®å¯¹è½°ï¼Œç©ºé—´éœ‡è¡ï¼Œé™„è¿‘çš„ä¿®å£«çº·çº·é€€é¿ä¸‰èˆï¼`);\r\n    }\r\n\r\n    return process;\r\n}\r\n\r\n// æˆ˜æ–—åˆ¤å®šæ ¸å¿ƒå‡½æ•°\r\nasync function judgeBattle(\r\n    attackerName: string,\r\n    defenderName: string,\r\n    attackerIsUser: boolean = true,\r\n): Promise<BattleResult> {\r\n    await waitGlobalInitialized('Mvu');\r\n\r\n    const message_id = getCurrentMessageId();\r\n    const variables = Mvu.getMvuData({ type: 'message', message_id });\r\n    const stat_data = _.get(variables, 'stat_data', {});\r\n\r\n    // è·å–æ”»å‡»æ–¹æ•°æ®\r\n    let attackerData;\r\n    if (attackerIsUser) {\r\n        attackerData = _.get(stat_data, 'æœ¬å°Š');\r\n    } else if (_.get(stat_data, `çº¢é¢œ.${attackerName}`)) {\r\n        attackerData = _.get(stat_data, `çº¢é¢œ.${attackerName}`);\r\n    } else if (_.get(stat_data, `NPCå›¾é‰´.${attackerName}`)) {\r\n        attackerData = _.get(stat_data, `NPCå›¾é‰´.${attackerName}`);\r\n    } else {\r\n        throw new Error(`æ‰¾ä¸åˆ°æ”»å‡»æ–¹: ${attackerName}`);\r\n    }\r\n\r\n    // è·å–é˜²å¾¡æ–¹æ•°æ®\r\n    let defenderData;\r\n    if (_.get(stat_data, `çº¢é¢œ.${defenderName}`)) {\r\n        defenderData = _.get(stat_data, `çº¢é¢œ.${defenderName}`);\r\n    } else if (_.get(stat_data, `NPCå›¾é‰´.${defenderName}`)) {\r\n        defenderData = _.get(stat_data, `NPCå›¾é‰´.${defenderName}`);\r\n    } else {\r\n        throw new Error(`æ‰¾ä¸åˆ°é˜²å¾¡æ–¹: ${defenderName}`);\r\n    }\r\n\r\n    // è®¡ç®—æˆ˜åŠ›\r\n    const attackerPower = calculatePower(attackerData);\r\n    const defenderPower = calculatePower(defenderData);\r\n\r\n    console.info('[æˆ˜æ–—åˆ¤å®š]', {\r\n        æ”»å‡»æ–¹: attackerName,\r\n        æ”»å‡»æ–¹æˆ˜åŠ›: attackerPower,\r\n        é˜²å¾¡æ–¹: defenderName,\r\n        é˜²å¾¡æ–¹æˆ˜åŠ›: defenderPower,\r\n    });\r\n\r\n    // åˆ¤å®šèƒœè´Ÿï¼ˆåŸºç¡€åˆ¤å®š + éšæœºå› ç´ ï¼‰\r\n    const powerRatio = attackerPower / (defenderPower || 1);\r\n    const randomFactor = 0.8 + Math.random() * 0.4; // 0.8-1.2 éšæœºç³»æ•°\r\n    const finalRatio = powerRatio * randomFactor;\r\n\r\n    const isAttackerWin = finalRatio > 1;\r\n    const èƒœè€… = isAttackerWin ? attackerName : defenderName;\r\n    const è´¥è€… = isAttackerWin ? defenderName : attackerName;\r\n\r\n    // ç”Ÿæˆæˆ˜æ–—è¿‡ç¨‹\r\n    const æˆ˜æ–—è¿‡ç¨‹ = generateBattleProcess(\r\n        { name: attackerName, power: attackerPower, level: attackerData.ç­‰çº§, çµæ ¹: attackerData.çµæ ¹ },\r\n        { name: defenderName, power: defenderPower, level: defenderData.ç­‰çº§, çµæ ¹: defenderData.çµæ ¹ },\r\n    );\r\n\r\n    // æ·»åŠ ç»“å±€æè¿°\r\n    if (Math.abs(finalRatio - 1) < 0.1) {\r\n        æˆ˜æ–—è¿‡ç¨‹.push(`åŠ¿å‡åŠ›æ•Œçš„ä¸€æˆ˜ï¼æœ€ç»ˆ${èƒœè€…}é™©èƒœï¼Œ${è´¥è€…}è™½è´¥çŠ¹è£ï¼`);\r\n    } else if (finalRatio > 1.5 || finalRatio < 0.67) {\r\n        æˆ˜æ–—è¿‡ç¨‹.push(`å®åŠ›å·®è·æ‚¬æ®Šï¼${èƒœè€…}ç¢¾å‹æ€§è·èƒœï¼Œ${è´¥è€…}æ¯«æ— è¿˜æ‰‹ä¹‹åŠ›ï¼`);\r\n    } else {\r\n        æˆ˜æ–—è¿‡ç¨‹.push(`ç»è¿‡æ¿€çƒˆäº¤é”‹ï¼Œ${èƒœè€…}ç•¥èƒœä¸€ç­¹ï¼Œ${è´¥è€…}åŠ›ç«­è´¥åŒ—ï¼`);\r\n    }\r\n\r\n    // è®¡ç®—ä¼¤å®³ç¨‹åº¦\r\n    const damageLevel = Math.abs(1 - finalRatio);\r\n    let èƒœè€…å—ä¼¤: string;\r\n    let è´¥è€…å—ä¼¤: string;\r\n\r\n    if (damageLevel < 0.1) {\r\n        èƒœè€…å—ä¼¤ = 'é‡ä¼¤';\r\n        è´¥è€…å—ä¼¤ = 'æ¿’æ­»';\r\n    } else if (damageLevel < 0.3) {\r\n        èƒœè€…å—ä¼¤ = 'ä¸­ä¼¤';\r\n        è´¥è€…å—ä¼¤ = 'é‡ä¼¤';\r\n    } else if (damageLevel < 0.5) {\r\n        èƒœè€…å—ä¼¤ = 'è½»ä¼¤';\r\n        è´¥è€…å—ä¼¤ = 'é‡ä¼¤';\r\n    } else {\r\n        èƒœè€…å—ä¼¤ = 'æ— ä¼¤';\r\n        è´¥è€…å—ä¼¤ = 'ä¸­ä¼¤';\r\n    }\r\n\r\n    // ç”Ÿæˆæˆ˜åˆ©å“\r\n    const æˆ˜åˆ©å“: string[] = [];\r\n    if (isAttackerWin && defenderData.çµçŸ³ > 0) {\r\n        const è·å¾—çµçŸ³ = Math.floor(defenderData.çµçŸ³ * (0.3 + Math.random() * 0.4));\r\n        æˆ˜åˆ©å“.push(`çµçŸ³ x${è·å¾—çµçŸ³}`);\r\n    }\r\n\r\n    if (defenderData.æœ¬å‘½å…µå™¨ && defenderData.æœ¬å‘½å…µå™¨ !== 'æ— ' && Math.random() < 0.3) {\r\n        æˆ˜åˆ©å“.push(defenderData.æœ¬å‘½å…µå™¨);\r\n    }\r\n\r\n    return {\r\n        èƒœè€…,\r\n        è´¥è€…,\r\n        æˆ˜æ–—è¿‡ç¨‹,\r\n        ä¼¤å®³æƒ…å†µ: { èƒœè€…å—ä¼¤, è´¥è€…å—ä¼¤ },\r\n        æˆ˜åˆ©å“,\r\n    };\r\n}\r\n\r\n// æ ¼å¼åŒ–æˆ˜æ–—ç»“æœä¸ºæ¶ˆæ¯\r\nfunction formatBattleResult(result: BattleResult): string {\r\n    let message = '## ğŸ—¡ï¸ æˆ˜æ–—åˆ¤å®šç»“æœ\\n\\n';\r\n    message += '### æˆ˜æ–—è¿‡ç¨‹\\n';\r\n    result.æˆ˜æ–—è¿‡ç¨‹.forEach((desc, i) => {\r\n        message += `${i + 1}. ${desc}\\n`;\r\n    });\r\n    message += '\\n### æˆ˜æ–—ç»“æœ\\n';\r\n    message += `- **èƒœè€…**: ${result.èƒœè€…} (${result.ä¼¤å®³æƒ…å†µ.èƒœè€…å—ä¼¤})\\n`;\r\n    message += `- **è´¥è€…**: ${result.è´¥è€…} (${result.ä¼¤å®³æƒ…å†µ.è´¥è€…å—ä¼¤})\\n`;\r\n\r\n    if (result.æˆ˜åˆ©å“.length > 0) {\r\n        message += '\\n### æˆ˜åˆ©å“\\n';\r\n        result.æˆ˜åˆ©å“.forEach(item => {\r\n            message += `- ${item}\\n`;\r\n        });\r\n    }\r\n\r\n    return message;\r\n}\r\n\r\n// å¯¼å‡ºç»™å¤–éƒ¨ä½¿ç”¨çš„å‡½æ•°\r\n(window as any).TavernBattle = {\r\n    judgeBattle,\r\n    formatBattleResult,\r\n    calculatePower,\r\n};\r\n\r\n// é…ç½®ï¼šæ˜¯å¦å¯ç”¨è‡ªåŠ¨æ£€æµ‹\r\nlet autoDetectEnabled = true;\r\n\r\n// å¯¼å‡ºé…ç½®å‡½æ•°\r\n(window as any).TavernBattle.setAutoDetect = (enabled: boolean) => {\r\n    autoDetectEnabled = enabled;\r\n    console.info('[æˆ˜æ–—åˆ¤å®š] è‡ªåŠ¨æ£€æµ‹å·²', enabled ? 'å¯ç”¨' : 'ç¦ç”¨');\r\n    toastr.info(`æˆ˜æ–—è‡ªåŠ¨æ£€æµ‹å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'æˆ˜æ–—ç³»ç»Ÿ');\r\n};\r\n\r\n$(() => {\r\n    console.info('[æˆ˜æ–—åˆ¤å®š] è„šæœ¬å·²åŠ è½½');\r\n\r\n    toastr.info('æˆ˜æ–—åˆ¤å®šç³»ç»Ÿå·²å°±ç»ª\\nâ€¢ æ‰‹åŠ¨ï¼š/battle æ”»å‡»æ–¹|é˜²å¾¡æ–¹\\nâ€¢ è‡ªåŠ¨ï¼šAI æåŠæˆ˜æ–—æ—¶è‡ªåŠ¨è§¦å‘', 'æˆ˜æ–—ç³»ç»Ÿ');\r\n});\r\n\r\n// æ‰‹åŠ¨å‘½ä»¤ï¼š/battle æ”»å‡»æ–¹|é˜²å¾¡æ–¹\r\neventOn(tavern_events.MESSAGE_SENT, async (message_id: number | string) => {\r\n    const id = typeof message_id === 'string' ? parseInt(message_id) : message_id;\r\n    const messages = getChatMessages(id);\r\n    if (messages.length === 0) return;\r\n\r\n    const message = messages[0].message || '';\r\n\r\n    // æ£€æµ‹æˆ˜æ–—å‘½ä»¤æ ¼å¼: /battle æ”»å‡»æ–¹|é˜²å¾¡æ–¹\r\n    const battleMatch = message.match(/^\\/battle\\s+(.+?)\\|(.+?)$/);\r\n    if (!battleMatch) return;\r\n\r\n    const attackerName = battleMatch[1].trim();\r\n    const defenderName = battleMatch[2].trim();\r\n\r\n    try {\r\n        console.info('[æˆ˜æ–—åˆ¤å®š] æ£€æµ‹åˆ°æˆ˜æ–—å‘½ä»¤', { attackerName, defenderName });\r\n\r\n        // æ‰§è¡Œæˆ˜æ–—åˆ¤å®š\r\n        const result = await judgeBattle(\r\n            attackerName,\r\n            defenderName,\r\n            attackerName === '{{user}}' || attackerName.includes('user') || attackerName.includes('ä¸»è§’'),\r\n        );\r\n\r\n        // æ ¼å¼åŒ–ç»“æœ\r\n        const formattedResult = formatBattleResult(result);\r\n\r\n        // å…ˆåˆ é™¤å‘½ä»¤æ¶ˆæ¯\r\n        await deleteChatMessages([id]);\r\n\r\n        // åˆ›å»ºæˆ˜æ–—ç»“æœæ¶ˆæ¯\r\n        await createChatMessages([\r\n            {\r\n                name: 'æˆ˜æ–—ç³»ç»Ÿ',\r\n                role: 'system',\r\n                message: formattedResult,\r\n            },\r\n        ]);\r\n\r\n        toastr.success('æˆ˜æ–—åˆ¤å®šå®Œæˆï¼', 'æˆ˜æ–—ç³»ç»Ÿ');\r\n    } catch (e) {\r\n        console.error('[æˆ˜æ–—åˆ¤å®š] æ‰§è¡Œå¤±è´¥', e);\r\n        const errorMsg = e instanceof Error ? e.message : String(e);\r\n        toastr.error(`æˆ˜æ–—åˆ¤å®šå¤±è´¥: ${errorMsg}`, 'æˆ˜æ–—ç³»ç»Ÿ');\r\n    }\r\n});\r\n\r\n// è‡ªåŠ¨æ£€æµ‹ï¼šAI è¾“å‡ºä¸­æåˆ°æˆ˜æ–—\r\neventOn(tavern_events.MESSAGE_RECEIVED, async (message_id: number | string) => {\r\n    if (!autoDetectEnabled) return;\r\n\r\n    const id = typeof message_id === 'string' ? parseInt(message_id) : message_id;\r\n    const messages = getChatMessages(id);\r\n    if (messages.length === 0) return;\r\n\r\n    const message = messages[0].message || '';\r\n\r\n    // æ£€æµ‹æˆ˜æ–—è§¦å‘å…³é”®è¯ï¼šã€æˆ˜æ–—ï¼šè§’è‰²A vs è§’è‰²Bã€‘\r\n    const autoMatch = message.match(/ã€æˆ˜æ–—[ï¼š:]\\s*(.+?)\\s+vs\\s+(.+?)ã€‘/);\r\n    if (!autoMatch) return;\r\n\r\n    const attackerName = autoMatch[1].trim();\r\n    const defenderName = autoMatch[2].trim();\r\n\r\n    try {\r\n        console.info('[æˆ˜æ–—åˆ¤å®š] è‡ªåŠ¨æ£€æµ‹åˆ°æˆ˜æ–—', { attackerName, defenderName });\r\n\r\n        // æ‰§è¡Œæˆ˜æ–—åˆ¤å®š\r\n        const result = await judgeBattle(\r\n            attackerName,\r\n            defenderName,\r\n            attackerName === '{{user}}' || attackerName.includes('user') || attackerName.includes('ä¸»è§’'),\r\n        );\r\n\r\n        // æ ¼å¼åŒ–ç»“æœ\r\n        const formattedResult = formatBattleResult(result);\r\n\r\n        // åˆ›å»ºæˆ˜æ–—ç»“æœæ¶ˆæ¯\r\n        await createChatMessages([\r\n            {\r\n                name: 'æˆ˜æ–—ç³»ç»Ÿ',\r\n                role: 'system',\r\n                message: formattedResult,\r\n            },\r\n        ]);\r\n\r\n        toastr.success('è‡ªåŠ¨æˆ˜æ–—åˆ¤å®šå®Œæˆï¼', 'æˆ˜æ–—ç³»ç»Ÿ');\r\n    } catch (e) {\r\n        console.error('[æˆ˜æ–—åˆ¤å®š] è‡ªåŠ¨æ£€æµ‹æ‰§è¡Œå¤±è´¥', e);\r\n        const errorMsg = e instanceof Error ? e.message : String(e);\r\n        console.warn(`[æˆ˜æ–—åˆ¤å®š] ${errorMsg}`);\r\n    }\r\n});"],"names":["calculatePower","data","power","includes","Object","keys","length","Math","floor","async","judgeBattle","attackerName","defenderName","attackerIsUser","waitGlobalInitialized","message_id","getCurrentMessageId","variables","Mvu","getMvuData","type","stat_data","_","get","attackerData","defenderData","Error","attackerPower","defenderPower","console","info","finalRatio","random","isAttackerWin","attacker","defender","process","powerDiff","levelDiff","level","push","name","abs","generateBattleProcess","damageLevel","formatBattleResult","result","message","forEach","desc","i","item","window","TavernBattle","autoDetectEnabled","setAutoDetect","enabled","toastr","$","eventOn","tavern_events","MESSAGE_SENT","id","parseInt","messages","getChatMessages","battleMatch","match","trim","formattedResult","deleteChatMessages","createChatMessages","role","success","e","error","errorMsg","String","MESSAGE_RECEIVED","autoMatch","warn"],"ignoreList":[],"sourceRoot":""}